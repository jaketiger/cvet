<!-- templates/admin/shop/sitesettings/change_form.html -->
{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify %}

{# --- –°–¢–ò–õ–ò (–í–∞—à –¥–∏–∑–∞–π–Ω) --- #}
{% block extrastyle %}
{{ block.super }}
<style>
    /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã –∏ —Ç–µ–Ω–∏ */
    .change-form .module { background: transparent !important; border: none !important; box-shadow: none !important; margin-bottom: 30px !important; }
    .change-form .form-row { border-bottom: none !important; padding: 12px 0 !important; }

    /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
    .change-form fieldset h2, .change-form .module h2 {
        color: #000000 !important; text-transform: uppercase !important; margin: 20px 0 15px 0 !important;
        border: none !important; border-bottom: 3px solid #417690 !important; box-shadow: none !important; letter-spacing: 1px;
    }
    .change-form fieldset h2 a.collapse-toggle {
        color: #417690 !important; font-size: 12px !important; font-weight: normal !important; text-transform: none !important; margin-left: 15px; vertical-align: middle;
    }

    /* –ë—ç–∫–∞–ø –ø–∞–Ω–µ–ª—å */
    .backup-panel { background-color: #e8eaeb; border: 1px solid #ccc; margin-top: 60px; padding: 20px; border-radius: 6px; color: #333; }
    .backup-panel h2 { margin-top: 0 !important; padding: 0 !important; background: none !important; border: none !important; color: #333 !important; font-size: 16px !important; font-weight: bold !important; }
    .top-submit-row { margin-bottom: 20px; padding: 15px 0; text-align: right; border-bottom: 1px solid #ccc; }
    .backup-alert { font-size: 13px; color: #333; margin-bottom: 20px; line-height: 1.5; background: #fff; padding: 15px; border-left: 5px solid #c62828; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .warning-text { color: #c62828; font-weight: bold; }
    .backup-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .backup-btn { display: inline-flex; align-items: center; padding: 10px 20px; text-decoration: none; border-radius: 4px; color: white !important; font-weight: bold; font-size: 13px; border: none; transition: opacity 0.2s; }
    .backup-btn:hover { opacity: 0.9; }
    .btn-db { background-color: #455a64; }
    .btn-media { background-color: #455a64; }
    .btn-env { background-color: #607d8b; }

    /* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è */
    .backup-instructions { background-color: #fff; border: 1px solid #ccc; padding: 15px; border-radius: 4px; }
    .backup-instructions summary { cursor: pointer; font-weight: bold; color: #444; }
    .code-snippet { display: block; background: #2d2d2d; color: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; border-left: 4px solid #4caf50; }
</style>
{% endblock %}

{# --- –ö–ù–û–ü–ö–ò –í–í–ï–†–•–£ --- #}
{% block field_sets %}
    <div class="submit-row-top">{% submit_row %}</div>
    {{ block.super }}
{% endblock %}

{# --- –ü–ê–ù–ï–õ–¨ –í–ù–ò–ó–£ --- #}
{% block after_related_objects %}
    {{ block.super }}
    <div class="backup-panel">
        <h2>üì¶ –¶–µ–Ω—Ç—Ä –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</h2>
        <details style="margin-bottom: 15px;">
            <summary>‚ÑπÔ∏è –ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —ç—Ç–∏ —Ñ–∞–π–ª—ã?</summary>
            <div class="backup-alert" style="margin-top: 10px; border-left: 5px solid #546e7a;">
                <ul style="padding-left: 20px; margin: 0;">
                    <li><strong>–ë–î (.dump):</strong> –¢–µ–∫—Å—Ç—ã, —Ç–æ–≤–∞—Ä—ã, —Ü–µ–Ω—ã, –∑–∞–∫–∞–∑—ã. <span class="warning-text">–ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏!</span></li>
                    <li><strong>Media (.zip):</strong> –ü–ê–ü–ö–ê —Å–æ –≤—Å–µ–º–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –±–∞–Ω–Ω–µ—Ä—ã. <span class="warning-text">–°–∫–∞—á–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!</span></li>
                    <li><strong>.env:</strong> –ü–∞—Ä–æ–ª–∏. <span class="warning-text">–í–ê–ñ–ù–û:</span> –ü–µ—Ä–µ–∏–º–µ–Ω—É–π—Ç–µ –≤ <code>.env</code> –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏!</li>
                </ul>
            </div>
        </details>
        <div class="backup-buttons">
            <a href="{% url 'admin:site_backup_db' %}" class="backup-btn btn-db">1. –°–∫–∞—á–∞—Ç—å –ë–î (.dump)</a>
            <a href="{% url 'admin:site_backup_media' %}" class="backup-btn btn-media">2. –°–∫–∞—á–∞—Ç—å Media (.zip)</a>
            <a href="{% url 'admin:site_backup_env' %}" class="backup-btn btn-env">3. –°–∫–∞—á–∞—Ç—å .env</a>
            <a href="{% url 'admin:site_backup_config' %}" class="backup-btn btn-env">4. –°–∫–∞—á–∞—Ç—å Config (PM2)</a>
        </div>

        <details class="backup-instructions">
            <summary>üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è)</summary>
            <div>
                <p style="margin-top: 10px; font-size: 13px;">–ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ —á–∏—Å—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ:</p>
                <ol style="padding-left: 20px; font-size: 13px; line-height: 1.6;">
                    <li>
                        <strong>–ö–æ–¥ –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:</strong>
                        <div class="code-snippet">git clone https://github.com/username/repo.git /path/to/project
cd /path/to/project
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt</div>
                    </li>
                    <li>
                        <strong>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:</strong>
                        –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª <code>.env</code> –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞.
                    </li>
                    <li>
                        <strong>–ú–µ–¥–∏–∞-—Ñ–∞–π–ª—ã:</strong>
                        –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤ <strong>–ü–ê–ü–ö–£</strong> media –≤ <code>/path/to/project/media/</code>.
                    </li>
                    <li>
                        <strong>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:</strong>
                        <br>–°–æ–∑–¥–∞–π—Ç–µ –ø—É—Å—Ç—É—é –ë–î. –ù–µ –¥–µ–ª–∞–π—Ç–µ migrate. –í—ã–ø–æ–ª–Ω–∏—Ç–µ:
                        <div class="code-snippet">pg_restore --clean --no-acl --no-owner -U &lt;db_user&gt; -d &lt;db_name&gt; &lt;backup_file&gt;.dump</div>
                    </li>
                    <li>
                        <strong>–ó–∞–ø—É—Å–∫ –∏ –ø—Ä–∞–≤–∞:</strong>
                        <div class="code-snippet">python manage.py collectstatic --noinput
# –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ &lt;your_linux_user&gt; –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
sudo chown -R &lt;your_linux_user&gt;:&lt;your_linux_user&gt; /path/to/project
sudo find /path/to/project/media -type d -exec chmod 755 {} \;
sudo find /path/to/project/media -type f -exec chmod 644 {} \;
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2
pm2 restart ecosystem.config.js</div>
                    </li>
                </ol>
            </div>
        </details>
    </div>
{% endblock %}

{# --- –í–ê–ñ–ù–û: –°–ö–†–ò–ü–¢ –§–ò–ö–°–ê–¶–ò–ò –í–ö–õ–ê–î–û–ö --- #}
{% block admin_change_form_document_ready %}
    {{ block.super }}
    <script type="text/javascript">
        (function($) {
            // –ü—Ä–æ—Å—Ç–æ–π –∫–ª—é—á, –æ–¥–∏–Ω –¥–ª—è –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
            var STORAGE_KEY = 'megacvet_admin_tabs_v4';

            // 1. –§—É–Ω–∫—Ü–∏—è: –ø—Ä–æ—á–∏—Ç–∞—Ç—å, –∫–∞–∫–∏–µ –≤–∫–ª–∞–¥–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã, –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Ö –∏–Ω–¥–µ–∫—Å—ã
            function saveCurrentState() {
                var openIndices = [];
                // –ò—â–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã. –ï—Å–ª–∏ –ù–ï–¢ –∫–ª–∞—Å—Å–∞ collapsed -> –∑–Ω–∞—á–∏—Ç –æ—Ç–∫—Ä—ã—Ç–∞
                $('fieldset.collapse').each(function(index) {
                    if (!$(this).hasClass('collapsed')) {
                        openIndices.push(index);
                    }
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(openIndices));
            }

            // 2. –§—É–Ω–∫—Ü–∏—è: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ç–æ, —á—Ç–æ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
            function forceRestoreState() {
                var stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) return;

                var openIndices = JSON.parse(stored);

                $('fieldset.collapse').each(function(index) {
                    // –ï—Å–ª–∏ —ç—Ç–æ—Ç –±–ª–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç (–µ—Å—Ç—å –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º –º–∞—Å—Å–∏–≤–µ)
                    if (openIndices.includes(index)) {
                        var $fieldset = $(this);

                        // –ñ–ï–°–¢–ö–û–ï –£–î–ê–õ–ï–ù–ò–ï –ö–õ–ê–°–°–ê
                        if ($fieldset.hasClass('collapsed')) {
                            $fieldset.removeClass('collapsed');
                            // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ "–°–∫—Ä—ã—Ç—å", —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ –±—ã–ª–æ –≤–µ—Ä–Ω–æ
                            $fieldset.find('h2 a.collapse-toggle').text(gettext('Hide'));
                        }
                    }
                });
            }

            $(document).ready(function() {
                // --- –ë–õ–û–ö –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø ---
                // –ó–∞–ø—É—Å–∫–∞–µ–º "–¥–æ–ª–±–µ–∂–∫—É": –≤—ã–∑—ã–≤–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º–Ω–æ–≥–æ —Ä–∞–∑.
                // –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–±–∏—Ç—å —Å–∫—Ä–∏–ø—Ç Django, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ 100–º—Å, 200–º—Å –∏ —Ç.–¥.
                forceRestoreState(); // –°—Ä–∞–∑—É (0–º—Å)

                var attempts = 0;
                var intervalId = setInterval(function() {
                    forceRestoreState();
                    attempts++;
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É (10 –ø–æ–ø—ã—Ç–æ–∫ –ø–æ 100–º—Å)
                    if (attempts >= 10) clearInterval(intervalId);
                }, 100);


                // --- –ë–õ–û–ö –°–û–•–†–ê–ù–ï–ù–ò–Ø ---
                // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ª—é–±–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
                $(document).on('click', 'fieldset.collapse h2', function() {
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –∫–ª–∞—Å—Å —É—Å–ø–µ–ª –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è
                    setTimeout(saveCurrentState, 200);
                });

                // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
                $('form').on('submit', function() {
                    saveCurrentState();
                });
            });
        })(django.jQuery);
    </script>
{% endblock %}