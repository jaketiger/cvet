<!-- templates/base.html -->
{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
     {% if site_settings.mobile_force_desktop_view %}
        <meta name="viewport" content="width=1200">
    {% else %}
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% endif %}
    <title>{% block title %}{{ site_settings.shop_name|default:'MegaCvet' }}{% endblock %}</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Lora:wght@400;700&family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;700&family=Lobster&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <link rel="stylesheet" href="{% static 'shop/css/main.css' %}">

    <style>
        :root {
            --font-roboto: 'Roboto', sans-serif;
            --font-montserrat: 'Montserrat', sans-serif;
            --font-open-sans: 'Open Sans', sans-serif;
            --font-lora: 'Lora', serif;
            --font-merriweather: 'Merriweather', serif;
            --font-playfair-display: 'Playfair Display', serif;
            --font-lobster: 'Lobster', cursive;
            --font-pacifico: 'Pacifico', cursive;
            --body-font-family: var(--font-{{ site_settings.body_font_family|default:'roboto' }});
            --heading-font-family: var(--font-{{ site_settings.heading_font_family|default:'montserrat' }});
            --base-font-size: {{ site_settings.base_font_size|default:16 }}px;
            --main-text-color: {{ site_settings.main_text_color|default:'#333333' }};
            --accent-color: {{ site_settings.accent_color|default:'#e53935' }};
            --category-nav-hover-color: {{ site_settings.category_nav_hover_color|default:'var(--accent-color)' }};
            --button-bg-color: {{ site_settings.button_bg_color|default:'var(--accent-color)' }};
            --button-text-color: {{ site_settings.button_text_color|default:'#FFFFFF' }};
            --button-hover-bg-color: {{ site_settings.button_hover_bg_color|default:'#333333' }};
            --button-border-radius: {{ site_settings.button_border_radius|default:5 }}px;
            --button-font-family: var(--font-{{ site_settings.button_font_family|default:site_settings.body_font_family|default:'roboto' }});
            --add-to-cart-bg-color: {{ site_settings.add_to_cart_bg_color|default:'var(--button-bg-color)' }};
            --add-to-cart-text-color: {{ site_settings.add_to_cart_text_color|default:'var(--button-text-color)' }};
            --add-to-cart-hover-bg-color: {{ site_settings.add_to_cart_hover_bg_color|default:'var(--button-hover-bg-color)' }};
            --mobile-dropdown-bg: rgba({{ site_settings.mobile_dropdown_bg_rgb }}, {{ site_settings.mobile_dropdown_opacity_css }});
            --header-icon-size: {{ site_settings.header_icon_size|default:22 }}px;
            --mobile-icon-size: {{ site_settings.mobile_icon_size|default:24 }}px;
        }
        body {
            {% if site_settings.background_image %}
                background-image: url('{{ site_settings.background_image.url }}');
            {% endif %}
        }
    </style>
</head>
<body class="nav-style-{{ site_settings.navigation_style }} mobile-header-{{ site_settings.mobile_header_style }} mobile-grid-col-{{ site_settings.mobile_product_grid }}">

<div class="container">
    <header class="header">
        <div class="logo">
            <a href="{% url 'shop:home' %}" style="font-size: {{ site_settings.logo_font_size|default:24 }}px; color: {{ site_settings.logo_color|default:'var(--main-text-color)' }}; font-family: var(--font-{{ site_settings.logo_font_family|default:site_settings.heading_font_family|default:'montserrat' }});">
                <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="На главную"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span class="logo-text">{{ site_settings.shop_name }}</span>
            </a>
        </div>

        <form class="search-form-desktop" action="{% url 'shop:search_results' %}" method="get">
            <input type="text" name="q" placeholder="Поиск по товарам...">
            <button type="submit" class="btn-primary">Найти</button>
        </form>

        <div class="mobile-nav-container">
            <nav class="user-navigation">
                <div class="search-mobile-toggle">
                     <a href="#" class="user-nav-link" id="search-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </a>
                </div>
                {% if user.is_authenticated %}
                    <a href="{% url 'shop:cabinet' %}" class="user-nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span class="user-nav-text full-text">Кабинет ({{ user.first_name|default:user.username }})</span>
                        <span class="user-nav-text partial-text">Кабинет</span>
                    </a>
                    <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: inline;">
                        {% csrf_token %}
                        <a href="#" onclick="document.getElementById('logout-form').submit(); return false;" class="user-nav-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                            <span class="user-nav-text full-text partial-text">Выйти</span>
                        </a>
                    </form>
                {% else %}
                    <a href="{% url 'login' %}" class="user-nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
                        <span class="user-nav-text full-text partial-text">Войти</span>
                    </a>
                    <a href="{% url 'users:register' %}" class="user-nav-link">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
                        <span class="user-nav-text full-text partial-text">Регистрация</span>
                    </a>
                {% endif %}
                <div class="cart">
                    <a href="{% url 'cart:cart_detail' %}" class="user-nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                        {% if cart %}
                            <span class="user-nav-text full-text">{{ cart|length }} на {{ cart.get_total_price }} руб.</span>
                            <span class="user-nav-text partial-text">Корзина</span>
                        {% else %}
                            <span class="user-nav-text full-text partial-text">Корзина</span>
                        {% endif %}
                    </a>
                </div>
                <div class="category-nav-mobile-toggle">
                     <a href="#" class="user-nav-link" id="category-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"></path></svg>
                        <span class="user-nav-text partial-text">Категории</span>
                    </a>
                </div>
            </nav>
            <div class="mobile-dropdown-panel" id="mobile-panel">
                <div class="search-form-mobile-wrapper" id="search-wrapper">
                    <form class="search-form-mobile" action="{% url 'shop:search_results' %}" method="get">
                        <input type="text" name="q" placeholder="Поиск по товарам...">
                        <button type="submit" class="btn-primary">Найти</button>
                    </form>
                </div>
                <div class="category-nav-mobile-wrapper" id="category-wrapper">
                    <div class="category-nav-mobile">
                        <a href="{% url 'shop:product_list_all' %}" class="category-link-item">Все товары</a>
                        {% for c in categories %}
                            <a href="{{ c.get_absolute_url }}" class="category-link-item">{{ c.name }}</a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </header>

    <nav class="category-nav-desktop">
        <a href="{% url 'shop:product_list_all' %}" class="category-link-item">Все товары</a>
        {% for c in categories %}
            <a href="{{ c.get_absolute_url }}" class="category-link-item">{{ c.name }}</a>
        {% endfor %}
    </nav>

    <main>
        {% block content %}
        {% endblock %}
    </main>

    <footer class="footer">
        <div class="footer-links" {% if footer_pages|length|add:1 > site_settings.collapse_footer_threshold %}data-collapse="true"{% endif %}>
            {% for page in footer_pages %}
                <a href="{{ page.get_absolute_url }}" class="footer-link-item">{{ page.title }}</a>
            {% endfor %}
            <a href="{% url 'shop:contacts' %}" class="footer-link-item">Контакты</a>
        </div>
        <p>&copy; {% now "Y" %} {{ site_settings.shop_name }}. Все права защищены.</p>
    </footer>

</div>

<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoryToggle = document.getElementById('category-toggle');
    const categoryWrapper = document.getElementById('category-wrapper');
    const searchToggle = document.getElementById('search-toggle');
    const searchWrapper = document.getElementById('search-wrapper');
    const mobilePanel = document.getElementById('mobile-panel');

    function togglePanel(wrapperToShow) {
        const isAlreadyOpen = wrapperToShow.classList.contains('is-visible');

        categoryWrapper.classList.remove('is-visible');
        searchWrapper.classList.remove('is-visible');

        if (isAlreadyOpen) {
            mobilePanel.classList.remove('is-open');
        } else {
            wrapperToShow.classList.add('is-visible');
            mobilePanel.classList.add('is-open');
        }
    }

    if(categoryToggle) {
        categoryToggle.addEventListener('click', function(e) {
            e.preventDefault();
            togglePanel(categoryWrapper);
        });
    }

    if(searchToggle) {
        searchToggle.addEventListener('click', function(e) {
            e.preventDefault();
            togglePanel(searchWrapper);
            if (searchWrapper.classList.contains('is-visible')) {
                searchWrapper.querySelector('input[name="q"]').focus();
            }
        });
    }
});
</script>
{% block extra_scripts %}{% endblock %}
</body>
</html>