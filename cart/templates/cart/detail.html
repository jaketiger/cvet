<!-- cart/templates/cart/detail.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}Ваша корзина{% endblock %}

{% block content %}
<div class="cart-container">
    <h1>Ваша корзина</h1>

    {% if cart %}
    <div class="cart-wrapper">
        <table class="cart-table">
            <thead>
                <tr>
                    <th class="product-col">Товар</th>
                    <th>Количество</th>
                    <th>Цена за шт.</th>
                    <th>Общая стоимость</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart %}
                    {% with product=item.product %}
                    <tr class="cart-item {% if item.is_stock_sufficient == False %}stock-error-row{% endif %}">

                        <!-- ТОВАР -->
                        <td data-label="Товар:" class="product-col">
                            <div class="product-info-cell">
                                <a href="{{ product.get_absolute_url }}" class="product-image-link">
                                    <img src="{% if product.image_thumbnail %}{{ product.image_thumbnail.url }}{% else %}{% static 'shop/img/no_image.png' %}{% endif %}" alt="{{ product.name }}">
                                </a>
                                <div>
                                    <a href="{{ product.get_absolute_url }}" class="product-name">{{ product.name }}</a>
                                    {% if item.variant_name %}
                                        <small class="variant-name">({{ item.variant_name }})</small>
                                    {% endif %}
                                    {% if item.is_stock_sufficient == False %}
                                        <div class="stock-error-msg">Мало на складе! Доступно: {{ product.stock }} шт.</div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>

                        <!-- КОЛИЧЕСТВО -->
                        <td data-label="Количество:">
                            <!-- Форма обновления количества -->
                            <form action="{% url 'cart:cart_add' product.id %}" method="post" class="quantity-form">
                                {% csrf_token %}
                                <input type="hidden" name="variant_id" value="{{ item.variant_id|default_if_none:'' }}">
                                {{ item.update_quantity_form.update }}

                                <!-- СЕЛЕКТОР С КНОПКАМИ (Глобальные стили из main.css) -->
                                <div class="quantity-selector">
                                    <!-- Кнопка МИНУС -->
                                    <button type="button" class="qty-btn minus" onclick="updateCartQty(this, -1)">−</button>

                                    <!-- Поле ввода (Django form field) -->
                                    {{ item.update_quantity_form.quantity }}

                                    <!-- Кнопка ПЛЮС -->
                                    <button type="button" class="qty-btn plus" onclick="updateCartQty(this, 1)">+</button>
                                </div>
                            </form>
                        </td>

                        <td data-label="Цена за шт.:">{{ item.price }} ₽</td>
                        <td data-label="Общая стоимость:">{{ item.total_price }} ₽</td>

                        <td class="remove-col" data-label="">
                           <form action="{% url 'cart:cart_remove' product.id %}" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="variant_id" value="{{ item.variant_id|default_if_none:'' }}">
                                <button type="submit" class="remove-btn">
                                    <span class="desktop-text">✕</span>
                                    <span class="mobile-icon">✕ Удалить</span>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="cart-summary">
        <h2>Итого: {{ cart.get_total_price }} ₽</h2>
        <div class="cart-actions">
            <a href="{% url 'shop:product_list_all' %}" class="btn btn-secondary">Продолжить покупки</a>
            {% if is_checkout_possible %}
                <a href="{% url 'orders:order_create' %}" class="btn">Оформить заказ</a>
            {% else %}
                <div style="text-align: right;">
                    <span class="btn btn-secondary" style="cursor: not-allowed; opacity: 0.7;">Оформить заказ</span>
                    <p style="color: #dc3545; font-size: 0.9em; margin-top: 5px;">Некоторые товары недоступны.</p>
                </div>
            {% endif %}
        </div>
    </div>

    {% else %}
    <div class="cart-empty">
        <h3>Ваша корзина пуста</h3>
        <p>Самое время добавить в нее что-нибудь прекрасное!</p>
        <a href="{% url 'shop:product_list_all' %}" class="btn">Перейти в каталог</a>
    </div>
    {% endif %}
</div>

<style>
    /* Локальные стили только для корзины */
    .quantity-form {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .stock-error-msg { color: #dc3545; font-weight: bold; font-size: 0.85em; margin-top: 5px; background: #ffe6e6; padding: 2px 6px; border-radius: 4px; display: inline-block; }
    .stock-error-row { background-color: #fff5f5; }
    .remove-btn { background: transparent; color: #999; border: 1px solid #ddd; border-radius: 50%; width: 30px; height: 30px; padding: 0; font-size: 14px; cursor: pointer; }
    .remove-btn:hover { background: #dc3545; color: white; border-color: #dc3545; }

    /* Мобильная адаптация выравнивания */
    @media (max-width: 768px) {
        .quantity-form { justify-content: flex-start; }
    }
</style>

<script>
    // Функция обновления количества в корзине
    // При нажатии +/- сразу отправляет форму на сервер
    function updateCartQty(btn, change) {
        const wrapper = btn.closest('.quantity-selector');
        const input = wrapper.querySelector('input');
        const form = btn.closest('form');

        let val = parseInt(input.value) || 1;
        val += change;

        if (val < 1) val = 1; // Не даем уйти в минус
        // if (val > 999) val = 999; // Можно ограничить макс

        input.value = val;

        // ВАЖНО: Отправляем форму, чтобы обновилась корзина и цены
        form.submit();
    }
</script>
{% endblock %}