<!-- shop/templates/shop/product_detail.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} - {{ site_settings.shop_name }}{% endblock %}

{% block content %}
<div class="product-detail-page">
    <div class="product-detail-grid">

        <!-- === –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –§–û–¢–û–ì–†–ê–§–ò–ò === -->
        <div class="product-gallery-wrapper">

            <!-- –ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ -->
            <div class="main-image-container" id="main-image-zoom-container">
                <button class="fav-btn {% if product.id in favorites.favorites %}active{% endif %}"
                        data-id="{{ product.id }}"
                        onclick="toggleFavorite(this, event)"
                        title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                    <svg viewBox="0 0 24 24">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                </button>

                {% if product.image %}
                    <img id="main-product-image"
                         src="{{ product.image.url }}"
                         alt="{{ product.name }}"
                         data-zoom-target="{{ product.image.url }}"
                         onerror="this.style.display='none'; this.parentElement.insertAdjacentHTML('beforeend', '<div class=\'no-photo-placeholder\'>–§–æ—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>')">
                {% else %}
                    <div class="no-photo-placeholder">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
                {% endif %}
            </div>

            <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã -->
            {% with all_images=product.images.all %}
                {% if product.image or all_images %}
                <div class="thumbnails-row">
                    {% if product.image %}
                        <div class="thumb-wrapper active" onclick="changeMainImage(this)" data-full-src="{{ product.image.url }}">
                            <img src="{{ product.image.url }}" alt="Main Preview">
                        </div>
                    {% endif %}
                    {% for img in all_images %}
                        {% if img.image %}
                            <div class="thumb-wrapper" onclick="changeMainImage(this)" data-full-src="{{ img.image.url }}">
                                <img src="{{ img.image.url }}" alt="Gallery Preview">
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            {% endwith %}

            <!-- –ò–∫–æ–Ω–∫–∏ -->
            {% if benefits %}
            <div class="benefits-under-photo">
                {% for benefit in benefits %}
                    <div class="benefit-item-minimal" title="{{ benefit.description }}">
                        <div class="benefit-icon">{{ benefit.icon_svg|safe }}</div>
                        <span class="benefit-text">{{ benefit.title }}</span>
                    </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- === –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ò–ù–§–û–†–ú–ê–¶–ò–Ø === -->
        <div class="product-info-sticky">

            <div class="product-header">
                <h1 class="product-title-modern">{{ product.name }}</h1>
                <div class="product-meta">
                    {% if product.stock > 0 and product.available %}
                        <div class="status-indicator">
                            <span class="status-dot in-stock"></span> –í –Ω–∞–ª–∏—á–∏–∏
                        </div>
                    {% else %}
                        <div class="status-indicator">
                            <span class="status-dot out-of-stock"></span> –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
                        </div>
                    {% endif %}

                    <span class="sku">–ê—Ä—Ç: {{ product.sku|default:"-" }}</span>
                </div>
            </div>

            <!-- –¶–ï–ù–ê –° –õ–û–ì–ò–ö–û–ô –°–ö–ò–î–ö–ò –ò –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–ï–ô –¶–í–ï–¢–û–í -->
            <div class="price-modern">
                <!-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ –∏ –æ–Ω–∞ –±–æ–ª—å—à–µ –Ω–æ–≤–æ–π -->
                {% if product.old_price and product.old_price > product.price %}
                    {% with discount_percent=product.get_discount_percent %}
                    {% with sticker_color=product.get_discount_sticker_color %}
                    {% with new_price_color=product.get_new_price_color %}

                    <!-- –°—Ç–∞—Ä–∞—è –∑–∞—á–µ—Ä–∫–Ω—É—Ç–∞—è —Ü–µ–Ω–∞ -->
                    <span class="detail-old-price">{{ product.old_price|floatformat:0 }} ‚ÇΩ</span>

                    <!-- –ù–æ–≤–∞—è —Ü–µ–Ω–∞ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º —Ü–≤–µ—Ç–æ–º -->
                    <span class="detail-new-price" style="color: {{ new_price_color }} !important;">
                        {{ product.price|floatformat:0 }} ‚ÇΩ
                    </span>

                    <!-- –°—Ç–∏–∫–µ—Ä —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–º —Ü–≤–µ—Ç–æ–º -->
                    <span class="detail-sale-tag" style="background-color: {{ sticker_color }} !important; color: white;">
                        {% if discount_percent %}
                            -{{ discount_percent }}%
                        {% else %}
                            SALE
                        {% endif %}
                    </span>

                    {% endwith %}
                    {% endwith %}
                    {% endwith %}
                {% else %}
                    <!-- –ï—Å–ª–∏ —Å–∫–∏–¥–∫–∏ –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ —Ü–µ–Ω–∞ -->
                    <span class="detail-regular-price">{{ product.price|floatformat:0 }} ‚ÇΩ</span>
                {% endif %}
            </div>

            <!-- –ë–õ–û–ö –ü–û–ö–£–ü–ö–ò -->
            <div class="purchase-area">
                {% if product.stock > 0 and product.available %}
                    <form class="add-to-cart-form-modern" action="{% url 'cart:cart_add' product.id %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="update" value="False">

                        <!-- –ö–û–õ–ò–ß–ï–°–¢–í–û -->
                        <div class="qty-capsule">
                            <button type="button" class="qty-btn" onclick="updateQty(-1)">‚àí</button>
                            <input type="number" name="quantity" value="1" min="1" max="{{ product.stock }}" readonly>
                            <button type="button" class="qty-btn" onclick="updateQty(1)">+</button>
                        </div>

                        <div class="buttons-row" style="flex: 1; display: flex; gap: 10px;">
                            <!-- –ö–ù–û–ü–ö–ê –í –ö–û–†–ó–ò–ù–£ -->
                            <button type="submit" class="btn btn-primary custom-cart-btn">
                                –í –∫–æ—Ä–∑–∏–Ω—É
                            </button>

                            <!-- –ö–ù–û–ü–ö–ê 1 –ö–õ–ò–ö -->
                            <button type="button" class="btn btn-outline-primary btn-one-click" onclick="openOneClickModal()">
                                –ö—É–ø–∏—Ç—å –≤ 1 –∫–ª–∏–∫
                            </button>
                        </div>
                    </form>
                {% else %}
                    <button class="btn btn-secondary custom-cart-btn disabled" disabled>–¢–æ–≤–∞—Ä —Ä–∞—Å–∫—É–ø–ª–µ–Ω</button>
                {% endif %}
            </div>

            <hr class="divider">

            <div class="accordion-clean">
                {% if product.composition %}
                <details>
                    <summary>
                        {{ product.composition_title|default:site_settings.default_composition_title }}
                        <span class="plus-icon">+</span>
                    </summary>
                    <div class="details-content">
                        {{ product.composition|linebreaksbr }}
                    </div>
                </details>
                {% endif %}

                {% if product.description %}
                <details>
                    <summary>
                        {{ product.description_title|default:site_settings.default_description_title }}
                        <span class="plus-icon">+</span>
                    </summary>
                    <div class="details-content">
                        {{ product.description|linebreaksbr }}
                    </div>
                </details>
                {% endif %}
            </div>

            <a href="{% url 'shop:product_list_all' %}" class="back-link-modern">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥
            </a>
        </div>
    </div>
</div>

<!-- === –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û 1 –ö–õ–ò–ö (–ù–û–í–´–ô –î–ò–ó–ê–ô–ù) === -->
<div id="oneClickModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content-modern">
        <span class="close-modal" onclick="closeOneClickModal()">&times;</span>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Ñ–æ–Ω–æ–º -->
        <div class="modal-header-visual">
            <h3>‚ö° –ë—ã—Å—Ç—Ä—ã–π –∑–∞–∫–∞–∑</h3>
            <p>–û—Å—Ç–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä, –∏ –º—ã –ø–µ—Ä–µ–∑–≤–æ–Ω–∏–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>
        </div>

        <div class="modal-body">
            <form id="oneClickForm" onsubmit="submitOneClick(event)">
                {% csrf_token %}

                <!-- –ü–æ–ª–µ –ò–º—è —Å –∏–∫–æ–Ω–∫–æ–π -->
                <div class="input-group-modern">
                    <span class="input-icon">üë§</span>
                    <input type="text" name="first_name" placeholder="–í–∞—à–µ –∏–º—è" class="form-input-modern">
                </div>

                <!-- –ü–æ–ª–µ –¢–µ–ª–µ—Ñ–æ–Ω —Å –∏–∫–æ–Ω–∫–æ–π -->
                <div class="input-group-modern">
                    <span class="input-icon">üìû</span>
                    <input type="text" name="phone" placeholder="+7 (___) ___-__-__" class="form-input-modern" required id="oneClickPhone">
                </div>

                <button type="submit" class="btn-submit-modern">
                    –ñ–¥—É –∑–≤–æ–Ω–∫–∞
                </button>

                <p class="privacy-hint">–ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã –¥–∞–µ—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö.</p>
            </form>

            <!-- –ë–ª–æ–∫ –£—Å–ø–µ—Ö–∞ -->
            <div id="oneClickSuccess" style="display: none; text-align: center; padding: 20px 0;">
                <div class="success-checkmark">
                    <div class="check-icon">
                        <span class="icon-line line-tip"></span>
                        <span class="icon-line line-long"></span>
                        <div class="icon-circle"></div>
                        <div class="icon-fix"></div>
                    </div>
                </div>
                <h3 style="margin-bottom: 10px; color: #333;">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!</h3>
                <p style="color: #666;">–°–ø–∞—Å–∏–±–æ! –ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç.</p>
                <button class="btn-submit-modern" onclick="closeOneClickModal()" style="margin-top: 15px;">–û—Ç–ª–∏—á–Ω–æ</button>
            </div>
        </div>
    </div>
</div>


<!-- ================== –°–¢–ò–õ–ò CSS ================== -->
<style>

    .detail-old-price {
        text-decoration: line-through; /* –ó–∞—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ */
        color: #999;                   /* –°–µ—Ä—ã–π —Ü–≤–µ—Ç */
        font-size: 1.5rem;
        margin-right: 10px;
        font-weight: normal;
    }
    .detail-new-price {
        color: #e53935;                /* –ö—Ä–∞—Å–Ω—ã–π (–∞–∫—Ü–µ–Ω—Ç–Ω—ã–π) —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        font-weight: 700;
        font-size: 2.4rem;
    }
    .detail-sale-tag {
        background: #e85454;           /* –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        color: white;
        font-size: 0.9rem;
        padding: 4px 10px;
        border-radius: 20px;
        vertical-align: middle;
        margin-left: 10px;
        font-weight: bold;
    }
    .detail-regular-price {
        font-size: 2.4rem;
        font-weight: 600;
        color: #111;
    }

    /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (FIXED) --- */
    .modal-backdrop {
        position: fixed !important; /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º */
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(4px);
        z-index: 99999; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ —Å–∞–π—Ç–∞ */
        display: flex;
        justify-content: center;
        align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –æ–∫–Ω–æ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
        overflow-y: auto; /* –ù–∞ —Å–ª—É—á–∞–π –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    }

    .modal-content-modern {
        background: #fff;
        border-radius: 20px;
        width: 90%;
        max-width: 380px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        margin: auto; /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∞ */
    }

    @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .close-modal {
        position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer;
        color: #fff; z-index: 2; opacity: 0.8; transition: 0.2s;
    }
    .close-modal:hover { opacity: 1; transform: rotate(90deg); }

    /* –®–∞–ø–∫–∞ –º–æ–¥–∞–ª–∫–∏ */
    .modal-header-visual {
        background: linear-gradient(135deg, var(--accent-color, #e53935), #ff7e7e);
        padding: 30px 20px 20px; text-align: center; color: #fff;
    }
    .modal-header-visual h3 { margin: 0 0 5px; font-size: 1.5rem; }
    .modal-header-visual p { margin: 0; font-size: 0.9rem; opacity: 0.9; }

    .modal-body { padding: 25px; }

    /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
    .input-group-modern { position: relative; margin-bottom: 15px; }
    .input-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; opacity: 0.5; }
    .form-input-modern {
        width: 100%; padding: 12px 15px 12px 45px;
        border: 1px solid #eee; border-radius: 12px; background: #f9f9f9;
        font-size: 1rem; transition: 0.2s; box-sizing: border-box;
    }
    .form-input-modern:focus {
        background: #fff; border-color: var(--accent-color, #e53935);
        outline: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ */
    .btn-submit-modern {
        width: 100%; padding: 14px; border: none; border-radius: 12px;
        background: var(--button-bg-color, #333); color: var(--button-text-color, #fff);
        font-size: 1.1rem; font-weight: 600; cursor: pointer;
        transition: 0.2s; margin-top: 10px;
    }
    .btn-submit-modern:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
    .privacy-hint { text-align: center; font-size: 0.75rem; color: #999; margin-top: 15px; }

    /* –ì–∞–ª–æ—á–∫–∞ */
    .success-checkmark { width: 80px; height: 80px; margin: 0 auto 20px; position: relative; }
    .check-icon { width: 80px; height: 80px; position: relative; border-radius: 50%; box-sizing: content-box; border: 4px solid #4CAF50; }
    .check-icon::before { top: 3px; left: -2px; width: 30px; transform-origin: 100% 50%; border-radius: 100px 0 0 100px; }
    .check-icon::after { top: 0; left: 30px; width: 60px; transform-origin: 0 50%; border-radius: 0 100px 100px 0; animation: rotate-circle 4.25s ease-in; }
    .icon-line { height: 5px; background-color: #4CAF50; display: block; border-radius: 2px; position: absolute; z-index: 10; }
    .icon-line.line-tip { top: 46px; left: 14px; width: 25px; transform: rotate(45deg); animation: icon-line-tip 0.75s; }
    .icon-line.line-long { top: 38px; right: 8px; width: 47px; transform: rotate(-45deg); animation: icon-line-long 0.75s; }
    @keyframes icon-line-tip { 0% { width: 0; left: 1px; top: 19px; } 54% { width: 0; left: 1px; top: 19px; } 70% { width: 50px; left: -8px; top: 37px; } 84% { width: 17px; left: 21px; top: 48px; } 100% { width: 25px; left: 14px; top: 46px; } }
    @keyframes icon-line-long { 0% { width: 0; right: 46px; top: 54px; } 65% { width: 0; right: 46px; top: 54px; } 84% { width: 55px; right: 0px; top: 35px; } 100% { width: 47px; right: 8px; top: 38px; } }


    /* --- –û–°–ù–û–í–ù–û–ô CSS –°–¢–†–ê–ù–ò–¶–´ --- */
    .btn-one-click {
        white-space: nowrap; border-radius: 100px; font-weight: 600;
        display: flex; align-items: center; justify-content: center;
        border: 2px solid var(--button-bg-color, #e53935);
        color: var(--button-bg-color, #e53935);
        background: transparent; padding: 0 20px; height: 56px;
        cursor: pointer; transition: all 0.2s;
    }
    .btn-one-click:hover { background: var(--button-bg-color, #e53935); color: var(--button-text-color, #fff); }

    .product-detail-page { max-width: 1300px; margin: 0 auto; padding: 50px 20px; font-family: var(--default-font-family, sans-serif); }
    .product-detail-grid { display: grid; grid-template-columns: 1.4fr 1fr; gap: 70px; align-items: start; }
    .product-gallery-wrapper { display: flex; flex-direction: column; gap: 20px; }
    .main-image-container { position: relative; width: 100%; border-radius: 20px; overflow: hidden; background-color: #f8f8f8; cursor: zoom-in; }
    #main-product-image { width: 100%; height: auto; display: block; transition: transform 0.3s ease-out; transform-origin: center center; }
    .main-image-container:hover #main-product-image { transform: scale(1.5); cursor: zoom-out; }
    .fav-btn { position: absolute; top: 20px; right: 20px; width: 44px; height: 44px; background: rgba(255, 255, 255, 0.95); border: none; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.08); cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; transition: transform 0.2s, background 0.2s; }
    .fav-btn:hover { transform: scale(1.1); background: #fff; }
    .fav-btn svg { width: 22px; height: 22px; stroke: #333; fill: none; stroke-width: 2; transition: all 0.2s; }
    .fav-btn.active svg { fill: #e53935; stroke: #e53935; }
    .thumbnails-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 12px; }
    .thumb-wrapper { aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; cursor: pointer; opacity: 0.6; transition: all 0.2s; border: 2px solid transparent; background-color: #f4f4f4; }
    .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; }
    .thumb-wrapper:hover, .thumb-wrapper.active { opacity: 1; border-color: #333; }
    .benefits-under-photo { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 10px; padding-top: 20px; border-top: 1px solid #f0f0f0; }
    .benefit-item-minimal { display: flex; align-items: center; gap: 8px; color: #666; font-size: 0.9rem; }
    .benefit-icon svg { width: 20px; height: 20px; color: #333; }
    .no-photo-placeholder { width: 100%; padding-top: 100%; background: #eee; position: relative; border-radius: 20px; }
    .no-photo-placeholder::after { content: "–ù–µ—Ç —Ñ–æ—Ç–æ"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #aaa; font-weight: 500; }
    .product-info-sticky { position: sticky; top: 40px; }
    .product-header { margin-bottom: 15px; }
    .product-title-modern { font-size: 2.6rem; font-weight: 700; line-height: 1.1; margin: 0 0 10px 0; color: #111; letter-spacing: -0.02em; }
    .product-meta { display: flex; align-items: center; gap: 15px; color: #777; font-size: 0.9rem; }
    .status-indicator { display: flex; align-items: center; gap: 6px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .status-dot.in-stock { background: #2ecc71; }
    .status-dot.out-of-stock { background: #e74c3c; }
    .sku { color: #999; font-family: monospace; font-size: 1rem; }
    .price-modern { font-size: 2.4rem; font-weight: 600; color: #111; margin-bottom: 30px; }
    .purchase-area { margin-bottom: 30px; }
    .add-to-cart-form-modern { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }

    /* === –ü–û–õ–ï –ö–û–õ–ò–ß–ï–°–¢–í–ê (–ë–ï–ó –§–û–ù–ê –ò –†–ê–ú–û–ö) === */
    .qty-capsule { display: flex; align-items: center; justify-content: space-between; background: transparent !important; border: none !important; box-shadow: none !important; padding: 0; width: 120px; height: 56px; }

    .qty-btn {
    background: transparent !important;
    color: #333 !important;
    /* ... */
}

    .qty-btn:hover { color: #000; transform: scale(1.1); }
    .qty-btn:active { transform: scale(0.9); }
    .qty-capsule input { width: 40px; text-align: center; border: none !important; box-shadow: none !important; background: transparent !important; font-size: 1.3rem; font-weight: 600; color: #333; padding: 0; margin: 0; outline: none; }
    .qty-capsule input::-webkit-outer-spin-button, .qty-capsule input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    .custom-cart-btn { flex-grow: 1; height: 56px; border-radius: 100px; font-size: 1.05rem; font-weight: 600; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
    .custom-cart-btn.disabled { background: #ccc !important; box-shadow: none; cursor: not-allowed; }
    .divider { border: 0; border-top: 1px solid #f0f0f0; margin: 30px 0; }
    .accordion-clean details { border-bottom: 1px solid #f0f0f0; }
    .accordion-clean summary { list-style: none; cursor: pointer; padding: 18px 0; font-weight: 500; font-size: 1.05rem; color: #333; display: flex; justify-content: space-between; align-items: center; transition: color 0.2s; }
    .accordion-clean summary:hover { color: #000; }
    .accordion-clean summary::-webkit-details-marker { display: none; }
    .accordion-clean .plus-icon { font-size: 1.4rem; font-weight: 300; color: #999; transition: transform 0.3s; }
    .accordion-clean details[open] .plus-icon { transform: rotate(45deg); }
    .details-content { padding-bottom: 20px; color: #666; line-height: 1.6; font-size: 0.95rem; }
    .back-link-modern { display: inline-flex; align-items: center; gap: 8px; margin-top: 20px; color: #888; text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: color 0.2s; }
    .back-link-modern:hover { color: #111; }

    @media (max-width: 992px) {
        .product-detail-page { padding: 20px 20px 100px 20px; }
        .product-detail-grid { grid-template-columns: 1fr; gap: 40px; }
        .product-info-sticky { position: static; }
        .product-title-modern { font-size: 2rem; }
        .purchase-area { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 15px 20px; z-index: 100; border-top: 1px solid #eee; margin: 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); display: flex; justify-content: space-between; gap: 10px; }
        .qty-capsule { width: 90px; height: 50px; }
        .qty-btn { font-size: 1.2rem; width: 30px; }
        .custom-cart-btn { flex: 1; min-width: auto; height: 50px; font-size: 0.9rem; padding: 0 10px; }
        .btn-one-click { flex: 1; height: 50px; font-size: 0.9rem; padding: 0 10px; }
    }
</style>

<script>
    // 1. –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –º–æ–¥–∞–ª–∫–∏ (–í–ù–ï –î–û–ú–õ–û–ê–î)
    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –Ω–µ–π –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
    function moveModalToBody() {
        const modal = document.getElementById('oneClickModal');
        if (modal && modal.parentElement !== document.body) {
            document.body.appendChild(modal);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 2. –ü–µ—Ä–µ–Ω–æ—Å–∏–º –º–æ–¥–∞–ª–∫—É —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        moveModalToBody();
    });

    function updateQty(amount) {
        const input = document.querySelector('input[name="quantity"]');
        let val = parseInt(input.value) || 1;
        let max = parseInt(input.getAttribute('max')) || 999;
        val += amount;
        if (val < 1) val = 1; if (val > max) val = max;
        input.value = val;
    }

    function changeMainImage(el) {
        const fullSrc = el.getAttribute('data-full-src');
        const mainImg = document.getElementById('main-product-image');
        mainImg.style.opacity = 0;
        setTimeout(() => {
            mainImg.src = fullSrc;
            mainImg.setAttribute('data-zoom-target', fullSrc);
            mainImg.style.opacity = 1;
        }, 200);
        document.querySelectorAll('.thumb-wrapper').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
    }

    // –õ–æ–≥–∏–∫–∞ 1 –∫–ª–∏–∫
    function openOneClickModal() {
        // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –µ—â–µ —Ä–∞–∑ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –ª–∏ –º–æ–¥–∞–ª–∫–∞
        moveModalToBody();
        document.getElementById('oneClickModal').style.display = 'flex';
    }
    function closeOneClickModal() {
        document.getElementById('oneClickModal').style.display = 'none';
    }
    function submitOneClick(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        fetch("{% url 'orders:one_click_order' product.id %}", {
            method: "POST",
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('oneClickForm').style.display = 'none';
                document.querySelector('.modal-header-visual').style.display = 'none';
                document.getElementById('oneClickSuccess').style.display = 'block';
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ'));
            }
        });
    }

    const zoomContainer = document.getElementById('main-image-zoom-container');
    const mainImg = document.getElementById('main-product-image');
    if (zoomContainer && mainImg) {
        zoomContainer.addEventListener('mousemove', function(e) {
            const rect = zoomContainer.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width * 100;
            const y = (e.clientY - rect.top) / rect.height * 100;
            mainImg.style.transformOrigin = `${x}% ${y}%`;
        });
        zoomContainer.addEventListener('mouseleave', function() {
            mainImg.style.transformOrigin = 'center center';
        });
    }

    if (typeof $ !== 'undefined') {
         $('#oneClickPhone').inputmask("+7 (999) 999-99-99");
    }
</script>
{% endblock %}

{% comment %}
<!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∂–∏–º–µ —Ü–≤–µ—Ç–æ–≤ -->
{% if debug %}
<div style="font-size: 10px; color: #999; margin-top: 5px;">
    –†–µ–∂–∏–º: {{ site_settings.discount_colors_mode }}<br>
    –¶–≤–µ—Ç —Å—Ç–∏–∫–µ—Ä–∞: {{ product.get_discount_sticker_color }}<br>
    –¶–≤–µ—Ç —Ü–µ–Ω—ã: {{ product.get_new_price_color }}
</div>
{% endif %}
{% endcomment %}
