<!-- shop/templates/shop/product_detail.html -->

{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} - {{ site_settings.shop_name }}{% endblock %}

{% block content %}
<div class="product-detail-page">
    <div class="product-detail-grid">

        <!-- ========================== -->
        <!-- ===== ЛЕВАЯ КОЛОНКА: ГАЛЕРЕЯ ===== -->
        <!-- ========================== -->
        <div class="product-gallery-new">
            <div class="main-image-container" id="main-image-zoom-container">
                <img id="main-product-image"
                     src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'shop/img/no_image.png' %}{% endif %}"
                     alt="{{ product.name }}">
            </div>
            {% with all_images=product.images.all %}
                {% if product.image or all_images %}
                <div class="thumbnails-new">
                    {% if product.image %}
                        <img src="{{ product.image_thumbnail.url }}"
                             alt="Превью {{ product.name }}"
                             class="thumbnail-new active"
                             data-full-src="{{ product.image.url }}"
                             onclick="changeMainImage(this)">
                    {% endif %}
                    {% for img in all_images %}
                        <img src="{{ img.image_thumbnail.url }}"
                             alt="{{ img.alt_text|default:'Превью товара' }}"
                             class="thumbnail-new"
                             data-full-src="{{ img.image.url }}"
                             onclick="changeMainImage(this)">
                    {% endfor %}
                </div>
                {% endif %}
            {% endwith %}
        </div>

        <!-- ==================================== -->
        <!-- ===== ПРАВАЯ КОЛОНКА: ИНФОРМАЦИЯ ===== -->
        <!-- ==================================== -->
        <div class="product-info-new">
            <h1 class="product-title-new">{{ product.name }}</h1>
            <div class="price-new">{{ product.price }} руб.</div>

            <div class="actions-new">
                {% if product.stock > 0 and product.available %}

                    <!-- СТАТУС НАЛИЧИЯ -->
                    <p class="stock-status in-stock" style="color: #28a745; font-weight: bold; margin-bottom: 10px;">✓ В наличии</p>

                    <form class="add-to-cart-form-detail" action="{% url 'cart:cart_add' product.id %}" method="post">
                        {% csrf_token %}

                        <!-- СЕЛЕКТОР КОЛИЧЕСТВА С КНОПКАМИ -->
                        <div class="quantity-selector">
                            <button type="button" class="qty-btn minus" onclick="updateQty(-1)">−</button>
                            {{ cart_product_form.quantity }}
                            <button type="button" class="qty-btn plus" onclick="updateQty(1)">+</button>
                        </div>

                        <button type="submit" class="add-to-cart-btn-new">
                            <span class="btn-text">Добавить в корзину</span>
                            <span class="btn-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                            </span>
                        </button>
                    </form>

                {% else %}
                    <p class="stock-status out-of-stock" style="color: #dc3545; font-weight: bold;">✖ Нет в наличии</p>
                {% endif %}
            </div>

            <!-- АККОРДЕОНЫ -->
            <div class="accordion-new">
                {% if product.composition %}
                <div class="accordion-item">
                    <button class="accordion-header">
                        <span>{{ product.composition_title|default:site_settings.default_composition_title }}</span>
                        <svg class="accordion-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                    <div class="accordion-content">
                        <p>{{ product.composition|linebreaksbr }}</p>
                    </div>
                </div>
                {% endif %}

                {% if product.description %}
                <div class="accordion-item">
                    <button class="accordion-header">
                        <span>{{ product.description_title|default:site_settings.default_description_title }}</span>
                        <svg class="accordion-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                    <div class="accordion-content">
                        <p>{{ product.description|linebreaksbr }}</p>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- ПРЕИМУЩЕСТВА -->
            <div class="benefits-block">
                {% for benefit in benefits %}
                    <div class="benefit-item" {% if benefit.description %}title="{{ benefit.description }}"{% endif %}>
                        {{ benefit.icon_svg|safe }}
                        <span>{{ benefit.title }}</span>
                    </div>
                {% endfor %}
            </div>

            <a href="{% url 'shop:product_list_all' %}" class="back-link-new">Вернуться в каталог</a>
        </div>
    </div>
</div>

<!-- СТИЛИ ДЛЯ КНОПОК +/- (Можно вынести в main.css, но пусть будут тут для гарантии) -->
<style>
    .qty-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        padding: 0 15px;
        color: #333;
        height: 100%;
    }
    .qty-btn:hover {
        color: var(--accent-color, #e53935);
        background-color: #f0f0f0;
    }
    /* Убираем стрелочки у инпута */
    .quantity-selector input[type=number]::-webkit-inner-spin-button,
    .quantity-selector input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    // 1. ЛОГИКА КНОПОК +/-
    function updateQty(change) {
        const input = document.querySelector('.quantity-selector input');
        if (!input) return;

        let newVal = parseInt(input.value) + change;
        if (newVal < 1) newVal = 1;
        // Можно добавить проверку на макс. кол-во (stock), если нужно

        input.value = newVal;
    }

    // 2. Галерея и лупа
    const mainImage = document.getElementById('main-product-image');
    const zoomContainer = document.getElementById('main-image-zoom-container');

    function changeMainImage(thumbnail) {
        const fullSrc = thumbnail.getAttribute('data-full-src');
        if (mainImage.src !== fullSrc) {
            mainImage.style.opacity = 0;
            setTimeout(() => {
                mainImage.src = fullSrc;
                mainImage.style.opacity = 1;
            }, 200);
        }

        document.querySelectorAll('.thumbnail-new').forEach(t => t.classList.remove('active'));
        thumbnail.classList.add('active');
    }

    if (zoomContainer) {
        zoomContainer.addEventListener('mousemove', function(e) {
            const rect = zoomContainer.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width * 100;
            const y = (e.clientY - rect.top) / rect.height * 100;
            mainImage.style.transformOrigin = `${x}% ${y}%`;
        });
        zoomContainer.addEventListener('mouseleave', function() {
            mainImage.style.transformOrigin = 'center center';
        });
    }

    // 3. Аккордеон
    const accordionItems = document.querySelectorAll('.accordion-item');
    accordionItems.forEach(item => {
        const header = item.querySelector('.accordion-header');
        const content = item.querySelector('.accordion-content');
        header.addEventListener('click', (e) => {
            e.preventDefault(); // Предотвращаем возможный сабмит формы, если баг вернется
            if (item.classList.contains('open')) {
                item.classList.remove('open');
                content.style.maxHeight = '0';
            } else {
                item.classList.add('open');
                content.style.maxHeight = content.scrollHeight + 'px';
            }
        });
        // Инициализация открытых
        if (item.classList.contains('open')) {
            content.style.maxHeight = content.scrollHeight + 'px';
        }
    });

    // 4. Анимация кнопки
    const addToCartForm = document.querySelector('.add-to-cart-form-detail');
    if (addToCartForm) {
        addToCartForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = this.querySelector('.add-to-cart-btn-new');

            if (btn.classList.contains('added')) return;

            btn.classList.add('added');
            btn.querySelector('.btn-text').textContent = 'Добавлено!';

            setTimeout(() => {
                this.submit();
            }, 500);
        });
    }
</script>
{% endblock %}