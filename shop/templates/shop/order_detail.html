<!-- shop/templates/shop/order_detail.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}–ó–∞–∫–∞–∑ #{{ order.id }} - –î–µ—Ç–∞–ª–∏{% endblock %}

{% block content %}

<div class="order-page-container fade-in">

    <!-- –®–∞–ø–∫–∞ —Å –∫–Ω–æ–ø–∫–æ–π –ù–∞–∑–∞–¥ -->
    <div class="order-header-row">
        <a href="{% url 'shop:cabinet' %}" class="back-link">
            <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            –ù–∞–∑–∞–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç
        </a>
        <div class="order-title-block">
            <h1>–ó–∞–∫–∞–∑ #{{ order.id }}</h1>
            <span class="status-badge status-{{ order.status }}">
                {{ order.get_status_display }}
            </span>
        </div>
        <div class="order-date">{{ order.created|date:"d.m.Y –≤ H:i" }}</div>
    </div>

    <!-- –ï–°–õ–ò –ó–ê–ö–ê–ó –û–¢–ú–ï–ù–ï–ù -->
    {% if order.status == 'cancelled' %}
    <div class="cancelled-alert">
        ‚õî –≠—Ç–æ—Ç –∑–∞–∫–∞–∑ –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω. –¢–æ–≤–∞—Ä—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ —Å–∫–ª–∞–¥.
    </div>
    {% endif %}

    <div class="order-layout">

        <!-- === –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –¢–û–í–ê–†–´ –ò –ò–ù–§–û === -->
        <div class="order-items-column">

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–æ—Å—Ç–∞–≤–∞ –∑–∞–∫–∞–∑–∞ -->
            <div class="section-card">
                <h3>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</h3>
                <div class="items-list">
                    {% for item in order.items.all %}
                    <div class="order-item-row">
                        <div class="item-img">
                            {% if item.product.image %}
                                <a href="{{ item.product.get_absolute_url }}">
                                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                                </a>
                            {% else %}
                                <div class="no-img">üå∏</div>
                            {% endif %}
                        </div>
                        <div class="item-info">
                            <a href="{{ item.product.get_absolute_url }}" class="item-name">{{ item.product.name }}</a>
                            <div class="item-meta">
                                {{ item.quantity }} —à—Ç. x {{ item.price }} ‚ÇΩ
                            </div>
                        </div>
                        <div class="item-total">
                            {{ item.get_cost }} ‚ÇΩ
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- –°–µ—Ç–∫–∞: –î–æ—Å—Ç–∞–≤–∫–∞ –∏ –ü–æ–ª—É—á–∞—Ç–µ–ª—å -->
            <div class="info-grid">
                <div class="section-card">
                    <h3>–î–æ—Å—Ç–∞–≤–∫–∞</h3>
                    {% if order.delivery_option == 'delivery' %}
                        <p><strong>–¢–∏–ø:</strong> –ö—É—Ä—å–µ—Ä</p>
                        <p><strong>–ê–¥—Ä–µ—Å:</strong> {{ order.city }}, {{ order.address }}</p>
                        {% if order.delivery_date %}
                            <p><strong>–î–∞—Ç–∞:</strong> {{ order.delivery_date|date:"d.m.Y" }}</p>
                        {% endif %}
                    {% else %}
                        <p><strong>–¢–∏–ø:</strong> –°–∞–º–æ–≤—ã–≤–æ–∑</p>
                        <p><strong>–ê–¥—Ä–µ—Å –º–∞–≥–∞–∑–∏–Ω–∞:</strong> {{ site_settings.pickup_address }}</p>
                    {% endif %}
                </div>

                <div class="section-card">
                    <h3>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</h3>
                    {% if order.recipient_name %}
                        <p><strong>–ò–º—è:</strong> {{ order.recipient_name }}</p>
                        <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ order.recipient_phone }}</p>
                    {% else %}
                        <p><strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong> {{ order.first_name }} {{ order.last_name }}</p>
                        <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ order.phone }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- –ë–ª–æ–∫ –û—Ç–∫—Ä—ã—Ç–∫–∏ -->
            {% if order.postcard or order.custom_postcard_image %}
            <div class="section-card postcard-info">
                <div class="pc-icon">üíå</div>
                <div class="pc-text">
                    <strong>–û—Ç–∫—Ä—ã—Ç–∫–∞:</strong>
                    {% if order.postcard %}
                        {{ order.postcard.title }}
                    {% else %}
                        –°–≤–æ—ë —Ñ–æ—Ç–æ
                    {% endif %}

                    {% if order.postcard_text %}
                        <div class="pc-message">"{{ order.postcard_text }}"</div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- === –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ò–¢–û–ì–ò === -->
        <div class="order-sidebar">
            <div class="summary-card sticky-block">
                <h3>–ò—Ç–æ–≥–æ</h3>

                <div class="summary-row">
                    <span>–¢–æ–≤–∞—Ä—ã</span>
                    <span>{{ order.get_items_cost }} ‚ÇΩ</span>
                </div>

                <!-- –ë–õ–û–ö –°–ö–ò–î–ö–ò -->
                {% if order.discount > 0 %}
                <div class="summary-row discount">
                    <span>–°–∫–∏–¥–∫–∞ ({{ order.promo_code.code|default:"PROMO" }} {{ order.discount }}%)</span>
                    <span>-{{ order.get_discount_amount|floatformat:0 }} ‚ÇΩ</span>
                </div>
                {% endif %}

                {% if order.delivery_cost > 0 %}
                <div class="summary-row">
                    <span>–î–æ—Å—Ç–∞–≤–∫–∞</span>
                    <span>{{ order.delivery_cost }} ‚ÇΩ</span>
                </div>
                {% endif %}

                {% if order.postcard and order.postcard.price > 0 %}
                <div class="summary-row highlight">
                    <span>–û—Ç–∫—Ä—ã—Ç–∫–∞</span>
                    <span>+{{ order.postcard.price }} ‚ÇΩ</span>
                </div>
                {% endif %}

                <div class="summary-divider"></div>

                <div class="grand-total">
                    <span>–ö –æ–ø–ª–∞—Ç–µ</span>
                    <span class="total-price">{{ order.get_total_cost }} ‚ÇΩ</span>
                </div>
            </div>

            <!-- === –ö–ù–û–ü–ö–ê –û–¢–ú–ï–ù–´ –ó–ê–ö–ê–ó–ê === -->
            <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–∫–∞–∑ –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å (—Å—Ç–∞—Ç—É—Å 'created' –∏–ª–∏ 'processing') -->
            {% if order.can_be_cancelled %}
                <form action="{% url 'shop:cancel_order' order.id %}" method="post" style="margin-top: 15px;">
                    {% csrf_token %}
                    <button type="submit" class="btn-cancel-order" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?');">
                        –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                    </button>
                </form>
            {% endif %}
            <!-- ============================= -->

        </div>

    </div>
</div>

<style>
    /* CSS –ü–ï–†–ï–ú–ï–ù–ù–´–ï */
    :root {
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
        --primary: var(--accent-color, #e53935);
        --text-dark: #333;
        --radius: 12px;
        --shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    .order-page-container {
        max-width: 1000px; margin: 0 auto; padding: 20px 20px 60px 20px;
        font-family: var(--default-font-family, sans-serif);
    }

    /* –®–ê–ü–ö–ê */
    .order-header-row {
        display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between;
        margin-bottom: 30px; gap: 15px;
    }
    .back-link {
        display: flex; align-items: center; gap: 5px; text-decoration: none;
        color: #777; font-weight: 600; font-size: 0.9rem; transition: 0.2s;
    }
    .back-link:hover { color: var(--primary); }
    .back-link svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2; }

    .order-title-block { display: flex; align-items: center; gap: 15px; }
    .order-title-block h1 { margin: 0; font-size: 1.8rem; color: var(--text-dark); }

    .status-badge {
        padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;
    }
    .status-created { background: #e3f2fd; color: #1976d2; }
    .status-processing { background: #fff3e0; color: #f57c00; }
    .status-shipped { background: #e8f5e9; color: #388e3c; }
    .status-delivered { background: #dcedc8; color: #33691e; }
    .status-cancelled { background: #ffebee; color: #c62828; }

    .order-date { color: #999; font-size: 0.9rem; }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ */
    .cancelled-alert {
        background: #ffebee; color: #c62828; padding: 15px; border-radius: var(--radius);
        margin-bottom: 20px; border: 1px solid #ffcdd2; text-align: center; font-weight: 500;
    }

    /* –°–ï–¢–ö–ê */
    .order-layout {
        display: grid; grid-template-columns: 1fr 320px; gap: 30px; align-items: start;
    }

    /* –ö–ê–†–¢–û–ß–ö–ò */
    .section-card {
        background: var(--card-bg); border-radius: var(--radius); padding: 20px;
        box-shadow: var(--shadow); border: 1px solid #eee; margin-bottom: 20px;
    }
    .section-card h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.1rem; color: #555; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
    .section-card p { margin: 5px 0; color: #333; font-size: 0.95rem; }

    /* –°–ü–ò–°–û–ö –¢–û–í–ê–†–û–í */
    .order-item-row {
        display: flex; align-items: center; gap: 15px; padding: 10px 0; border-bottom: 1px solid #f9f9f9;
    }
    .order-item-row:last-child { border-bottom: none; }
    .item-img { width: 60px; height: 60px; border-radius: 8px; overflow: hidden; background: #f4f4f4; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .item-img img { width: 100%; height: 100%; object-fit: cover; }
    .no-img { font-size: 24px; }

    .item-info { flex-grow: 1; }
    .item-name { font-weight: 600; color: var(--text-dark); text-decoration: none; font-size: 1rem; }
    .item-meta { color: #888; font-size: 0.85rem; margin-top: 3px; }
    .item-total { font-weight: 700; font-size: 1rem; white-space: nowrap; }

    /* –°–ï–¢–ö–ê –ò–ù–§–û */
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    /* –û–¢–ö–†–´–¢–ö–ê */
    .postcard-info { display: flex; gap: 15px; align-items: flex-start; background: #fff8e1; border-color: #ffe082; }
    .pc-icon { font-size: 1.5rem; }
    .pc-message { font-style: italic; color: #666; margin-top: 5px; background: rgba(255,255,255,0.5); padding: 8px; border-radius: 6px; }

    /* –°–ê–ô–î–ë–ê–† (–ò–¢–û–ì–ò) */
    .summary-card {
        background: var(--card-bg); padding: 25px; border-radius: var(--radius);
        box-shadow: var(--shadow); border: 1px solid #eee; position: sticky; top: 20px;
    }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; color: #555; font-size: 0.95rem; }

    .summary-row.discount { color: #2e7d32; font-weight: 700; }
    .summary-row.highlight { color: #1976d2; }
    .summary-divider { height: 1px; background: #eee; margin: 15px 0; }
    .grand-total { display: flex; justify-content: space-between; font-size: 1.4rem; font-weight: 800; color: var(--text-dark); }
    .total-price { color: var(--primary); }

    /* –ö–ù–û–ü–ö–ê –û–¢–ú–ï–ù–´ */
    .btn-cancel-order {
        display: block; width: 100%; padding: 12px;
        background: transparent; border: 1px solid #dc3545; color: #dc3545;
        border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
    }
    .btn-cancel-order:hover {
        background: #dc3545; color: #fff;
    }

    .fade-in { animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* –ê–î–ê–ü–¢–ò–í */
    @media (max-width: 768px) {
        .order-layout { grid-template-columns: 1fr; }
        .info-grid { grid-template-columns: 1fr; }
        .order-sidebar { order: -1; } /* –ò—Ç–æ–≥–∏ —Å–≤–µ—Ä—Ö—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
</style>

{% endblock %}