<!-- shop/templates/shop/cabinet.html -->

{% extends "base.html" %}
{% load static %}

{% block title %}Личный кабинет{% endblock %}

{% block content %}
<div class="container" style="padding-top: 2rem; padding-bottom: 2rem;">

    <!-- Блок для отображения сообщений (например, "Профиль успешно обновлен!") -->
    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h1>Личный кабинет, {{ user.first_name|default:user.username }}!</h1>
        <a href="{% url 'shop:profile_edit' %}" class="btn btn-primary">Редактировать профиль</a>
    </div>

    <hr>
    <h3>Ваша история заказов</h3>

    {% if orders %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th scope="col"># Заказа</th>
                        <th scope="col">Дата</th>
                        <th scope="col">Сумма</th>
                        <th scope="col">Статус</th>
                        <th scope="col">Статус оплаты</th>
                        <th scope="col">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                        <tr>
                            <td><a href="{% url 'shop:order_detail' order.id %}">{{ order.id }}</a></td>
                            <td>{{ order.created|date:"d.m.Y, H:i" }}</td>
                            <td>{{ order.get_total_cost }} руб.</td>
                            <td>
                                <!-- *** ИЗМЕНЕНИЕ ЗДЕСЬ *** -->
                                <!-- Добавляем класс 'status-cancelled' если статус заказа 'cancelled' -->
                                <span class="{% if order.status == 'cancelled' %}status-cancelled{% endif %}">
                                    {{ order.get_status_display }}
                                </span>
                            </td>
                            <td>
                                {% if order.paid %}
                                    <span style="color: green;">Оплачен</span>
                                {% else %}
                                    <span style="color: red;">Ожидает оплаты</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'shop:order_detail' order.id %}" class="btn btn-secondary">Просмотреть</a>
                                {% if order.can_be_cancelled %}
                                    <form action="{% url 'shop:cancel_order' order.id %}" method="post" style="display: inline; margin: 0; padding: 0;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger" onclick="return confirm('Вы уверены, что хотите отменить заказ #{{ order.id }}?')">
                                            Отменить
                                        </button>
                                    </form>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>У вас еще нет ни одного заказа.</p>
        <a href="{% url "shop:product_list_all" %}" class="btn btn-primary">Перейти к покупкам</a>
    {% endif %}
</div>

<style>
    .messages { padding-left: 0; list-style: none; }
    .messages .success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; padding: .75rem 1.25rem; margin-bottom: 1rem; border-radius: .25rem; }
    .messages .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: .75rem 1.25rem; margin-bottom: 1rem; border-radius: .25rem; }

    /* --- СТИЛИ ДЛЯ КНОПОК --- */
    .btn { display: inline-block; padding: 10px 15px; border: none; border-radius: 5px; text-decoration: none; color: white; font-size: 14px; font-family: inherit; cursor: pointer; text-align: center; margin: 2px; vertical-align: middle; }
    .btn-primary { background-color: #007bff; }
    .btn-primary:hover { background-color: #0056b3; }
    .btn-danger { background-color: #dc3545; }
    .btn-danger:hover { background-color: #c82333; }
    .btn-secondary { background-color: #6c757d; }
    .btn-secondary:hover { background-color: #5a6268; }

    /* --- *** НОВЫЙ СТИЛЬ ДЛЯ СТАТУСА *** --- */
    .status-cancelled {
        color: #dc3545; /* Тот же красный цвет, что и у кнопки "Отменить" */
        font-weight: bold;
    }
</style>
{% endblock %}