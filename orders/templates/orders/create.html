<!-- orders/templates/orders/create.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js"></script>

<div class="container" style="max-width: 1100px; padding-top: 30px; padding-bottom: 50px;">

    <h1 style="margin-bottom: 30px;">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>

    {% if form.errors %}
        <div class="error-alert">
            <h4>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏:</h4>
            <ul>
            {% for field in form %}
                {% if field.errors %}
                    <li><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</li>
                {% endif %}
            {% endfor %}
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form action="." method="post" class="order-create-form" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="order-grid">
            <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
            <div class="order-form-column">

                <!-- 1. –°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è -->
                <div class="form-section">
                    <h3>1. –°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</h3>

                    <div class="delivery-options-wrapper">
                        {% for radio in form.delivery_option %}
                            <label class="delivery-radio-label" for="{{ radio.id_for_label }}">
                                {{ radio.tag }}
                                <span class="radio-custom"></span>
                                <span class="radio-text">{{ radio.choice_label }}</span>
                            </label>
                        {% endfor %}
                    </div>

                    <!-- –ë–ª–æ–∫ –¥–∞—Ç—ã (–°–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ) -->
                    <div class="datetime-block" id="delivery-datetime-block">
                        <label class="block-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏:</label>

                        <div class="date-buttons">
                            <button type="button" class="btn-date-quick" onclick="setToday()">–°–µ–≥–æ–¥–Ω—è</button>
                            <button type="button" class="btn-date-quick" onclick="setTomorrow()">–ó–∞–≤—Ç—Ä–∞</button>
                        </div>

                        <div class="form-row-smart">
                            <div class="form-group date-input-wrapper">
                                <label>–î–∞—Ç–∞:</label>
                                <!-- –ü–æ–ª–µ –¥–∞—Ç—ã + –ò–∫–æ–Ω–∫–∞ -->
                                {{ form.delivery_date }}
                                <span class="calendar-icon">üìÖ</span>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>–í—Ä–µ–º—è:</label>
                                {{ form.delivery_time }}
                            </div>
                        </div>
                    </div>

                    <!-- –ê–¥—Ä–µ—Å -->
                    <div id="address-fields">
                        <div class="form-group">{{ form.city.label_tag }} {{ form.city }}</div>
                        <div class="form-group">{{ form.address.label_tag }} {{ form.address }}</div>
                        <div class="form-group" style="display:none;">{{ form.postal_code }}</div>
                    </div>
                </div>

                <!-- 2. –ü–æ–ª—É—á–∞—Ç–µ–ª—å -->
                <div class="form-section" id="recipient-section">
                    <h3>2. –ö—Ç–æ –ø–æ–ª—É—á–∏—Ç –∑–∞–∫–∞–∑?</h3>

                    <div class="recipient-toggle-wrapper">
                        <label class="recipient-radio">
                            <input type="radio" name="recipient_who" value="me" checked onchange="toggleRecipient(this)">
                            <span>üë§ –Ø –ø–æ–ª—É—á—É —Å–∞–º</span>
                        </label>
                        <label class="recipient-radio">
                            <input type="radio" name="recipient_who" value="other" onchange="toggleRecipient(this)">
                            <span>üéÅ –î—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫</span>
                        </label>
                    </div>

                    <div id="other-recipient-fields" style="display: none; margin-top: 15px; padding: 15px; background: #fff5f5; border-radius: 8px; border: 1px dashed var(--accent-color);">
                        <p style="margin-top: 0; font-size: 0.9em; color: var(--accent-color); margin-bottom: 10px;">
                            –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏.
                        </p>
                        <div class="form-group">
                            <label>–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                            {{ form.recipient_name }}
                        </div>
                        <div class="form-group">
                            <label>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                            {{ form.recipient_phone }}
                        </div>
                    </div>
                </div>

                <!-- 3. –û—Ç–∫—Ä—ã—Ç–∫–∏ -->
                <div class="form-section">
                    <h3>3. –û—Ç–∫—Ä—ã—Ç–∫–∞ –∫ –±—É–∫–µ—Ç—É</h3>

                    <div class="postcards-grid">
                        <label class="postcard-option">
                            <input type="radio" name="postcard" value="" data-price="0" checked onchange="handlePostcardChange(this)">
                            <div class="postcard-card-visual">
                                <div class="no-card-icon">üö´</div>
                                <span>–ë–µ–∑ –æ—Ç–∫—Ä—ã—Ç–∫–∏</span>
                            </div>
                        </label>

                        {% for card in postcards %}
                        <label class="postcard-option">
                            <input type="radio" name="postcard" value="{{ card.id }}" data-price="{{ card.price|stringformat:'.0f' }}" onchange="handlePostcardChange(this)">
                            <div class="postcard-card-visual">
                                <img src="{{ card.image.url }}" alt="{{ card.title }}">
                                <span class="card-title">{{ card.title }}</span>
                                <span class="card-price">{% if card.price > 0 %}+{{ card.price }}‚ÇΩ{% else %}–ë–µ—Å–ø–ª–∞—Ç–Ω–æ{% endif %}</span>
                            </div>
                        </label>
                        {% endfor %}

                        <label class="postcard-option">
                            <input type="radio" name="postcard" value="custom" data-price="0" onchange="handlePostcardChange(this)">
                            <div class="postcard-card-visual">
                                <div class="no-card-icon">üì∏</div>
                                <span>–°–≤–æ—ë —Ñ–æ—Ç–æ</span>
                            </div>
                        </label>
                    </div>

                    <div id="custom-image-upload" style="display: none; margin-top: 15px;">
                        <label>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ:</label>
                        {{ form.custom_postcard_image }}
                    </div>

                    <div id="postcard-text-group" style="display: none; margin-top: 15px;">
                        <label for="id_postcard_text">–¢–µ–∫—Å—Ç –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è:</label>
                        {{ form.postcard_text }}
                    </div>
                </div>

                <!-- 4. –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ -->
                <div class="form-section">
                    <h3>4. –í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                    <div class="form-row-smart">
                        <div class="form-group">{{ form.first_name.label_tag }} {{ form.first_name }}</div>
                        <div class="form-group">{{ form.phone.label_tag }} {{ form.phone }}</div>
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label for="id_email">Email:</label>
                        {{ form.email }}
                    </div>
                    <div class="form-group" style="display:none;">{{ form.last_name }}</div>
                </div>

            </div>

            <!-- –ò–¢–û–ì–û -->
            <div class="order-summary-column">
                <div class="order-summary-box">
                    <h3>–í–∞—à –∑–∞–∫–∞–∑</h3>
                    <ul class="summary-items">
                        {% for item in cart %}
                        <li>
                            <span class="item-name">{{ item.product.name }} <small>x {{ item.quantity }}</small></span>
                            <span class="item-price">{{ item.total_price }} ‚ÇΩ</span>
                        </li>
                        {% endfor %}
                    </ul>
                    <hr>
                    <div class="summary-row"><span>–¢–æ–≤–∞—Ä—ã:</span><span>{{ cart_total_js }} ‚ÇΩ</span></div>
                    <div class="summary-row" id="delivery-row"><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span><span id="delivery-price-display">{{ delivery_cost_js }} ‚ÇΩ</span></div>
                    <div class="summary-row" id="postcard-row" style="display: none; color: #28a745;"><span>+ –û—Ç–∫—Ä—ã—Ç–∫–∞:</span><span id="postcard-price-display">0 ‚ÇΩ</span></div>
                    <hr>
                    <div class="summary-total"><span>–ò—Ç–æ–≥–æ:</span><span id="final-total">0 ‚ÇΩ</span></div>

                    <button type="submit" class="btn-checkout-confirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
                    <p class="privacy-note">–ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.</p>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    .order-grid { display: grid; grid-template-columns: 1fr 380px; gap: 40px; align-items: start; }
    .form-section { background: #fff; padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); border: 1px solid #f0f0f0; }
    .form-section h3 { margin-top: 0; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px; font-size: 1.3em; color: #333; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.95em; color: #555; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; transition: border-color 0.2s; box-sizing: border-box; }
    .form-group input:focus { border-color: var(--accent-color, #333); outline: none; }
    .form-row-smart { display: flex; gap: 20px; }
    .form-row-smart .form-group { flex: 1; }

    /* –î–æ—Å—Ç–∞–≤–∫–∞ */
    .delivery-options-wrapper { display: flex; gap: 20px; margin-bottom: 25px; }
    .delivery-radio-label { display: flex; align-items: center; cursor: pointer; gap: 10px; }
    .delivery-radio-label input { display: none; }
    .radio-custom { width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%; position: relative; transition: 0.2s; }
    .radio-custom::after { content: ''; position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; background: var(--accent-color, #e53935); border-radius: 50%; transform: translate(-50%, -50%) scale(0); transition: 0.2s; }
    .delivery-radio-label input:checked + .radio-custom { border-color: var(--accent-color, #e53935); }
    .delivery-radio-label input:checked + .radio-custom::after { transform: translate(-50%, -50%) scale(1); }
    .radio-text { font-size: 1.1em; }

    /* --- –ë–õ–û–ö –î–ê–¢–´ --- */
    .datetime-block { background: #fdfdfd; border: 1px solid #eee; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
    .block-label { display: block; font-weight: bold; margin-bottom: 15px; color: #333; }

    .date-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
    .btn-date-quick {
        background: #fff; border: 2px solid var(--button-bg-color, #e53935);
        color: var(--button-bg-color, #e53935); padding: 8px 20px; border-radius: 50px;
        cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: 0.2s;
    }
    .btn-date-quick:hover { background: var(--button-bg-color, #e53935); color: var(--button-text-color, #fff); }

    /* –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –ø–æ–ª—è –¥–∞—Ç—ã */
    .date-input-wrapper { position: relative; flex: 1; }

    /* –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
    .calendar-icon {
        position: absolute;
        right: 15px;
        top: 38px; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏–Ω–ø—É—Ç–∞ */
        font-size: 1.4rem;
        cursor: pointer;
        pointer-events: none; /* –í–ê–ñ–ù–û: –ö–ª–∏–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–∫–≤–æ–∑—å –∏–∫–æ–Ω–∫—É –≤ –∏–Ω–ø—É—Ç */
        opacity: 0.7;
    }

    /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –≤ –∏–Ω–ø—É—Ç–µ, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–µ–∑–∂–∞–ª –Ω–∞ –∏–∫–æ–Ω–∫—É */
    .datepicker-input {
        background-color: #fff !important;
        cursor: pointer;
        padding-right: 40px !important;
    }

    /* –ü–æ–ª—É—á–∞—Ç–µ–ª—å */
    .recipient-toggle-wrapper { display: flex; gap: 5px; background: #f4f4f4; padding: 5px; border-radius: 10px; margin-bottom: 15px; }
    .recipient-radio { flex: 1; position: relative; cursor: pointer; }
    .recipient-radio input { position: absolute; opacity: 0; }
    .recipient-radio span { display: block; text-align: center; padding: 12px; border-radius: 8px; transition: 0.2s; font-weight: 600; color: #666; }
    .recipient-radio input:checked + span { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); color: #333; }

    /* –û—Ç–∫—Ä—ã—Ç–∫–∏ */
    .postcards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; }
    .postcard-option { cursor: pointer; position: relative; }
    .postcard-option input { position: absolute; opacity: 0; }
    .postcard-card-visual { border: 2px solid #eee; border-radius: 12px; padding: 10px; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; min-height: 130px; background: #fff; }
    .postcard-card-visual img { max-width: 100%; height: 80px; object-fit: contain; margin-bottom: 8px; border-radius: 4px; }
    .no-card-icon { font-size: 2.5em; margin-bottom: 8px; }
    .card-title { font-size: 0.85em; line-height: 1.2; margin-bottom: 4px; display: block; }
    .card-price { font-size: 0.8em; font-weight: bold; color: #28a745; display: block; }
    .postcard-option input:checked + .postcard-card-visual { border-color: var(--accent-color, #e53935); background-color: #fff5f5; box-shadow: 0 4px 12px rgba(0,0,0, 0.1); transform: translateY(-2px); }

    /* –ò—Ç–æ–≥–æ */
    .order-summary-box { background: #fff; padding: 30px; border-radius: 16px; position: sticky; top: 30px; border: 1px solid #f0f0f0; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
    .summary-items { list-style: none; padding: 0; margin: 0 0 20px 0; font-size: 0.95em; color: #555; }
    .summary-items li { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #f9f9f9; padding-bottom: 10px; }
    .summary-items li:last-child { border-bottom: none; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1.1em; color: #444; }
    .summary-total { display: flex; justify-content: space-between; font-size: 1.6em; font-weight: 700; margin-top: 20px; color: var(--accent-color, #e53935); padding-top: 15px; border-top: 2px solid #f0f0f0; }

    .btn-checkout-confirm {
        width: 100%; padding: 18px; font-size: 1.2em; margin-top: 25px;
        background-color: var(--button-bg-color, #e53935);
        color: var(--button-text-color, #ffffff);
        font-family: var(--button-font-family, inherit);
        border-radius: var(--button-border-radius, 8px);
        border: none; font-weight: 600; cursor: pointer;
        box-shadow: 0 8px 20px rgba(0,0,0,0.15); transition: 0.2s;
    }
    .btn-checkout-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 25px rgba(0,0,0,0.2);
        background-color: var(--button-hover-bg-color, #d32f2f);
    }

    .privacy-note { font-size: 0.75em; color: #999; text-align: center; margin-top: 15px; line-height: 1.4; }
    .error-alert { background-color: #f8d7da; color: #721c24; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #f5c6cb; }

    @media (max-width: 900px) { .order-grid { grid-template-columns: 1fr; } .order-summary-box { position: static; margin-top: 20px; } .form-row-smart { flex-direction: column; gap: 15px; } }
</style>

<script>
    const cartTotal = {{ cart_total_js|stringformat:".0f" }};
    const deliveryCostBase = {{ delivery_cost_js|stringformat:".0f" }};
    let currentDeliveryCost = deliveryCostBase;
    let currentPostcardPrice = 0;

    const addressFields = document.getElementById('address-fields');
    const deliveryRow = document.getElementById('delivery-row');
    const datetimeBlock = document.getElementById('delivery-datetime-block');
    const deliveryPriceDisplay = document.getElementById('delivery-price-display');
    const postcardRow = document.getElementById('postcard-row');
    const postcardPriceDisplay = document.getElementById('postcard-price-display');
    const finalTotalDisplay = document.getElementById('final-total');

    const postcardTextGroup = document.getElementById('postcard-text-group');
    const customImageUpload = document.getElementById('custom-image-upload');
    const otherRecipientFields = document.getElementById('other-recipient-fields');

    // 1. –î–æ—Å—Ç–∞–≤–∫–∞
    document.querySelectorAll('input[name="delivery_option"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'pickup') {
                addressFields.style.display = 'none';
                deliveryRow.style.display = 'none';
                datetimeBlock.style.display = 'none';
                currentDeliveryCost = 0;
            } else {
                addressFields.style.display = 'block';
                deliveryRow.style.display = 'flex';
                datetimeBlock.style.display = 'block';
                currentDeliveryCost = deliveryCostBase;
            }
            recalcTotal();
        });
    });

    // 2. –ü–æ–ª—É—á–∞—Ç–µ–ª—å
    function toggleRecipient(radio) {
        if (radio.value === 'other') {
            otherRecipientFields.style.display = 'block';
        } else {
            otherRecipientFields.style.display = 'none';
        }
    }

    // 3. –û—Ç–∫—Ä—ã—Ç–∫–∏
    function handlePostcardChange(input) {
        const price = parseInt(input.getAttribute('data-price')) || 0;
        currentPostcardPrice = price;

        if (input.value === "") {
            postcardTextGroup.style.display = 'none';
            customImageUpload.style.display = 'none';
            document.querySelector('#id_postcard_text').value = '';
        } else if (input.value === "custom") {
            postcardTextGroup.style.display = 'block';
            customImageUpload.style.display = 'block';
        } else {
            postcardTextGroup.style.display = 'block';
            customImageUpload.style.display = 'none';
        }

        if (price > 0) {
            postcardRow.style.display = 'flex';
            postcardPriceDisplay.innerText = '+' + price + ' ‚ÇΩ';
        } else {
            postcardRow.style.display = 'none';
        }
        recalcTotal();
    }

    function recalcTotal() {
        const total = cartTotal + currentDeliveryCost + currentPostcardPrice;
        finalTotalDisplay.innerText = total + ' ‚ÇΩ';
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–õ–ï–ù–î–ê–†–Ø ===
    let fpInstance;

    document.addEventListener('DOMContentLoaded', function() {
        recalcTotal();

        // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–µ—Å–ª–∏ –±—ã–ª–∞ –æ—à–∏–±–∫–∞ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å)
        const activeDelivery = document.querySelector('input[name="delivery_option"]:checked');
        if(activeDelivery && activeDelivery.value === 'pickup') {
             addressFields.style.display = 'none';
             deliveryRow.style.display = 'none';
             datetimeBlock.style.display = 'none';
             currentDeliveryCost = 0;
             recalcTotal();
        }

        fpInstance = flatpickr(".datepicker-input", {
            locale: "ru",
            minDate: "today",
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "j F Y",
            disableMobile: "true",
            allowInput: true
        });
    });

    function setToday() {
        if (fpInstance) {
            const today = new Date();
            fpInstance.setDate(today);
        }
    }

    function setTomorrow() {
        if (fpInstance) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            fpInstance.setDate(tomorrow);
        }
    }
</script>
{% endblock %}