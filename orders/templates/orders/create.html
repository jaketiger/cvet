<!-- orders/templates/orders/create.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px; padding-top: 2rem; padding-bottom: 2rem;">
    <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>

    <!-- === –ë–õ–û–ö –û–®–ò–ë–û–ö === -->
    {% if form.errors %}
        <div style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
            <h4 style="margin-top: 0;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏:</h4>
            <ul>
            {% for field in form %}
                {% if field.errors %}
                    <li><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</li>
                {% endif %}
            {% endfor %}
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
            </ul>
        </div>
    {% endif %}
    <!-- === –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –û–®–ò–ë–û–ö === -->

    <form action="." method="post" class="order-create-form" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="order-grid">
            <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
            <div class="order-form-column">

                <!-- 1. –î–æ—Å—Ç–∞–≤–∫–∞ (–¢–ï–ü–ï–†–¨ –ü–ï–†–í–ê–Ø) -->
                <div class="form-section">
                    <h3>1. –°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</h3>
                    <div class="delivery-options">
                        {% for radio in form.delivery_option %}
                            <div class="custom-radio-block">
                                {{ radio.tag }}
                                <label for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                            </div>
                        {% endfor %}
                    </div>

                    <div id="address-fields">
                        <div class="form-group">{{ form.city.label_tag }} {{ form.city }}</div>
                        <div class="form-group">{{ form.address.label_tag }} {{ form.address }}</div>
                        <div class="form-group" style="display:none;">{{ form.postal_code }}</div> <!-- –ò–Ω–¥–µ–∫—Å —Å–∫—Ä—ã–ª, –æ–±—ã—á–Ω–æ –Ω–µ –Ω—É–∂–µ–Ω –∫—É—Ä—å–µ—Ä—É -->
                    </div>
                </div>

                <!-- 2. –ü–æ–ª—É—á–∞—Ç–µ–ª—å (–ö–¢–û –ü–û–õ–£–ß–ò–¢?) -->
                <div class="form-section" id="recipient-section">
                    <h3>2. –ö—Ç–æ –ø–æ–ª—É—á–∏—Ç –∑–∞–∫–∞–∑?</h3>

                    <div class="recipient-toggle-wrapper">
                        <label class="recipient-radio">
                            <input type="radio" name="recipient_who" value="me" checked onchange="toggleRecipient(this)">
                            <span>üë§ –Ø –ø–æ–ª—É—á—É —Å–∞–º</span>
                        </label>
                        <label class="recipient-radio">
                            <input type="radio" name="recipient_who" value="other" onchange="toggleRecipient(this)">
                            <span>üéÅ –î—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫</span>
                        </label>
                    </div>

                    <!-- –ü–æ–ª—è –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–°–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div id="other-recipient-fields" style="display: none; margin-top: 15px; padding: 15px; background: #fff5f5; border-radius: 8px;">
                        <p style="margin-top: 0; font-size: 0.9em; color: #e53935;">–ú—ã –Ω–µ —Å–æ–æ–±—â–∏–º –ø–æ–ª—É—á–∞—Ç–µ–ª—é –æ –∑–∞–∫–∞–∑—á–∏–∫–µ –¥–æ –≤—Ä—É—á–µ–Ω–∏—è.</p>
                        <div class="form-group">
                            <label>–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                            {{ form.recipient_name }}
                        </div>
                        <div class="form-group">
                            <label>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                            {{ form.recipient_phone }}
                        </div>
                    </div>
                </div>

                <!-- 3. –û—Ç–∫—Ä—ã—Ç–∫–∏ -->
                <div class="form-section">
                    <h3>3. –û—Ç–∫—Ä—ã—Ç–∫–∞ –∫ –±—É–∫–µ—Ç—É</h3>

                    <div class="postcards-grid">
                        <label class="postcard-option">
                            <input type="radio" name="postcard" value="" data-price="0" checked onchange="handlePostcardChange(this)">
                            <div class="postcard-card-visual">
                                <div class="no-card-icon">üö´</div>
                                <span>–ë–µ–∑ –æ—Ç–∫—Ä—ã—Ç–∫–∏</span>
                            </div>
                        </label>

                        {% for card in postcards %}
                        <label class="postcard-option">
                            <input type="radio" name="postcard" value="{{ card.id }}" data-price="{{ card.price|stringformat:'.0f' }}" onchange="handlePostcardChange(this)">
                            <div class="postcard-card-visual">
                                <img src="{{ card.image.url }}" alt="{{ card.title }}">
                                <span class="card-title">{{ card.title }}</span>
                                <span class="card-price">{% if card.price > 0 %}+{{ card.price }}‚ÇΩ{% else %}–ë–µ—Å–ø–ª–∞—Ç–Ω–æ{% endif %}</span>
                            </div>
                        </label>
                        {% endfor %}

                        <label class="postcard-option">
                            <input type="radio" name="postcard" value="custom" data-price="0" onchange="handlePostcardChange(this)">
                            <div class="postcard-card-visual">
                                <div class="no-card-icon">üì∏</div>
                                <span>–°–≤–æ—ë —Ñ–æ—Ç–æ</span>
                            </div>
                        </label>
                    </div>

                    <div id="custom-image-upload" style="display: none; margin-top: 15px;">
                        <label>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ:</label>
                        {{ form.custom_postcard_image }}
                    </div>

                    <div id="postcard-text-group" style="display: none; margin-top: 15px;">
                        <label for="id_postcard_text">–¢–µ–∫—Å—Ç –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è:</label>
                        {{ form.postcard_text }}
                    </div>
                </div>

                <!-- 4. –ö–æ–Ω—Ç–∞–∫—Ç—ã –ó–∞–∫–∞–∑—á–∏–∫–∞ (–¢–ï–ü–ï–†–¨ –í–ù–ò–ó–£) -->
                <div class="form-section">
                    <h3>4. –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ (–ó–∞–∫–∞–∑—á–∏–∫)</h3>
                    <div class="form-row-smart">
                        <div class="form-group">{{ form.first_name.label_tag }} {{ form.first_name }}</div>
                        <div class="form-group">{{ form.phone.label_tag }} {{ form.phone }}</div>
                    </div>
                    <!-- Email –Ω—É–∂–µ–Ω –¥–ª—è —á–µ–∫–∞, –Ω–æ —Å–¥–µ–ª–∞–µ–º –µ–≥–æ –º–µ–Ω–µ–µ –Ω–∞–≤—è–∑—á–∏–≤—ã–º -->
                    <div class="form-group" style="margin-top: 10px;">
                        <label for="id_email">Email (–¥–ª—è —á–µ–∫–∞):</label>
                        {{ form.email }}
                    </div>
                    <!-- –§–∞–º–∏–ª–∏—é —Å–∫—Ä—ã–≤–∞–µ–º –∏–ª–∏ –¥–µ–ª–∞–µ–º –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π (–µ—Å–ª–∏ –≤ forms.py –æ–Ω–∞ required=False) -->
                    <div class="form-group" style="display:none;">{{ form.last_name }}</div>
                </div>

            </div>

            <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ò–¢–û–ì–û -->
            <div class="order-summary-column">
                <div class="order-summary-box">
                    <h3>–í–∞—à –∑–∞–∫–∞–∑</h3>
                    <ul class="summary-items">
                        {% for item in cart %}
                        <li>
                            <span>{{ item.product.name }} x {{ item.quantity }}</span>
                            <span>{{ item.total_price }} ‚ÇΩ</span>
                        </li>
                        {% endfor %}
                    </ul>
                    <hr>
                    <div class="summary-row"><span>–¢–æ–≤–∞—Ä—ã:</span><span>{{ cart_total_js }} ‚ÇΩ</span></div>
                    <div class="summary-row" id="delivery-row"><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span><span id="delivery-price-display">{{ delivery_cost_js }} ‚ÇΩ</span></div>
                    <div class="summary-row" id="postcard-row" style="display: none; color: #28a745;"><span>+ –û—Ç–∫—Ä—ã—Ç–∫–∞:</span><span id="postcard-price-display">0 ‚ÇΩ</span></div>
                    <hr>
                    <div class="summary-total"><span>–ò—Ç–æ–≥–æ:</span><span id="final-total">0 ‚ÇΩ</span></div>
                    <button type="submit" class="btn btn-primary btn-block">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    .order-grid { display: grid; grid-template-columns: 1fr 350px; gap: 30px; }
    .form-section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; }
    .form-section h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.3em; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.95em; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1em; }

    /* –†–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ */
    .delivery-options { display: flex; gap: 15px; margin-bottom: 15px; }
    .custom-radio-block { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .custom-radio-block input { width: auto; margin: 0; }

    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è */
    .recipient-toggle-wrapper { display: flex; gap: 10px; background: #f8f8f8; padding: 5px; border-radius: 8px; margin-bottom: 10px; }
    .recipient-radio { flex: 1; position: relative; cursor: pointer; }
    .recipient-radio input { position: absolute; opacity: 0; }
    .recipient-radio span { display: block; text-align: center; padding: 10px; border-radius: 6px; transition: 0.2s; border: 1px solid transparent; font-weight: 600; }
    .recipient-radio input:checked + span { background: #fff; border-color: #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: #e53935; }

    /* –û—Ç–∫—Ä—ã—Ç–∫–∏ */
    .postcards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .postcard-option { cursor: pointer; position: relative; }
    .postcard-option input { position: absolute; opacity: 0; }
    .postcard-card-visual { border: 2px solid #eee; border-radius: 8px; padding: 5px; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; min-height: 120px; }
    .postcard-card-visual img { max-width: 100%; height: 70px; object-fit: contain; margin-bottom: 5px; }
    .no-card-icon { font-size: 2em; margin-bottom: 5px; }
    .card-title { font-size: 0.85em; line-height: 1.2; margin-bottom: 3px; }
    .card-price { font-size: 0.8em; font-weight: bold; color: #28a745; }
    .postcard-option input:checked + .postcard-card-visual { border-color: #e53935; background-color: #fff5f5; box-shadow: 0 2px 8px rgba(229, 57, 53, 0.2); }

    /* –ò—Ç–æ–≥–æ */
    .order-summary-box { background: #f9f9f9; padding: 20px; border-radius: 8px; position: sticky; top: 20px; border: 1px solid #ddd; }
    .summary-items { list-style: none; padding: 0; margin: 0 0 15px 0; font-size: 0.9em; color: #555; }
    .summary-items li { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1em; }
    .summary-total { display: flex; justify-content: space-between; font-size: 1.5em; font-weight: bold; margin-top: 15px; color: #e53935; }
    .btn-block { width: 100%; padding: 15px; font-size: 1.1em; margin-top: 15px; }

    @media (max-width: 768px) {
        .order-grid { grid-template-columns: 1fr; }
        .order-summary-box { position: static; }
        .form-row-smart { display: flex; gap: 15px; }
        .form-row-smart .form-group { flex: 1; }
    }
</style>

<script>
    const cartTotal = {{ cart_total_js|stringformat:".0f" }};
    const deliveryCostBase = {{ delivery_cost_js|stringformat:".0f" }};
    let currentDeliveryCost = deliveryCostBase;
    let currentPostcardPrice = 0;

    const addressFields = document.getElementById('address-fields');
    const deliveryRow = document.getElementById('delivery-row');
    const deliveryPriceDisplay = document.getElementById('delivery-price-display');
    const postcardRow = document.getElementById('postcard-row');
    const postcardPriceDisplay = document.getElementById('postcard-price-display');
    const finalTotalDisplay = document.getElementById('final-total');
    const postcardTextGroup = document.getElementById('postcard-text-group');
    const customImageUpload = document.getElementById('custom-image-upload');
    const otherRecipientFields = document.getElementById('other-recipient-fields');

    // 1. –î–æ—Å—Ç–∞–≤–∫–∞
    document.querySelectorAll('input[name="delivery_option"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'pickup') {
                addressFields.style.display = 'none';
                deliveryRow.style.display = 'none';
                currentDeliveryCost = 0;
            } else {
                addressFields.style.display = 'block';
                deliveryRow.style.display = 'flex';
                currentDeliveryCost = deliveryCostBase;
            }
            recalcTotal();
        });
    });

    // 2. –ü–æ–ª—É—á–∞—Ç–µ–ª—å
    function toggleRecipient(radio) {
        if (radio.value === 'other') {
            otherRecipientFields.style.display = 'block';
        } else {
            otherRecipientFields.style.display = 'none';
            // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–ª–∏? –ú–æ–∂–Ω–æ, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.
        }
    }

    // 3. –û—Ç–∫—Ä—ã—Ç–∫–∏
    function handlePostcardChange(input) {
        const price = parseInt(input.getAttribute('data-price')) || 0;
        currentPostcardPrice = price;

        if (input.value === "") {
            postcardTextGroup.style.display = 'none';
            customImageUpload.style.display = 'none';
            document.querySelector('#id_postcard_text').value = '';
        } else if (input.value === "custom") {
            postcardTextGroup.style.display = 'block';
            customImageUpload.style.display = 'block';
        } else {
            postcardTextGroup.style.display = 'block';
            customImageUpload.style.display = 'none';
        }

        if (price > 0) {
            postcardRow.style.display = 'flex';
            postcardPriceDisplay.innerText = price + ' ‚ÇΩ';
        } else {
            postcardRow.style.display = 'none';
        }
        recalcTotal();
    }

    function recalcTotal() {
        const total = cartTotal + currentDeliveryCost + currentPostcardPrice;
        finalTotalDisplay.innerText = total + ' ‚ÇΩ';
    }

    recalcTotal();
</script>
{% endblock %}