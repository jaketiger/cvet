<!-- orders/templates/orders/create.html -->
{% extends "base.html" %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞{% endblock %}

{% block content %}
<div class="checkout-container">
    <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>

    <!-- –ë–ª–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ -->
    <div class="order-info">
        <h3>–í–∞—à –∑–∞–∫–∞–∑</h3>
        <ul>
            {% for item in cart %}
                <li>
                    <span class="item-name">{{ item.quantity }}x {{ item.product.name }}</span>
                    <span class="item-price">{{ item.total_price }} —Ä—É–±.</span>
                </li>
            {% endfor %}
        </ul>
        <div class="order-total">
            –°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤: <span>{{ cart.get_total_price }} —Ä—É–±.</span>
        </div>
    </div>

    <form method="post" class="order-form">
        {% csrf_token %}

        <!-- –ë–ª–æ–∫ 1: –°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è -->
        <div class="section-block">
            <h3>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</h3>
            <div class="delivery-options">
                <label class="radio-card">
                    <input type="radio" name="delivery_option" value="delivery" id="id_delivery_option_0" {% if form.delivery_option.value == 'delivery' or not form.delivery_option.value %}checked{% endif %}>
                    <span class="radio-label">
                        <span class="radio-title">–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É</span>
                        <span class="radio-desc">+{{ delivery_cost_js }} —Ä—É–±.</span>
                    </span>
                </label>
                <label class="radio-card">
                    <input type="radio" name="delivery_option" value="pickup" id="id_delivery_option_1" {% if form.delivery_option.value == 'pickup' %}checked{% endif %}>
                    <span class="radio-label">
                        <span class="radio-title">–°–∞–º–æ–≤—ã–≤–æ–∑</span>
                        <span class="radio-desc">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                    </span>
                </label>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ 2: –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
        <div class="section-block">
            <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
            <div class="form-row">
                <div class="form-group half-width">
                    <label for="{{ form.first_name.id_for_label }}">–ò–º—è</label>
                    {{ form.first_name }}
                </div>
                <div class="form-group half-width">
                    <label for="{{ form.last_name.id_for_label }}">–§–∞–º–∏–ª–∏—è</label>
                    {{ form.last_name }}
                </div>
            </div>
            <div class="form-group">
                <label for="{{ form.email.id_for_label }}">Email</label>
                {{ form.email }}
            </div>
            <div class="form-group">
                <label for="{{ form.phone.id_for_label }}">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                {{ form.phone }}
            </div>
        </div>

        <!-- –ë–ª–æ–∫ 3: –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (—Å–∫—Ä—ã–≤–∞–µ–º—ã–π) -->
        <div id="delivery-address-fields" class="section-block">
            <h3>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
            <div class="form-group">
                <label for="{{ form.address.id_for_label }}">–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞</label>
                {{ form.address }}
            </div>
            <div class="form-row">
                <div class="form-group half-width">
                    <label for="{{ form.postal_code.id_for_label }}">–ò–Ω–¥–µ–∫—Å</label>
                    {{ form.postal_code }}
                </div>
                <div class="form-group half-width">
                    <label for="{{ form.city.id_for_label }}">–ì–æ—Ä–æ–¥</label>
                    {{ form.city }}
                </div>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ 4: –ò–Ω—Ñ–æ –æ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ (—Å–∫—Ä—ã–≤–∞–µ–º—ã–π) -->
        <div id="pickup-info" class="info-box" style="display: none;">
            <h4>üìç –°–∞–º–æ–≤—ã–≤–æ–∑</h4>
            <p>–í—ã —Å–º–æ–∂–µ—Ç–µ –∑–∞–±—Ä–∞—Ç—å –∑–∞–∫–∞–∑ –≤ –Ω–∞—à–µ–º –º–∞–≥–∞–∑–∏–Ω–µ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.</p>
            <p>–û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ.</p>
            <a href="{% url 'shop:contacts' %}" target="_blank" class="info-link">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–¥—Ä–µ—Å –∏ –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã ‚Üí</a>
        </div>

        <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –∏ –∫–Ω–æ–ø–∫–∞ -->
        <div class="checkout-summary">
            <div id="delivery-cost-summary" class="summary-row">
                <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                <span id="delivery-cost-display">0.00</span> —Ä—É–±.
            </div>
            <div class="summary-row total">
                <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                <span><span id="total-cost-display"></span> —Ä—É–±.</span>
            </div>

            <button type="submit" class="btn-submit">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —à–∞–±–ª–æ–Ω–∞, –∑–∞–º–µ–Ω—è—è –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É –¥–ª—è JS
    const deliveryCost = parseFloat("{{ delivery_cost_js|stringformat:'f' }}".replace(',', '.'));
    const cartTotal = parseFloat("{{ cart_total_js|stringformat:'f' }}".replace(',', '.'));

    const deliveryOptionRadios = document.querySelectorAll('input[name="delivery_option"]');
    const deliveryAddressFields = document.getElementById('delivery-address-fields');
    const pickupInfo = document.getElementById('pickup-info');
    const totalCostDisplay = document.getElementById('total-cost-display');
    const deliveryCostDisplay = document.getElementById('delivery-cost-display');
    const deliveryCostSummary = document.getElementById('delivery-cost-summary');

    function updateOrderForm() {
        const selectedOption = document.querySelector('input[name="delivery_option"]:checked').value;

        if (selectedOption === 'delivery') {
            deliveryAddressFields.style.display = 'block';
            pickupInfo.style.display = 'none';
            deliveryCostSummary.style.display = 'flex'; // Flex –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è

            deliveryCostDisplay.textContent = deliveryCost.toFixed(2);
            totalCostDisplay.textContent = (cartTotal + deliveryCost).toFixed(2);

            // –î–µ–ª–∞–µ–º –ø–æ–ª—è –∞–¥—Ä–µ—Å–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏
            document.getElementById('{{ form.address.id_for_label }}').required = true;
        } else {
            deliveryAddressFields.style.display = 'none';
            pickupInfo.style.display = 'block';
            deliveryCostSummary.style.display = 'none';

            totalCostDisplay.textContent = cartTotal.toFixed(2);

            // –£–±–∏—Ä–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–µ–π –∞–¥—Ä–µ—Å–∞ –ø—Ä–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ
            document.getElementById('{{ form.address.id_for_label }}').required = false;
        }
    }

    deliveryOptionRadios.forEach(radio => radio.addEventListener('change', updateOrderForm));

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateOrderForm();
});
</script>

<style>
    /* --- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä --- */
    .checkout-container {
        max-width: 800px;
        margin: 0 auto;
        font-family: var(--body-font-family);
        color: var(--main-text-color);
    }

    h1 { text-align: center; margin-bottom: 30px; }
    h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-family: var(--heading-font-family); }

    /* --- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ --- */
    .order-info {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        border: 1px solid #eee;
    }
    .order-info ul { list-style: none; padding: 0; margin: 0; }
    .order-info li { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em; }
    .order-total { text-align: right; font-size: 1.1em; font-weight: bold; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc; }

    /* --- –ë–ª–æ–∫–∏ —Ñ–æ—Ä–º—ã --- */
    .section-block { margin-bottom: 30px; }

    /* --- –ü–æ–ª—è –≤–≤–æ–¥–∞ --- */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }

    /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∏–Ω–ø—É—Ç–æ–≤, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ */
    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="tel"] {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px;
        box-sizing: border-box; /* –í–∞–∂–Ω–æ: –≤–∫–ª—é—á–∞–µ—Ç padding –≤ —à–∏—Ä–∏–Ω—É */
        font-family: var(--body-font-family);
        transition: border-color 0.3s;
    }
    .form-group input:focus { border-color: var(--accent-color); outline: none; }

    /* --- –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫—É (–ò–º—è/–§–∞–º–∏–ª–∏—è) --- */
    .form-row { display: flex; gap: 20px; }
    .half-width { flex: 1; } /* –ö–∞–∂–¥–æ–µ –ø–æ–ª–µ –∑–∞–Ω–∏–º–∞–µ—Ç 50% –º–∏–Ω—É—Å –æ—Ç—Å—Ç—É–ø */

    /* --- –†–∞–¥–∏–æ –∫–Ω–æ–ø–∫–∏ (–≤—ã–±–æ—Ä –¥–æ—Å—Ç–∞–≤–∫–∏) --- */
    .delivery-options { display: flex; gap: 15px; flex-wrap: wrap; }
    .radio-card {
        flex: 1;
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 250px;
    }
    .radio-card:hover { border-color: var(--accent-color); background-color: #fffdfd; }
    .radio-card input { margin-right: 15px; accent-color: var(--accent-color); transform: scale(1.2); }
    .radio-label { display: flex; flex-direction: column; }
    .radio-title { font-weight: bold; font-size: 1.05em; }
    .radio-desc { font-size: 0.9em; color: #666; }

    /* --- –ò–Ω—Ñ–æ-–±–æ–∫—Å --- */
    .info-box { background-color: #e3f2fd; padding: 20px; border-radius: 8px; color: #0d47a1; }
    .info-link { color: #0d47a1; font-weight: bold; text-decoration: underline; }

    /* --- –ò—Ç–æ–≥–æ –∏ –∫–Ω–æ–ø–∫–∞ --- */
    .checkout-summary {
        background: #f8f8f8;
        padding: 25px;
        border-radius: 8px;
        margin-top: 30px;
    }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1em; }
    .summary-row.total { font-size: 1.4em; font-weight: bold; color: var(--accent-color); border-top: 2px solid #ddd; padding-top: 15px; margin-top: 15px; }

    .btn-submit {
        width: 100%;
        background-color: var(--accent-color);
        color: white;
        padding: 15px;
        font-size: 1.2em;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 20px;
        transition: opacity 0.3s;
        font-family: var(--heading-font-family);
    }
    .btn-submit:hover { opacity: 0.9; }

    /* –ê–¥–∞–ø—Ç–∏–≤ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-width: 600px) {
        .form-row { flex-direction: column; gap: 0; }
        .delivery-options { flex-direction: column; }
    }
</style>
{% endblock %}