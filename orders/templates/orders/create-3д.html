<!-- orders/templates/orders/create.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞{% endblock %}

{% block content %}
<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js"></script>

<!-- Swiper -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

<div class="checkout-page-wrapper fade-in">

    <div class="checkout-header">
        <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
    </div>

    {% if form.errors %}
        <div class="error-banner">
            <div class="error-icon">‚ö†Ô∏è</div>
            <div class="error-content">
                <h4>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ:</h4>
                <ul>
                {% for field in form %}
                    {% if field.errors %}
                        <li><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</li>
                    {% endif %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}

    <form action="." method="post" class="checkout-form" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="checkout-grid">

            <!-- === –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê === -->
            <div class="form-column">

                <!-- 1. –î–û–°–¢–ê–í–ö–ê -->
                <section class="checkout-section">
                    <div class="section-head">
                        <div class="step-badge">1</div>
                        <h2>–î–æ—Å—Ç–∞–≤–∫–∞ –∏ –í—Ä–µ–º—è</h2>
                    </div>

                    <div class="delivery-toggle-group">
                        {% for radio in form.delivery_option %}
                            <label class="delivery-card" for="{{ radio.id_for_label }}">
                                {{ radio.tag }}
                                <div class="delivery-content">
                                    <div class="icon-circle">
                                        {% if 'delivery' in radio.choice_value %}üöö{% else %}üè™{% endif %}
                                    </div>
                                    <span class="radio-title">{{ radio.choice_label }}</span>
                                </div>
                                <div class="check-mark"></div>
                            </label>
                        {% endfor %}
                    </div>

                    <div id="delivery-fields" class="dynamic-block">
                        <div class="input-grid-2">
                            <div class="input-box">
                                <label>–ì–æ—Ä–æ–¥</label>
                                {{ form.city }}
                            </div>
                            <div class="input-box">
                                <label>–£–ª–∏—Ü–∞, –¥–æ–º</label>
                                {{ form.address }}
                            </div>
                        </div>
                        <div style="display:none;">{{ form.postal_code }}</div>
                    </div>

                    <div class="datetime-wrapper" id="datetime-block">
                        <div class="dt-header">
                            <label>–ö–æ–≥–¥–∞ –¥–æ—Å—Ç–∞–≤–∏—Ç—å?</label>
                            <!-- –ö–ù–û–ü–ö–ò-–°–°–´–õ–ö–ò -->
                            <div class="dt-presets">
                                <a href="javascript:void(0)" class="date-link" onclick="setToday()">–°–µ–≥–æ–¥–Ω—è</a>
                                <a href="javascript:void(0)" class="date-link" onclick="setTomorrow()">–ó–∞–≤—Ç—Ä–∞</a>
                            </div>
                        </div>

                        <div class="datetime-grid">
                            <div class="input-box date-input-box">
                                <label>–î–∞—Ç–∞</label>
                                <div class="date-input-wrapper">
                                    {{ form.delivery_date }}
                                    <span class="calendar-icon">üìÖ</span>
                                </div>
                            </div>
                            <div class="input-box time-input-box">
                                <label>–í—Ä–µ–º—è</label>
                                {{ form.delivery_time }}
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 2. –ü–û–õ–£–ß–ê–¢–ï–õ–¨ -->
                <section class="checkout-section" id="recipient-section">
                    <div class="section-head">
                        <div class="step-badge">2</div>
                        <h2>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</h2>
                    </div>

                    <div class="recipient-switcher">
                        <label class="switch-option">
                            <input type="radio" name="recipient_who" value="me" checked onchange="toggleRecipient(this)">
                            <span>–Ø –ø–æ–ª—É—á—É —Å–∞–º</span>
                        </label>
                        <label class="switch-option">
                            <input type="radio" name="recipient_who" value="other" onchange="toggleRecipient(this)">
                            <span>–î—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫</span>
                        </label>
                    </div>

                    <div id="recipient-fields" class="dynamic-block" style="display: none;">
                        <div class="info-alert">
                            ü§´ –ú—ã –Ω–µ —Å–æ–æ–±—â–∏–º –ø–æ–ª—É—á–∞—Ç–µ–ª—é –æ –∑–∞–∫–∞–∑—á–∏–∫–µ –¥–æ –≤—Ä—É—á–µ–Ω–∏—è.
                        </div>
                        <div class="input-grid-2">
                            <div class="input-box">
                                <label>–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                                {{ form.recipient_name }}
                            </div>
                            <div class="input-box">
                                <label>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                                {{ form.recipient_phone }}
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 3. –û–¢–ö–†–´–¢–ö–ê (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ö–ê–†–£–°–ï–õ–¨) -->
                <section class="checkout-section postcard-section-wrapper">
                    <div class="section-head">
                        <div class="step-badge">3</div>
                        <h2>–û—Ç–∫—Ä—ã—Ç–∫–∞ –∫ –±—É–∫–µ—Ç—É</h2>
                    </div>

                    <div class="swiper-container-wrapper">
                        <!-- –°—Ç—Ä–µ–ª–∫–∞ –í–ª–µ–≤–æ -->
                        <div class="swiper-button-prev custom-nav">
                            <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
                        </div>

                        <div class="swiper postcard-swiper">
                            <div class="swiper-wrapper">

                                <!-- 1. –ë–µ–∑ –æ—Ç–∫—Ä—ã—Ç–∫–∏ -->
                                <div class="swiper-slide">
                                    <label class="postcard-slide-content">
                                        <input type="radio" name="postcard" value="" data-price="0" checked onchange="handlePostcardChange(this)">
                                        <div class="pc-visual">
                                            <div class="pc-emoji">üö´</div>
                                            <span class="pc-name">–ë–µ–∑ –æ—Ç–∫—Ä—ã—Ç–∫–∏</span>
                                            <span class="pc-price-tag">0 ‚ÇΩ</span>
                                        </div>
                                    </label>
                                </div>

                                <!-- 2. –°–≤–æ—ë —Ñ–æ—Ç–æ -->
                                <div class="swiper-slide">
                                    <label class="postcard-slide-content">
                                        <input type="radio" name="postcard" value="custom" data-price="0" onchange="handlePostcardChange(this)">
                                        <div class="pc-visual">
                                            <div class="pc-emoji">üì∏</div>
                                            <span class="pc-name">–°–≤–æ—ë —Ñ–æ—Ç–æ</span>
                                            <span class="pc-price-tag">0 ‚ÇΩ</span>
                                        </div>
                                    </label>
                                </div>

                                <!-- 3+. –û—Ç–∫—Ä—ã—Ç–∫–∏ –∏–∑ –±–∞–∑—ã -->
                                {% for card in postcards %}
                                <div class="swiper-slide">
                                    <label class="postcard-slide-content">
                                        <input type="radio" name="postcard" value="{{ card.id }}" data-price="{{ card.price|stringformat:'.0f' }}" onchange="handlePostcardChange(this)">
                                        <div class="pc-visual">
                                            {% if card.image %}
                                                <img src="{{ card.image.url }}" alt="{{ card.title }}">
                                            {% else %}
                                                <div class="pc-emoji">üíå</div>
                                            {% endif %}
                                            <span class="pc-name">{{ card.title }}</span>
                                            <span class="pc-price-tag">
                                                {% if card.price > 0 %}+{{ card.price }}‚ÇΩ{% else %}–ë–µ—Å–ø–ª–∞—Ç–Ω–æ{% endif %}
                                            </span>
                                        </div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- –°—Ç—Ä–µ–ª–∫–∞ –í–ø—Ä–∞–≤–æ -->
                        <div class="swiper-button-next custom-nav">
                            <svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
                        </div>
                    </div>

                    <div id="postcard-extras" class="dynamic-block" style="display: none; margin-top: 20px;">
                        <div id="custom-upload-field" style="display: none; margin-bottom: 15px;">
                            <div class="input-box">
                                <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</label>
                                {{ form.custom_postcard_image }}
                            </div>
                        </div>
                        <div class="input-box">
                            <label>–¢–µ–∫—Å—Ç –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è:</label>
                            {{ form.postcard_text }}
                        </div>
                    </div>
                </section>

                <!-- 4. –ö–û–ù–¢–ê–ö–¢–´ -->
                <section class="checkout-section">
                    <div class="section-head">
                        <div class="step-badge">4</div>
                        <h2>–í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã</h2>
                    </div>
                    <div class="input-grid-2">
                        <div class="input-box">
                            <label>–í–∞—à–µ –ò–º—è</label>
                            {{ form.first_name }}
                        </div>
                        <div class="input-box">
                            <label>–í–∞—à –¢–µ–ª–µ—Ñ–æ–Ω</label>
                            {{ form.phone }}
                        </div>
                    </div>
                    <div class="input-box" style="margin-top: 15px;">
                        <label>Email (–¥–ª—è —á–µ–∫–∞)</label>
                        {{ form.email }}
                    </div>
                    <div style="display:none;">{{ form.last_name }}</div>
                </section>

            </div>

            <!-- === –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê === -->
            <div class="sidebar-column">
                <div class="order-summary-card sticky-block">
                    <div class="summary-header-bg">
                        <h3>–í–∞—à –∑–∞–∫–∞–∑</h3>
                    </div>

                    <div class="summary-body">
                        <div class="cart-items-mini">
                            {% for item in cart %}
                            <a href="{{ item.product.get_absolute_url }}" class="mini-item">
                                <div class="mi-thumb">
                                    {% if item.product.image %}
                                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                                    {% else %}
                                        <span style="font-size: 20px;">üå∏</span>
                                    {% endif %}
                                </div>
                                <div class="mi-info">
                                    <div class="mi-name">{{ item.product.name }}</div>
                                    <div class="mi-qty">{{ item.quantity }} —à—Ç.</div>
                                </div>
                                <div class="mi-price">{{ item.total_price }} ‚ÇΩ</div>
                            </a>
                            {% endfor %}
                        </div>

                        <div class="summary-divider"></div>

                        <div class="summary-row">
                            <span>–¢–æ–≤–∞—Ä—ã</span>
                            <span>{{ cart_total_js }} ‚ÇΩ</span>
                        </div>
                        <div class="summary-row" id="delivery-row">
                            <span>–î–æ—Å—Ç–∞–≤–∫–∞</span>
                            <span id="delivery-price-display">{{ delivery_cost_js }} ‚ÇΩ</span>
                        </div>
                        <div class="summary-row highlight" id="postcard-row" style="display: none;">
                            <span>–û—Ç–∫—Ä—ã—Ç–∫–∞</span>
                            <span id="postcard-price-display">0 ‚ÇΩ</span>
                        </div>

                        <div class="summary-divider dashed"></div>

                        <div class="grand-total">
                            <span>–ò—Ç–æ–≥–æ:</span>
                            <span id="final-total-display" class="total-val">0 ‚ÇΩ</span>
                        </div>

                        <!-- –ö–ù–û–ü–ö–ê (–ï–î–ò–ù–ê–Ø –î–õ–Ø –í–°–ï–•) -->
                        <button type="submit" class="btn-checkout">
                            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>

                        <p class="policy-text">
                            –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –æ—Ñ–µ—Ä—Ç—ã.
                        </p>
                    </div>
                </div>
            </div>

        </div>
    </form>
</div>

<!-- ================== –°–¢–ò–õ–ò CSS ================== -->
<style>
    :root {
        --card-bg: #ffffff;
        --input-bg: #f9f9f9;
        --border-color: #eee;
        --primary: var(--accent-color, #e53935);
        --text-main: #333;
        --radius: 16px;
    }

    .checkout-page-wrapper * { box-sizing: border-box; }

    .checkout-page-wrapper {
        max-width: 1200px; margin: 0 auto; padding: 20px;
        font-family: var(--default-font-family, sans-serif);
        padding-bottom: 120px;
    }
    .checkout-header { text-align: center; margin-bottom: 30px; }
    .checkout-header h1 { font-size: 1.8rem; margin: 0; font-weight: 800; color: var(--text-main); }

    .fade-in { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* –°–ï–¢–ö–ê */
    .checkout-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 30px;
        align-items: start;
    }
    .form-column { min-width: 0; }
    .sidebar-column { position: sticky; top: 20px; min-width: 0; }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
    .checkout-section {
        background: var(--card-bg); padding: 25px; border-radius: var(--radius);
        margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid var(--border-color);
    }
    .section-head { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .step-badge {
        width: 30px; height: 30px; background: var(--primary); color: #fff;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-weight: bold; font-size: 0.9rem; box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    .section-head h2 { margin: 0; font-size: 1.2rem; font-weight: 700; }

    /* –ò–Ω–ø—É—Ç—ã */
    .input-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .datetime-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .input-box { width: 100%; margin-bottom: 15px; }
    .input-box label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 6px; color: #555; }
    .input-box input, .input-box select, .input-box textarea {
        width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid #e0e0e0;
        font-size: 0.95rem; background: var(--input-bg); transition: 0.2s;
    }
    .input-box input:focus, .input-box textarea:focus {
        border-color: var(--primary); background: #fff; outline: none; box-shadow: 0 0 0 3px rgba(229, 57, 53, 0.1);
    }

    .date-input-wrapper { position: relative; }
    .calendar-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); pointer-events: none; opacity: 0.5; font-size: 1.1rem; }
    .datepicker-input { background: #fff !important; cursor: pointer; padding-right: 40px !important; }

    /* –°–°–´–õ–ö–ò –î–ê–¢–´ (–ù–æ–≤—ã–π —Å—Ç–∏–ª—å) */
    .dt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .dt-presets { display: flex; gap: 15px; }
    .date-link {
        text-decoration: none;
        font-weight: 700;
        font-size: 0.9rem;
        color: var(--primary);
        border-bottom: 2px solid transparent;
        transition: 0.2s;
    }
    .date-link:hover {
        border-bottom-color: var(--primary);
        opacity: 0.8;
    }

    /* –î–æ—Å—Ç–∞–≤–∫–∞ */
    .delivery-toggle-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
    .delivery-card, .switch-option { cursor: pointer; position: relative; width: 100%; }
    .delivery-card input, .switch-option input { display: none; }

    .delivery-content, .recipient-switcher {
        border: 2px solid #f0f0f0; border-radius: 12px; padding: 15px;
        display: flex; align-items: center; gap: 12px; transition: 0.2s;
    }
    .recipient-switcher { background: #f0f0f0; padding: 4px; margin-bottom: 15px; border: none; }
    .switch-option span {
        display: block; text-align: center; padding: 10px; border-radius: 8px;
        font-weight: 600; color: #777; transition: 0.2s; font-size: 0.9rem;
    }
    .switch-option input:checked + span { background: #fff; color: #333; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .icon-circle { width: 36px; height: 36px; background: #f5f5f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
    .radio-title { font-weight: 600; font-size: 0.95rem; color: #555; }
    .check-mark { position: absolute; top: 15px; right: 15px; width: 10px; height: 10px; border-radius: 50%; background: #ddd; transition: 0.2s; }
    .delivery-card input:checked + .delivery-content { border-color: var(--primary); background: #fff5f5; }
    .delivery-card input:checked ~ .check-mark { background: var(--primary); box-shadow: 0 0 0 2px #fff, 0 0 0 3px var(--primary); }
    .info-alert { background: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 0.85rem; }

    /* === –ö–ê–†–£–°–ï–õ–¨ SWIPER === */
    .swiper-container-wrapper {
        position: relative;
        padding: 0 40px;
        overflow: hidden;
    }

    .postcard-swiper {
        width: 100%;
        height: 240px;
        padding: 20px 0;
        overflow: visible;
    }

    .swiper-slide {
        width: 140px !important;
        height: 180px;
        border-radius: 16px;
        transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        transform-style: preserve-3d;
        flex-shrink: 0;
        transform-origin: center center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition-property: transform, opacity, filter, z-index;
    }

    .postcard-slide-content {
        display: block;
        width: 100%;
        height: 100%;
        cursor: pointer;
        position: relative;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    .postcard-slide-content input { display: none; }

    .pc-visual {
        width: 100%;
        height: 100%;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border: 2px solid transparent;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px;
        box-sizing: border-box;
        transition: 0.4s ease;
        position: relative;
        overflow: hidden;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    .pc-visual::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary), #ff6b6b);
        transform: scaleX(0);
        transition: 0.3s ease;
    }
    .swiper-slide-active .pc-visual::before { transform: scaleX(1); }

    .pc-emoji { font-size: 2.5rem; margin-bottom: 10px; transition: 0.3s; }
    .swiper-slide-active .pc-emoji { transform: scale(1.2); }
    .pc-visual img { width: 100%; height: 80px; object-fit: cover; margin-bottom: 10px; border-radius: 8px; transition: 0.3s; }
    .swiper-slide-active .pc-visual img { transform: scale(1.05); }

    .pc-name { font-size: 0.85rem; font-weight: 700; color: #333; margin-bottom: 5px; text-align: center; line-height: 1.1; height: 30px; display: flex; align-items: center; justify-content: center; transition: color 0.3s; }
    .swiper-slide-active .pc-name { color: var(--primary); }
    .pc-price-tag { background: #7e57c2; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.75rem; font-weight: 700; transition: 0.3s; }
    .swiper-slide-active .pc-price-tag { transform: scale(1.1); box-shadow: 0 4px 12px rgba(126, 87, 194, 0.4); }

    .postcard-slide-content input:checked + .pc-visual {
        border-color: var(--primary);
        box-shadow: 0 12px 35px rgba(229, 57, 53, 0.25);
        transform: translateY(-5px);
    }

    /* –°—Ç—Ä–µ–ª–∫–∏ */
    .custom-nav {
        position: absolute;
        top: 50%;
        margin-top: -20px;
        width: 36px;
        height: 36px;
        background: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
        cursor: pointer;
        transition: 0.3s;
        box-shadow: 0 4px 12px rgba(229, 57, 53, 0.3);
        z-index: 10;
    }
    .custom-nav svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; }
    .custom-nav:hover { transform: scale(1.1); background: #d32f2f; color: #fff; }
    .swiper-button-prev { left: 0; }
    .swiper-button-next { right: 0; }

    /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
    .order-summary-card { background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; }
    .summary-header-bg { background: #f8f9fa; padding: 20px; border-bottom: 1px solid #eee; }
    .summary-header-bg h3 { margin: 0; font-size: 1.2rem; font-weight: 800; color: #222; }
    .summary-body { padding: 20px; }

    .cart-items-mini { margin-bottom: 20px; max-height: 350px; overflow-y: auto; }
    .mini-item { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f5f5f5; text-decoration: none; transition: background 0.2s; border-radius: 8px; }
    .mini-item:hover { background: #fafafa; }
    .mi-thumb { width: 55px; height: 55px; border-radius: 10px; overflow: hidden; background: #f4f4f4; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .mi-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .mi-info { flex: 1; }
    .mi-name { font-size: 0.9rem; font-weight: 600; line-height: 1.3; color: #333; margin-bottom: 2px; }
    .mi-qty { font-size: 0.8rem; color: #888; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; }
    .mi-price { font-weight: 700; font-size: 0.95rem; color: #333; }

    .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; color: #666; }
    .summary-row.highlight { color: #28a745; font-weight: 600; }
    .summary-divider { height: 1px; background: #eee; margin: 15px 0; }
    .summary-divider.dashed { border-top: 1px dashed #ccc; background: none; }
    .grand-total { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; font-size: 1.4rem; font-weight: 800; color: var(--text-main); }
    .btn-checkout { width: 100%; padding: 16px; margin-top: 20px; border-radius: 12px; border: none; background: var(--primary); color: #fff; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
    .btn-checkout:hover { opacity: 0.9; transform: translateY(-2px); }
    .policy-text { text-align: center; font-size: 0.75rem; color: #999; margin-top: 15px; line-height: 1.4; }

    /* –ë–∞–Ω–Ω–µ—Ä –æ—à–∏–±–æ–∫ */
    .error-banner {
        background: #ffebee;
        border: 1px solid #ffcdd2;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        display: flex;
        gap: 15px;
        align-items: flex-start;
    }
    .error-icon { font-size: 1.5rem; flex-shrink: 0; }
    .error-content h4 { margin: 0 0 10px 0; color: #c62828; font-size: 1rem; }
    .error-content ul { margin: 0; padding-left: 20px; }
    .error-content li { color: #d32f2f; margin-bottom: 5px; font-size: 0.9rem; }

    /* === –ê–î–ê–ü–¢–ê–¶–ò–Ø === */
    @media (max-width: 1024px) {
        .checkout-grid { grid-template-columns: 1fr; gap: 30px; }
        .sidebar-column { position: static; order: 2; }
        .form-column { order: 1; }

        /* –ü–ª–∞–Ω—à–µ—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–∞—Ä—É—Å–µ–ª–∏ */
        .swiper-container-wrapper {
            padding: 0 50px;
        }
        .postcard-swiper {
            height: 200px;
        }
        .swiper-slide {
            width: 120px !important;
            height: 150px;
        }
        .pc-emoji { font-size: 2rem; }
        .pc-visual img { height: 60px; }
        .pc-name { font-size: 0.75rem; height: 28px; }
        .pc-price-tag { font-size: 0.7rem; }

        /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–∞ */
        .custom-nav {
            width: 42px;
            height: 42px;
            margin-top: -21px;
        }
        .custom-nav svg { width: 22px; height: 22px; }
    }

    @media (max-width: 768px) {
        .checkout-page-wrapper { padding: 15px 10px 140px 10px; }
        .input-grid-2, .datetime-grid, .delivery-toggle-group { grid-template-columns: 1fr; gap: 10px; }

        /* –ö–∞—Ä—É—Å–µ–ª—å –º–æ–±–∏–ª—å–Ω–∞—è */
        .swiper-container-wrapper { padding: 0 25px; }
        .custom-nav { width: 28px !important; height: 28px !important; margin-top: -14px; background: rgba(255,255,255,0.9); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .custom-nav svg { width: 14px; height: 14px; }
        .swiper-button-prev { left: -5px !important; }
        .swiper-button-next { right: -5px !important; }

        .postcard-swiper { height: 160px; padding: 10px 0; }
        .swiper-slide { width: 85px !important; height: 120px; }
        .pc-visual { padding: 5px; border-radius: 10px; }
        .pc-emoji { font-size: 1.6rem; margin-bottom: 5px; }
        .pc-visual img { height: 45px; margin-bottom: 5px; }
        .pc-name { font-size: 0.65rem; height: 22px; }
        .pc-price-tag { font-size: 0.6rem; padding: 2px 6px; }

        /* –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .postcard-slide-content:active,
        .postcard-slide-content:focus {
            background: transparent;
            outline: none;
        }
        .pc-visual:active,
        .pc-visual:focus {
            background: #fff;
            outline: none;
        }
    }

    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ—á–µ–Ω—å —à–∏—Ä–æ–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    @media (min-width: 1440px) {
        .swiper-container-wrapper {
            padding: 0 60px;
        }
        .custom-nav {
            width: 44px;
            height: 44px;
        }
        .custom-nav svg { width: 24px; height: 24px; }
    }
</style>

<script>
    const cartTotal = {{ cart_total_js|stringformat:".0f" }};
    const deliveryCostBase = {{ delivery_cost_js|stringformat:".0f" }};
    let currentDeliveryCost = deliveryCostBase;
    let currentPostcardPrice = 0;

    const deliveryFields = document.getElementById('delivery-fields');
    const datetimeBlock = document.getElementById('datetime-block');
    const deliveryRow = document.getElementById('delivery-row');
    const deliveryPriceDisplay = document.getElementById('delivery-price-display');
    const postcardRow = document.getElementById('postcard-row');
    const postcardPriceDisplay = document.getElementById('postcard-price-display');
    const finalTotalDisplay = document.getElementById('final-total-display');

    const postcardExtras = document.getElementById('postcard-extras');
    const customUpload = document.getElementById('custom-upload-field');
    const textInput = document.querySelector('#id_postcard_text');
    const recipientFields = document.getElementById('recipient-fields');

    // 1. –î–æ—Å—Ç–∞–≤–∫–∞
    document.querySelectorAll('input[name="delivery_option"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'pickup') {
                deliveryFields.style.display = 'none';
                datetimeBlock.style.display = 'none';
                deliveryRow.style.display = 'none';
                currentDeliveryCost = 0;
            } else {
                deliveryFields.style.display = 'block';
                datetimeBlock.style.display = 'block';
                deliveryRow.style.display = 'flex';
                currentDeliveryCost = deliveryCostBase;
            }
            recalcTotal();
        });
    });

    function toggleRecipient(radio) {
        recipientFields.style.display = (radio.value === 'other') ? 'block' : 'none';
    }

    function handlePostcardChange(input) {
        const price = parseInt(input.getAttribute('data-price')) || 0;
        currentPostcardPrice = price;

        if (input.value === "") {
            postcardExtras.style.display = 'none';
            textInput.value = '';
        } else {
            postcardExtras.style.display = 'block';
            customUpload.style.display = (input.value === "custom") ? 'block' : 'none';
        }

        if (price > 0) {
            postcardRow.style.display = 'flex';
            postcardPriceDisplay.innerText = '+' + price + ' ‚ÇΩ';
        } else {
            postcardRow.style.display = 'none';
        }
        recalcTotal();
    }

    function recalcTotal() {
        const total = cartTotal + currentDeliveryCost + currentPostcardPrice;
        if(finalTotalDisplay) finalTotalDisplay.innerText = total + ' ‚ÇΩ';
    }

    let fpInstance;
    let swiper;
    let isAnimating = false;

    document.addEventListener('DOMContentLoaded', function() {
        recalcTotal();

        const activeDelivery = document.querySelector('input[name="delivery_option"]:checked');
        if(activeDelivery && activeDelivery.value === 'pickup') {
             deliveryFields.style.display = 'none';
             datetimeBlock.style.display = 'none';
             deliveryRow.style.display = 'none';
             currentDeliveryCost = 0;
             recalcTotal();
        }

        fpInstance = flatpickr(".datepicker-input", {
            locale: "ru",
            minDate: "today",
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "j F Y",
            disableMobile: "true",
            allowInput: true
        });

        function initSwiper() {
            const isMobile = window.innerWidth <= 768;
            const isTablet = window.innerWidth <= 1024 && window.innerWidth > 768;

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            let spaceBetween, slidesOffsetAfter, slidesOffsetBefore;

            if (isMobile) {
                spaceBetween = -25;
                slidesOffsetAfter = 200;
                slidesOffsetBefore = 30;
            } else if (isTablet) {
                // –ü–ª–∞–Ω—à–µ—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ - –±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏
                spaceBetween = -40;
                slidesOffsetAfter = 400; // –ë–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ–¥–Ω—è—è –∫–∞—Ä—Ç–æ—á–∫–∞ –±—ã–ª–∞ –æ–¥–Ω–∞
                slidesOffsetBefore = 50;
            } else {
                // –î–µ—Å–∫—Ç–æ–ø
                spaceBetween = -50;
                slidesOffsetAfter = 450;
                slidesOffsetBefore = 60;
            }

            if (swiper) {
                swiper.destroy(true, true);
            }

            swiper = new Swiper('.postcard-swiper', {
                slidesPerView: 'auto',
                centeredSlides: false,
                spaceBetween: spaceBetween,
                speed: 600,
                resistanceRatio: 0.7,
                freeMode: false,
                watchSlidesProgress: true,

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—Å—Ç—É–ø–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                slidesOffsetAfter: slidesOffsetAfter,
                slidesOffsetBefore: slidesOffsetBefore,

                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                on: {
                    init: function () {
                        const checkedInput = document.querySelector('.postcard-slide-content input:checked');
                        if(checkedInput) handlePostcardChange(checkedInput);
                        updateCardStyles(this, true);
                    },
                    slideChangeTransitionStart: function () {
                        isAnimating = true;
                        updateCardStyles(this, false);
                    },
                    slideChangeTransitionEnd: function () {
                        isAnimating = false;
                        updateCardStyles(this, true);
                        const activeSlide = this.slides[this.activeIndex];
                        const input = activeSlide.querySelector('input[type="radio"]');
                        if(input && !input.checked) {
                            input.checked = true;
                            handlePostcardChange(input);
                        }
                    },
                    transitionStart: function () {
                        isAnimating = true;
                        updateCardStyles(this, false);
                    },
                    transitionEnd: function () {
                        isAnimating = false;
                        updateCardStyles(this, true);
                    },
                    touchMove: function () {
                        if (!isAnimating) {
                            updateCardStyles(this, false);
                        }
                    },
                    progress: function () {
                        if (!isAnimating) {
                            updateCardStyles(this, false);
                        }
                    },
                    // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É "–≤–ø–µ—Ä–µ–¥" –∫–æ–≥–¥–∞ –¥–æ—Å—Ç–∏–≥–ª–∏ –∫–æ–Ω—Ü–∞
                    reachEnd: function () {
                        const nextButton = document.querySelector('.swiper-button-next');
                        if (nextButton) {
                            nextButton.style.opacity = '0.3';
                            nextButton.style.pointerEvents = 'none';
                        }
                    },
                    fromEdge: function () {
                        const nextButton = document.querySelector('.swiper-button-next');
                        if (nextButton) {
                            nextButton.style.opacity = '1';
                            nextButton.style.pointerEvents = 'auto';
                        }
                    }
                }
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç—Ä–µ–ª–æ–∫
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            if (!swiper) return;

            const prevButton = document.querySelector('.swiper-button-prev');
            const nextButton = document.querySelector('.swiper-button-next');

            if (prevButton) {
                prevButton.style.opacity = swiper.isBeginning ? '0.3' : '1';
                prevButton.style.pointerEvents = swiper.isBeginning ? 'none' : 'auto';
            }
            if (nextButton) {
                nextButton.style.opacity = swiper.isEnd ? '0.3' : '1';
                nextButton.style.pointerEvents = swiper.isEnd ? 'none' : 'auto';
            }
        }

        function updateCardStyles(swiperInstance, isFinalState = false) {
            const slides = swiperInstance.slides;
            const activeIndex = swiperInstance.activeIndex;
            const totalSlides = slides.length;
            const isMob = window.innerWidth <= 768;
            const isTablet = window.innerWidth <= 1024 && window.innerWidth > 768;

            // –†–∞–∑–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            let overlapAmount, scaleStep, opacityStep;

            if (isMob) {
                overlapAmount = 35;
                scaleStep = 0.06;
                opacityStep = 0.15;
            } else if (isTablet) {
                // –ü–ª–∞–Ω—à–µ—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                overlapAmount = 45;
                scaleStep = 0.07;
                opacityStep = 0.13;
            } else {
                overlapAmount = 55;
                scaleStep = 0.08;
                opacityStep = 0.12;
            }

            const progress = swiperInstance.progress;
            const isGoingBack = swiperInstance.touchDirection === 'prev';
            const isLastSlide = activeIndex === totalSlides - 1;

            slides.forEach((slide, index) => {
                const diff = index - activeIndex;

                // –û—Å–æ–±—ã–π —Å–ª—É—á–∞–π –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ
                if (isTablet && isLastSlide && index === activeIndex) {
                    // –ü–æ—Å–ª–µ–¥–Ω—è—è –∫–∞—Ä—Ç–æ—á–∫–∞ - –∞–∫—Ç–∏–≤–Ω–∞—è –∏ –æ–¥–Ω–∞
                    slide.style.transform = 'translateX(0) scale(1)';
                    slide.style.zIndex = '100';
                    slide.style.opacity = '1';
                    slide.style.filter = 'none';
                }
                else if (diff < 0) {
                    // –≠–§–§–ï–ö–¢ "–ü–û–î–õ–ï–ó–ê–ù–ò–Ø" –°–õ–ï–í–ê
                    if (diff === -1) {
                        const baseTranslateX = overlapAmount;
                        const baseScale = 1 - scaleStep;
                        const baseOpacity = 1 - opacityStep;

                        let translateX = baseTranslateX;
                        let scale = baseScale;
                        let opacity = baseOpacity;

                        if (!isFinalState && isGoingBack && index === activeIndex - 1) {
                            const transitionProgress = 1 - Math.abs(swiperInstance.translate / swiperInstance.width);
                            translateX = baseTranslateX * (1 - transitionProgress * 0.3);
                            scale = 1 - (scaleStep * (1 - transitionProgress * 0.5));
                            opacity = 1 - (opacityStep * (1 - transitionProgress * 0.5));
                        }

                        slide.style.transform = `translateX(${translateX}px) scale(${scale})`;
                        slide.style.zIndex = '40';
                        slide.style.opacity = opacity.toString();
                        slide.style.filter = 'brightness(0.95)';
                    } else if (diff === -2) {
                        const baseTranslateX = overlapAmount * 0.8;
                        const baseScale = 1 - (scaleStep * 1.5);
                        const baseOpacity = 1 - (opacityStep * 1.5);

                        let translateX = baseTranslateX;
                        let scale = baseScale;
                        let opacity = baseOpacity;

                        if (!isFinalState && isGoingBack && index === activeIndex - 2) {
                            const transitionProgress = 1 - Math.abs(swiperInstance.translate / swiperInstance.width);
                            translateX = baseTranslateX * (1 - transitionProgress * 0.4);
                            scale = 1 - (scaleStep * 1.5 * (1 - transitionProgress * 0.6));
                            opacity = 1 - (opacityStep * 1.5 * (1 - transitionProgress * 0.6));
                        }

                        slide.style.transform = `translateX(${translateX}px) scale(${scale})`;
                        slide.style.zIndex = '30';
                        slide.style.opacity = opacity.toString();
                        slide.style.filter = 'brightness(0.9)';
                    } else if (diff === -3) {
                        const baseTranslateX = overlapAmount * 0.6;
                        const baseScale = 1 - (scaleStep * 2);
                        const baseOpacity = 1 - (opacityStep * 2);

                        let translateX = baseTranslateX;
                        let scale = baseScale;
                        let opacity = baseOpacity;

                        if (!isFinalState && isGoingBack && index === activeIndex - 3) {
                            const transitionProgress = 1 - Math.abs(swiperInstance.translate / swiperInstance.width);
                            translateX = baseTranslateX * (1 - transitionProgress * 0.5);
                            scale = 1 - (scaleStep * 2 * (1 - transitionProgress * 0.7));
                            opacity = 1 - (opacityStep * 2 * (1 - transitionProgress * 0.7));
                        }

                        slide.style.transform = `translateX(${translateX}px) scale(${scale})`;
                        slide.style.zIndex = '20';
                        slide.style.opacity = opacity.toString();
                        slide.style.filter = 'brightness(0.85)';
                    } else {
                        slide.style.opacity = '0';
                    }
                } else if (diff === 0 && !(isTablet && isLastSlide)) {
                    // –ê–ö–¢–ò–í–ù–ê–Ø –ö–ê–†–¢–ê (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ)
                    let scale = 1;
                    let translateY = 0;

                    if (!isFinalState) {
                        if (isGoingBack) {
                            const transitionProgress = Math.abs(swiperInstance.translate / swiperInstance.width);
                            scale = 0.95 + (0.05 * transitionProgress);
                            translateY = -5 * (1 - transitionProgress);
                        } else {
                            const transitionProgress = Math.abs(swiperInstance.translate / swiperInstance.width);
                            scale = 1 - (0.05 * (1 - transitionProgress));
                            translateY = -5 * transitionProgress;
                        }
                    }

                    slide.style.transform = `translateX(0) translateY(${translateY}px) scale(${scale})`;
                    slide.style.zIndex = '100';
                    slide.style.opacity = '1';
                    slide.style.filter = 'none';
                } else if (diff > 0) {
                    // –≠–§–§–ï–ö–¢ –í–ï–ï–†–ê –°–ü–†–ê–í–ê
                    // –ù–∞ –ø–ª–∞–Ω—à–µ—Ç–µ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–ø—Ä–∞–≤–∞
                    if (isTablet && isLastSlide) {
                        slide.style.opacity = '0';
                    } else {
                        const baseTranslateX = diff * (isMob ? 12 : (isTablet ? 15 : 20));
                        const baseScale = 1 - (diff * scaleStep);
                        const baseOpacity = 1 - (diff * opacityStep);

                        let translateX = baseTranslateX;
                        let scale = baseScale;
                        let opacity = baseOpacity;

                        if (!isFinalState && !isGoingBack && index === activeIndex + 1) {
                            const transitionProgress = Math.abs(swiperInstance.translate / swiperInstance.width);
                            translateX = baseTranslateX * (1 + transitionProgress * 0.5);
                            scale = baseScale * (1 - transitionProgress * 0.2);
                            opacity = baseOpacity * (1 - transitionProgress * 0.3);
                        }

                        slide.style.transform = `translateX(-${translateX}px) scale(${scale})`;
                        slide.style.zIndex = (90 - diff).toString();
                        slide.style.filter = `blur(${diff * 0.2}px)`;
                        slide.style.opacity = opacity.toString();
                    }
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            updateNavigationButtons();
        }

        document.querySelectorAll('.postcard-slide-content').forEach(slide => {
            slide.addEventListener('click', function(e) {
                const input = this.querySelector('input[type="radio"]');
                if(input) {
                    input.checked = true;
                    handlePostcardChange(input);
                    const slideElement = this.closest('.swiper-slide');
                    const slideIndex = Array.from(slideElement.parentNode.children).indexOf(slideElement);
                    swiper.slideTo(slideIndex, 600);
                }
            });
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        initSwiper();

        // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', function() {
            initSwiper();
        });
    });

    function setToday() { if (fpInstance) fpInstance.setDate(new Date()); }
    function setTomorrow() { if (fpInstance) fpInstance.setDate(new Date().fp_incr(1)); }
</script>
{% endblock %}