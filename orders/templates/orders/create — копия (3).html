<!-- orders/templates/orders/create.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞{% endblock %}

{% block content %}
<!-- Flatpickr (–ö–∞–ª–µ–Ω–¥–∞—Ä—å) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js"></script>

<!-- Swiper -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

<div class="checkout-page-wrapper fade-in">

    <div class="checkout-header">
        <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
    </div>

    {% if form.errors %}
        <div class="error-banner">
            <div class="error-icon">‚ö†Ô∏è</div>
            <div class="error-content">
                <h4>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ:</h4>
                <ul>
                {% for field in form %}
                    {% if field.errors %}
                        <li><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</li>
                    {% endif %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}

    <form action="." method="post" class="checkout-form" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ ID –æ—Ç–∫—Ä—ã—Ç–∫–∏ -->
        <input type="hidden" name="postcard_id_for_custom" id="postcard_id_for_custom" value="">
        <input type="hidden" name="selected_postcard_for_custom" id="selected_postcard_for_custom" value="">

        <div class="checkout-grid">

            <!-- === –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê === -->
            <div class="form-column">

                <!-- 1. –î–û–°–¢–ê–í–ö–ê –ò –í–†–ï–ú–Ø -->
                <section class="checkout-section">
                    <div class="section-head">
                        <div class="step-badge">1</div>
                        <h2>–î–æ—Å—Ç–∞–≤–∫–∞ –∏ –í—Ä–µ–º—è</h2>
                    </div>

                    <div class="delivery-toggle-group">
                        {% for radio in form.delivery_option %}
                            <label class="delivery-card" for="{{ radio.id_for_label }}">
                                {{ radio.tag }}
                                <div class="delivery-content">
                                    <div class="icon-circle">
                                        {% if 'delivery' in radio.choice_value %}üöö{% else %}üè™{% endif %}
                                    </div>
                                    <span class="radio-title">{{ radio.choice_label }}</span>
                                </div>
                                <div class="check-mark"></div>
                            </label>
                        {% endfor %}
                    </div>

                    <div id="delivery-fields" class="dynamic-block">
                        <div class="input-grid-2">
                            <div class="input-box">
                                <label>–ì–æ—Ä–æ–¥</label>
                                {{ form.city }}
                            </div>
                            <div class="input-box">
                                <label>–£–ª–∏—Ü–∞, –¥–æ–º</label>
                                {{ form.address }}
                            </div>
                        </div>
                        <div style="display:none;">{{ form.postal_code }}</div>
                    </div>

                    <hr class="section-divider" style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">

                    <!-- –ë–õ–û–ö –í–†–ï–ú–ï–ù–ò -->
                    <div class="time-selection-wrapper">
                        <h3 style="font-size: 1.1rem; margin-bottom: 15px; color: #333;">–ö–æ–≥–¥–∞ –ø–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑?</h3>

                        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å: ASAP / –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è -->
                        <div class="time-mode-switcher">
                            <!-- –û–ø—Ü–∏—è: –ö–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ -->
                            <label class="time-mode-option" id="asap-option">
                                <input type="radio" name="time_mode" value="asap" checked onchange="toggleTimeMode()">
                                <div class="tm-content">
                                    <span class="tm-icon">üöÄ</span>
                                    <div class="tm-text">
                                        <span class="tm-title">–ö–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ</span>
                                        <span class="tm-sub" id="asap-subtitle">–ù–µ –±—ã—Å—Ç—Ä–µ–µ ~{{ site_settings.processing_time|default:60 }} –º–∏–Ω</span>
                                    </div>
                                </div>
                            </label>

                            <!-- –û–ø—Ü–∏—è: –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è -->
                            <label class="time-mode-option">
                                <input type="radio" name="time_mode" value="exact" onchange="toggleTimeMode()">
                                <div class="tm-content">
                                    <span class="tm-icon">üìÖ</span>
                                    <div class="tm-text">
                                        <span class="tm-title">–¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è</span>
                                        <span class="tm-sub">–í—ã–±—Ä–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª</span>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ -->
                        <div id="exact-time-picker" style="display: none; margin-top: 20px;">
                            <!-- –£–õ–£–ß–®–ï–ù–ù–´–ô –î–ò–ó–ê–ô–ù: –õ–ï–ì–ö–ò–ï –¢–ï–ö–°–¢–û–í–´–ï –°–°–´–õ–ö–ò -->
                            <div class="quick-date-links">
                                <button type="button" class="quick-date-link today-btn">
                                    <span class="quick-date-emoji">üìÖ</span>
                                    <span class="quick-date-text">–°–µ–≥–æ–¥–Ω—è</span>
                                </button>
                                <span class="quick-date-separator">‚Ä¢</span>
                                <button type="button" class="quick-date-link tomorrow-btn">
                                    <span class="quick-date-emoji">üìÖ</span>
                                    <span class="quick-date-text">–ó–∞–≤—Ç—Ä–∞</span>
                                </button>
                            </div>

                            <div class="datetime-grid">
                                <div class="input-box date-input-box">
                                    <label>–î–∞—Ç–∞</label>
                                    <div class="date-input-wrapper">
                                        {{ form.delivery_date }}
                                        <span class="calendar-icon">üìÖ</span>
                                    </div>
                                </div>
                                <div class="input-box time-input-box">
                                    <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª</label>
                                    <select name="delivery_time" id="delivery-time-select" class="form-control">
                                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É...</option>
                                    </select>
                                </div>
                            </div>
                            <p id="no-slots-message" style="display: none; color: #d32f2f; font-size: 0.9rem; margin-top: 10px;">
                                üòî –ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å.
                            </p>
                        </div>
                    </div>

                </section>

                <!-- 2. –ü–û–õ–£–ß–ê–¢–ï–õ–¨ -->
                <section class="checkout-section" id="recipient-section">
                    <div class="section-head">
                        <div class="step-badge">2</div>
                        <h2>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</h2>
                    </div>

                    <div class="recipient-switcher">
                        <label class="switch-option">
                            <input type="radio" name="recipient_who" value="me" checked onchange="toggleRecipient(this)">
                            <span>–Ø –ø–æ–ª—É—á—É —Å–∞–º</span>
                        </label>
                        <label class="switch-option">
                            <input type="radio" name="recipient_who" value="other" onchange="toggleRecipient(this)">
                            <span>–î—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫</span>
                        </label>
                    </div>

                    <div id="recipient-fields" class="dynamic-block" style="display: none;">
                        <div class="info-alert">
                            ü§´ –ú—ã –Ω–µ —Å–æ–æ–±—â–∏–º –ø–æ–ª—É—á–∞—Ç–µ–ª—é –æ –∑–∞–∫–∞–∑—á–∏–∫–µ –¥–æ –≤—Ä—É—á–µ–Ω–∏—è.
                        </div>
                        <div class="input-grid-2">
                            <div class="input-box">
                                <label>–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                                {{ form.recipient_name }}
                            </div>
                            <div class="input-box">
                                <label>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                                {{ form.recipient_phone }}
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 3. –û–¢–ö–†–´–¢–ö–ê (–ö–ê–†–£–°–ï–õ–¨) -->
                <section class="checkout-section postcard-section-wrapper">
                    <div class="section-head">
                        <div class="step-badge">3</div>
                        <h2>–û—Ç–∫—Ä—ã—Ç–∫–∞ –∫ –±—É–∫–µ—Ç—É</h2>
                    </div>

                    <div class="swiper-container-wrapper">
                        <!-- –°—Ç—Ä–µ–ª–∫–∞ –í–ª–µ–≤–æ -->
                        <div class="swiper-button-prev custom-nav">
                            <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
                        </div>

                        <div class="swiper postcard-swiper">
                            <div class="swiper-wrapper">

                                <!-- 1. –ë–µ–∑ –æ—Ç–∫—Ä—ã—Ç–∫–∏ -->
                                <div class="swiper-slide">
                                    <label class="postcard-slide-content">
                                        <input type="radio" name="postcard" value="" data-price="0" checked onchange="handlePostcardChange(this)">
                                        <div class="pc-visual">
                                            <div class="pc-emoji">üö´</div>
                                            <span class="pc-name">–ë–µ–∑ –æ—Ç–∫—Ä—ã—Ç–∫–∏</span>
                                            <span class="pc-price-tag">0 ‚ÇΩ</span>
                                        </div>
                                    </label>
                                </div>

                                <!-- 2. –°–≤–æ—ë —Ñ–æ—Ç–æ -->
                                <div class="swiper-slide">
                                    <label class="postcard-slide-content">
                                        <input type="radio" name="postcard" value="custom"
                                            data-price="{{ site_settings.custom_postcard_price|default:0|stringformat:'.0f' }}"
                                            onchange="handlePostcardChange(this)">

                                        <div class="pc-visual">
                                            <div class="pc-emoji">üì∏</div>
                                            <span class="pc-name">–°–≤–æ—ë —Ñ–æ—Ç–æ</span>
                                            <span class="pc-price-tag">
                                                {% if site_settings.custom_postcard_price > 0 %}
                                                    +{{ site_settings.custom_postcard_price|floatformat:0 }}‚ÇΩ
                                                {% else %}
                                                    0 ‚ÇΩ
                                                {% endif %}
                                            </span>
                                        </div>
                                    </label>
                                </div>

                                <!-- 3+. –û—Ç–∫—Ä—ã—Ç–∫–∏ –∏–∑ –±–∞–∑—ã -->
                                {% for card in postcards %}
                                <div class="swiper-slide">
                                    <label class="postcard-slide-content">
                                        <input type="radio" name="postcard" value="{{ card.id }}"
                                               data-price="{{ card.price|stringformat:'.0f' }}"
                                               data-title="{{ card.title }}"
                                               onchange="handlePostcardChange(this)">
                                        <div class="pc-visual">
                                            {% if card.image %}
                                                <img src="{{ card.image.url }}" alt="{{ card.title }}">
                                            {% else %}
                                                <div class="pc-emoji">üíå</div>
                                            {% endif %}
                                            <span class="pc-name">{{ card.title }}</span>
                                            <span class="pc-price-tag">
                                                {% if card.price > 0 %}+{{ card.price }}‚ÇΩ{% else %}–ë–µ—Å–ø–ª–∞—Ç–Ω–æ{% endif %}
                                            </span>
                                        </div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- –°—Ç—Ä–µ–ª–∫–∞ –í–ø—Ä–∞–≤–æ -->
                        <div class="swiper-button-next custom-nav">
                            <svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
                        </div>
                    </div>

                    <!-- –ü–æ–ª—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –∏ —Ç–µ–∫—Å—Ç–∞ -->
                    <div id="postcard-extras" class="dynamic-block" style="display: none; margin-top: 20px;">
                        <div id="custom-upload-field" style="display: none; margin-bottom: 20px;">
                            <div class="input-box">
                                <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</label>
                                <div class="file-upload-wrapper">
                                    {{ form.custom_postcard_image }}
                                </div>
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è JPG, PNG –¥–æ 5 –ú–ë
                                </small>
                            </div>
                        </div>
                        <div class="input-box">
                            <label>–¢–µ–∫—Å—Ç –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è:</label>
                            {{ form.postcard_text }}
                        </div>
                    </div>

                </section>

                <!-- 4. –ö–û–ù–¢–ê–ö–¢–´ -->
                <section class="checkout-section">
                    <div class="section-head">
                        <div class="step-badge">4</div>
                        <h2>–í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã</h2>
                    </div>
                    <div class="input-grid-2">
                        <div class="input-box">
                            <label>–í–∞—à–µ –ò–º—è</label>
                            {{ form.first_name }}
                        </div>
                        <div class="input-box">
                            <label>–í–∞—à –¢–µ–ª–µ—Ñ–æ–Ω</label>
                            {{ form.phone }}
                        </div>
                    </div>
                    <div class="input-box" style="margin-top: 15px;">
                        <label>Email (–¥–ª—è —á–µ–∫–∞)</label>
                        {{ form.email }}
                    </div>
                    <div style="display:none;">{{ form.last_name }}</div>
                </section>

            </div>

            <!-- === –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê === -->
            <div class="sidebar-column">
                <div class="order-summary-card sticky-block">
                    <div class="summary-header-bg">
                        <h3>–í–∞—à –∑–∞–∫–∞–∑</h3>
                    </div>

                    <div class="summary-body">
                        <div class="cart-items-mini">
                            {% for item in cart %}
                            <a href="{{ item.product.get_absolute_url }}" class="mini-item">
                                <div class="mi-thumb">
                                    {% if item.product.image %}
                                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                                    {% else %}
                                        <span style="font-size: 20px;">üå∏</span>
                                    {% endif %}
                                </div>
                                <div class="mi-info">
                                    <div class="mi-name">{{ item.product.name }}</div>
                                    <div class="mi-qty">{{ item.quantity }} —à—Ç.</div>
                                </div>
                                <div class="mi-price">{{ item.total_price }} ‚ÇΩ</div>
                            </a>
                            {% endfor %}
                        </div>

                        <div class="summary-divider"></div>

                        <div class="summary-row">
                            <span>–¢–æ–≤–∞—Ä—ã</span>
                            <span>{{ cart_total_js }} ‚ÇΩ</span>
                        </div>

                        {% if cart.promo %}
                            <div class="summary-row discount highlight" id="discount-row">
                                <span>–°–∫–∏–¥–∫–∞ ({{ cart.promo.code }})</span>
                                <span id="discount-display">-{{ cart.get_discount|floatformat:0 }} ‚ÇΩ</span>
                            </div>
                        {% endif %}

                        <div class="summary-row " id="delivery-row">
                            <span>–î–æ—Å—Ç–∞–≤–∫–∞</span>
                            <span id="delivery-price-display">{{ delivery_cost_js }} ‚ÇΩ</span>
                        </div>
                        <div class="summary-row highlight" id="postcard-row" style="display: none;">
                            <span>–û—Ç–∫—Ä—ã—Ç–∫–∞</span>
                            <span id="postcard-price-display">0 ‚ÇΩ</span>
                        </div>

                        <div class="summary-divider dashed"></div>

                        <div class="grand-total">
                            <span>–ò—Ç–æ–≥–æ:</span>
                            <span id="final-total-display" class="total-val">0 ‚ÇΩ</span>
                        </div>

                        <button type="submit" class="btn-checkout">
                            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>

                        <p class="policy-text">
                            –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –æ—Ñ–µ—Ä—Ç—ã.
                        </p>
                    </div>
                </div>
            </div>

        </div>

    </form>
</div>

<!-- ================== –°–¢–ò–õ–ò CSS ================== -->
<style>
    :root {
        --card-bg: #ffffff;
        --input-bg: #f9f9f9;
        --border-color: #eee;
        --primary: var(--accent-color, #e53935);
        --text-main: #333;
        --radius: 16px;
    }

    .checkout-page-wrapper * { box-sizing: border-box; }

    .checkout-page-wrapper {
        max-width: 1200px; margin: 0 auto; padding: 20px;
        font-family: var(--default-font-family, sans-serif);
        padding-bottom: 120px;
    }
    .checkout-header { text-align: center; margin-bottom: 30px; }
    .checkout-header h1 { font-size: 1.8rem; margin: 0; font-weight: 800; color: var(--text-main); }

    .fade-in { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* –°–ï–¢–ö–ê */
    .checkout-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 30px;
        align-items: start;
    }
    .form-column { min-width: 0; }
    .sidebar-column { position: sticky; top: 20px; min-width: 0; z-index: 50; }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
    .checkout-section {
        background: var(--card-bg); padding: 25px; border-radius: var(--radius);
        margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid var(--border-color);
    }
    .section-head { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }

    /* –¶–ò–§–†–´ –®–ê–ì–û–í */
    .step-badge {
        width: 30px; height: 30px; background: var(--primary); color: #fff;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-weight: bold; font-size: 0.9rem; box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        user-select: none; cursor: default;
    }

    .section-head h2 { margin: 0; font-size: 1.2rem; font-weight: 700; user-select: none; }

    /* –ò–Ω–ø—É—Ç—ã */
    .input-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .datetime-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .input-box { width: 100%; margin-bottom: 15px; }

    .input-box label {
        display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 6px; color: #555; user-select: none;
    }

    .input-box input:not([type="file"]), .input-box select, .input-box textarea {
        width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid #e0e0e0;
        font-size: 0.95rem; background: var(--input-bg); transition: 0.2s;
    }
    .input-box input:focus, .input-box textarea:focus, .input-box select:focus {
        border-color: var(--primary); background: #fff; outline: none; box-shadow: 0 0 0 3px rgba(229, 57, 53, 0.1);
    }

    /* –£–õ–£–ß–®–ï–ù–ù–´–ô –î–ò–ó–ê–ô–ù: –ö–ù–û–ü–ö–ò "–°–ï–ì–û–î–ù–Ø/–ó–ê–í–¢–†–ê" */
    .quick-date-links {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 20px;
        flex-wrap: nowrap;
    }

    .quick-date-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 14px;
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        border-radius: 18px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: visible;
        background: transparent;
        border: 1px solid rgba(229, 57, 53, 0.15);
        min-width: 90px;
        text-align: center;
        z-index: 1;
        cursor: pointer;
        font-family: inherit;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }

    .quick-date-link:hover {
        background: rgba(229, 57, 53, 0.05);
        color: var(--primary);
        border-color: rgba(229, 57, 53, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(229, 57, 53, 0.08);
        text-decoration: none;
    }

    .quick-date-link.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 6px 20px rgba(229, 57, 53, 0.3);
    }

    .quick-date-link.active:hover {
        background: #d32f2f;
        border-color: #d32f2f;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(229, 57, 53, 0.35);
    }

    .quick-date-emoji {
        font-size: 1.1rem;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        display: inline-block;
        transform-origin: center;
        position: relative;
        z-index: 2;
        pointer-events: none;
    }

    /* –ê–ù–ò–ú–ê–¶–ò–Ø –ü–û–î–ü–†–´–ì–ò–í–ê–Æ–©–ï–ô –ò–ö–û–ù–ö–ò - –ò–°–ü–†–ê–í–õ–ï–ù–ê: —É–ª–µ—Ç–∞–µ—Ç –≤–≤–µ—Ä—Ö */
    .quick-date-link.active .quick-date-emoji {
        animation: emojiJump 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        color: white;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
    }

    @keyframes emojiJump {
        0% {
            transform: scale(1) translateY(0) rotate(0deg);
            filter: brightness(1);
        }
        20% {
            transform: scale(1.8) translateY(-15px) rotate(180deg);
            filter: brightness(1.5) drop-shadow(0 5px 15px rgba(255, 255, 255, 0.6));
        }
        40% {
            transform: scale(2.2) translateY(-60px) rotate(360deg);
            filter: brightness(2) drop-shadow(0 10px 25px rgba(255, 255, 255, 0.8));
        }
        50% {
            transform: scale(2.2) translateY(-80px) rotate(360deg);
            filter: brightness(2) drop-shadow(0 15px 30px rgba(255, 255, 255, 1));
        }
        60% {
            transform: scale(2) translateY(-60px) rotate(360deg);
            filter: brightness(1.8) drop-shadow(0 10px 20px rgba(255, 255, 255, 0.8));
        }
        70% {
            transform: scale(1.6) translateY(-30px) rotate(360deg);
            filter: brightness(1.5) drop-shadow(0 5px 15px rgba(255, 255, 255, 0.6));
        }
        80% {
            transform: scale(1.3) translateY(5px) rotate(360deg);
            filter: brightness(1.3) drop-shadow(0 2px 10px rgba(255, 255, 255, 0.4));
        }
        90% {
            transform: scale(1.1) translateY(-2px) rotate(360deg);
            filter: brightness(1.1) drop-shadow(0 1px 5px rgba(255, 255, 255, 0.2));
        }
        100% {
            transform: scale(1.3) translateY(0) rotate(360deg);
            filter: brightness(1) drop-shadow(0 0 0 rgba(255, 255, 255, 0));
        }
    }

    /* –≠–§–§–ï–ö–¢ –°–í–ï–ß–ï–ù–ò–Ø –ò–ö–û–ù–ö–ò */
    .quick-date-link.active .quick-date-emoji::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 40px;
        height: 40px;
        background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
        border-radius: 50%;
        transform: translate(-50%, -50%) scale(0);
        animation: emojiGlow 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        z-index: -1;
    }

    @keyframes emojiGlow {
        0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        40% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.6; }
        60% { transform: translate(-50%, -50%) scale(2); opacity: 0.4; }
        80% { transform: translate(-50%, -50%) scale(2.5); opacity: 0.2; }
        100% { transform: translate(-50%, -50%) scale(3); opacity: 0; }
    }

    /* –°–õ–ï–î –û–¢ –ò–ö–û–ù–ö–ò */
    .quick-date-link.active .quick-date-emoji::after {
        content: '‚ú®';
        position: absolute;
        top: 50%;
        left: 50%;
        font-size: 0.8rem;
        opacity: 0;
        animation: trailEffect 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        pointer-events: none;
    }

    @keyframes trailEffect {
        0% {
            transform: translate(-50%, 0) scale(1);
            opacity: 0;
        }
        30% {
            transform: translate(-50%, -20px) scale(1.2);
            opacity: 0.8;
        }
        50% {
            transform: translate(-50%, -40px) scale(1);
            opacity: 0.6;
        }
        70% {
            transform: translate(-50%, -60px) scale(0.8);
            opacity: 0.4;
        }
        90% {
            transform: translate(-50%, -80px) scale(0.6);
            opacity: 0.2;
        }
        100% {
            transform: translate(-50%, -100px) scale(0.4);
            opacity: 0;
        }
    }

    .quick-date-link:hover .quick-date-emoji {
        transform: scale(1.2);
    }

    .quick-date-text {
        font-weight: 600;
        font-size: 0.9rem;
        letter-spacing: -0.01em;
        transition: transform 0.3s ease;
        pointer-events: none;
    }

    .quick-date-link.active .quick-date-text {
        animation: textBounce 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes textBounce {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-2px); }
        75% { transform: translateX(2px); }
    }

    .quick-date-separator {
        color: #ddd;
        font-weight: 300;
        font-size: 1.1rem;
        user-select: none;
        opacity: 0.5;
        pointer-events: none;
    }

    /* –°–¢–ò–õ–¨ –î–õ–Ø –ó–ê–ì–†–£–ó–ö–ò –§–ê–ô–õ–ê */
    .file-upload-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .file-upload-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 2;
    }

    .file-upload-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        z-index: 1;
        user-select: none;
    }

    .file-upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .file-upload-btn:active {
        transform: translateY(0);
    }

    .file-upload-btn.has-file {
        background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .file-upload-icon {
        font-size: 1.1rem;
    }

    .file-name-display {
        flex-grow: 1;
        font-size: 0.85rem;
        color: #666;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px dashed #ddd;
        min-height: 40px;
        display: flex;
        align-items: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .file-name-display.has-file {
        color: #2E7D32;
        background: #e8f5e9;
        border-color: #c8e6c9;
        font-weight: 500;
    }

    .date-input-wrapper { position: relative; }
    .calendar-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); pointer-events: none; opacity: 0.5; font-size: 1.1rem; }
    .datepicker-input { background: #fff !important; cursor: pointer; padding-right: 40px !important; }

    /* –î–æ—Å—Ç–∞–≤–∫–∞ */
    .delivery-toggle-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
    .delivery-card, .switch-option { cursor: pointer; position: relative; width: 100%; }
    .delivery-card input, .switch-option input { display: none; }

    .delivery-content, .recipient-switcher {
        border: 2px solid #f0f0f0; border-radius: 12px; padding: 15px;
        display: flex; align-items: center; gap: 12px; transition: 0.2s;
    }
    .recipient-switcher { background: #f0f0f0; padding: 4px; margin-bottom: 15px; border: none; }
    .switch-option span {
        display: block; text-align: center; padding: 10px; border-radius: 8px;
        font-weight: 600; color: #777; transition: 0.2s; font-size: 0.9rem; width: 100%;
        user-select: none;
    }
    .switch-option input:checked + span { background: #fff; color: #333; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .icon-circle { width: 36px; height: 36px; background: #f5f5f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
    .radio-title { font-weight: 600; font-size: 0.95rem; color: #555; }
    .check-mark { position: absolute; top: 15px; right: 15px; width: 10px; height: 10px; border-radius: 50%; background: #ddd; transition: 0.2s; }
    .delivery-card input:checked + .delivery-content { border-color: var(--primary); background: #fff5f5; }
    .delivery-card input:checked ~ .check-mark { background: var(--primary); box-shadow: 0 0 0 2px #fff, 0 0 0 3px var(--primary); }
    .info-alert { background: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 0.85rem; }

    /* === –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø TIME SWITCHER === */
    .time-mode-switcher { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
    .time-mode-option { cursor: pointer; position: relative; }
    .time-mode-option input { display: none; }

    .tm-content {
        border: 2px solid #f0f0f0; border-radius: 12px; padding: 12px;
        display: flex; align-items: center; gap: 10px; transition: 0.2s; background: #fff; height: 100%;
    }
    .time-mode-option input:checked + .tm-content { border-color: var(--primary); background: #fff5f5; }
    .time-mode-option.disabled { opacity: 0.6; pointer-events: none; filter: grayscale(1); }

    .tm-icon { font-size: 1.4rem; }
    .tm-text { display: flex; flex-direction: column; }
    .tm-title { font-weight: 600; font-size: 0.95rem; color: #333; }
    .tm-sub { font-size: 0.75rem; color: #888; margin-top: 2px; }

    /* === –ö–ê–†–£–°–ï–õ–¨ SWIPER === */
    .swiper-container-wrapper { position: relative; padding: 0 40px; overflow: hidden; }
    .postcard-swiper { width: 100%; height: 240px; padding: 20px 0; overflow: visible; }
    .swiper-slide {
        width: 140px !important; height: 180px; border-radius: 16px;
        transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        transform-style: preserve-3d; flex-shrink: 0; transform-origin: center center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer;
        transition-property: transform, opacity, filter, z-index;
        -webkit-tap-highlight-color: transparent !important;
    }
    .postcard-slide-content {
        display: block; width: 100%; height: 100%; cursor: pointer;
        position: relative; user-select: none;
        -webkit-tap-highlight-color: transparent !important;
        outline: none !important;
        -webkit-user-select: none !important;
        -webkit-touch-callout: none !important;
    }
    .postcard-slide-content input { display: none; }

    .pc-visual {
        width: 100%; height: 100%; background: #fff; border-radius: 16px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 2px solid transparent;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 10px; box-sizing: border-box; transition: 0.4s ease; position: relative; overflow: hidden;
        -webkit-tap-highlight-color: transparent !important;
    }
    .pc-visual::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--primary), #ff6b6b); transform: scaleX(0); transition: 0.3s ease; }
    .swiper-slide-active .pc-visual::before { transform: scaleX(1); }
    .pc-emoji { font-size: 2.5rem; margin-bottom: 10px; transition: 0.3s; }
    .swiper-slide-active .pc-emoji { transform: scale(1.2); }
    .pc-visual img { width: 100%; height: 80px; object-fit: cover; margin-bottom: 10px; border-radius: 8px; transition: 0.3s; }
    .swiper-slide-active .pc-visual img { transform: scale(1.05); }
    .pc-name { font-size: 0.85rem; font-weight: 700; color: #333; margin-bottom: 5px; text-align: center; line-height: 1.1; height: 30px; display: flex; align-items: center; justify-content: center; transition: color 0.3s; }
    .swiper-slide-active .pc-name { color: var(--primary); }
    .pc-price-tag { background: #7e57c2; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.75rem; font-weight: 700; transition: 0.3s; }
    .swiper-slide-active .pc-price-tag { transform: scale(1.1); box-shadow: 0 4px 12px rgba(126, 87, 194, 0.4); }
    .postcard-slide-content input:checked + .pc-visual { border-color: var(--primary); box-shadow: 0 12px 35px rgba(229, 57, 53, 0.25); transform: translateY(-5px); }

    /* –°—Ç—Ä–µ–ª–∫–∏ */
    .custom-nav { position: absolute; top: 50%; margin-top: -20px; width: 36px; height: 36px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); cursor: pointer; transition: 0.3s; box-shadow: 0 4px 12px rgba(229, 57, 53, 0.3); z-index: 10; }
    .custom-nav svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; }
    .custom-nav:hover { transform: scale(1.1); background: #d32f2f; color: #fff; }
    .swiper-button-prev { left: 0; }
    .swiper-button-next { right: 0; }

    /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
    .order-summary-card { background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; }
    .summary-header-bg { background: #f8f9fa; padding: 20px; border-bottom: 1px solid #eee; }
    .summary-header-bg h3 { margin: 0; font-size: 1.2rem; font-weight: 800; color: #222; }
    .summary-body { padding: 20px; }
    .cart-items-mini { margin-bottom: 20px; max-height: 350px; overflow-y: auto; }
    .mini-item { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f5f5f5; text-decoration: none; transition: background 0.2s; border-radius: 8px; }
    .mini-item:hover { background: #fafafa; }
    .mi-thumb { width: 55px; height: 55px; border-radius: 10px; overflow: hidden; background: #f4f4f4; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .mi-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .mi-info { flex: 1; }
    .mi-name { font-size: 0.9rem; font-weight: 600; line-height: 1.3; color: #333; margin-bottom: 2px; }
    .mi-qty { font-size: 0.8rem; color: #888; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; }
    .mi-price { font-weight: 700; font-size: 0.95rem; color: #333; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; color: #666; }
    .summary-row.highlight { color: #28a745; font-weight: 600; }
    .summary-divider { height: 1px; background: #eee; margin: 15px 0; }
    .summary-divider.dashed { border-top: 1px dashed #ccc; background: none; }
    .grand-total { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; font-size: 1.4rem; font-weight: 800; color: var(--text-main); }
    .btn-checkout { width: 100%; padding: 16px; margin-top: 20px; border-radius: 12px; border: none; background: var(--primary); color: #fff; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
    .btn-checkout:hover { opacity: 0.9; transform: translateY(-2px); }
    .policy-text { text-align: center; font-size: 0.75rem; color: #999; margin-top: 15px; line-height: 1.4; }
    .error-banner { background: #ffebee; border: 1px solid #ffcdd2; border-radius: 12px; padding: 20px; margin-bottom: 25px; display: flex; gap: 15px; align-items: flex-start; }
    .error-icon { font-size: 1.5rem; flex-shrink: 0; }
    .error-content h4 { margin: 0 0 10px 0; color: #c62828; font-size: 1rem; }
    .error-content ul { margin: 0; padding-left: 20px; }
    .error-content li { color: #d32f2f; margin-bottom: 5px; font-size: 0.9rem; }

    /* === –ê–î–ê–ü–¢–ê–¶–ò–Ø (–ü–ª–∞–Ω—à–µ—Ç—ã) === */
    @media (max-width: 1024px) {
        .checkout-grid { grid-template-columns: 1fr; gap: 30px; }
        .sidebar-column { position: static; order: 2; }
        .form-column { order: 1; }

        .swiper-container-wrapper {
            padding: 0 40px;
        }
        .custom-nav {
            width: 40px;
            height: 40px;
            margin-top: -20px;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .custom-nav svg { width: 18px; height: 18px; }
        .swiper-button-prev { left: 0 !important; }
        .swiper-button-next { right: 0 !important; }

        /* –ü–ª–∞–Ω—à–µ—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã */
        .postcard-swiper {
            height: 180px;
            padding: 15px 0;
        }
        .swiper-slide {
            width: 110px !important;
            height: 150px;
        }
        .pc-visual { padding: 8px; border-radius: 12px; }
        .pc-emoji { font-size: 2rem; margin-bottom: 8px; }
        .pc-visual img { height: 55px; margin-bottom: 8px; }
        .pc-name { font-size: 0.75rem; height: 25px; }
        .pc-price-tag { font-size: 0.7rem; padding: 3px 8px; }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–∞ */
        .quick-date-links {
            gap: 6px;
        }

        .quick-date-link {
            padding: 6px 12px;
            font-size: 0.85rem;
            min-width: 85px;
            gap: 5px;
        }

        .quick-date-emoji {
            font-size: 1rem;
        }

        .quick-date-text {
            font-size: 0.85rem;
        }

        .quick-date-separator {
            font-size: 1rem;
        }
    }

    /* === –ê–î–ê–ü–¢–ê–¶–ò–Ø (–ú–æ–±–∏–ª—å–Ω—ã–µ) === */
    @media (max-width: 768px) {
        .checkout-page-wrapper { padding: 15px 10px 140px 10px; }
        .input-grid-2, .datetime-grid, .delivery-toggle-group, .time-mode-switcher { grid-template-columns: 1fr; gap: 10px; }

        /* –ö–∞—Ä—É—Å–µ–ª—å –º–æ–±–∏–ª—å–Ω–∞—è */
        .swiper-container-wrapper {
            padding: 0 35px;
        }
        .custom-nav {
            width: 32px !important;
            height: 32px !important;
            margin-top: -16px;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .custom-nav svg { width: 16px; height: 16px; }
        .swiper-button-prev { left: -5px !important; }
        .swiper-button-next { right: -5px !important; }
        .postcard-swiper { height: 160px; padding: 10px 0; }
        .swiper-slide { width: 85px !important; height: 120px; }
        .pc-visual { padding: 5px; border-radius: 10px; }
        .pc-emoji { font-size: 1.6rem; margin-bottom: 5px; }
        .pc-visual img { height: 45px; margin-bottom: 5px; }
        .pc-name { font-size: 0.65rem; height: 22px; }
        .pc-price-tag { font-size: 0.6rem; padding: 2px 6px; }

        /* –£–±–∏—Ä–∞–µ–º —Å–∏–Ω–∏–π —Ñ–æ–Ω –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .postcard-slide-content,
        .pc-visual,
        .swiper-slide {
            -webkit-tap-highlight-color: transparent !important;
            tap-highlight-color: transparent !important;
            -webkit-user-select: none !important;
            user-select: none !important;
            -webkit-touch-callout: none !important;
            touch-action: manipulation;
        }

        .postcard-slide-content:active,
        .postcard-slide-content:focus,
        .postcard-slide-content:hover,
        .pc-visual:active,
        .pc-visual:focus,
        .pc-visual:hover,
        .swiper-slide:active,
        .swiper-slide:focus {
            background: transparent !important;
            outline: none !important;
            box-shadow: none !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .quick-date-links {
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 6px;
            flex-wrap: nowrap;
        }

        .quick-date-separator {
            font-size: 0.9rem;
        }

        .quick-date-link {
            padding: 5px 10px;
            font-size: 0.8rem;
            min-width: 75px;
            gap: 4px;
        }

        .quick-date-emoji {
            font-size: 0.9rem;
        }

        .quick-date-text {
            font-size: 0.8rem;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .file-upload-btn {
            padding: 10px 15px;
            font-size: 0.8rem;
        }
        .file-name-display {
            font-size: 0.75rem;
            padding: 6px 10px;
        }
    }

    /* –ë–æ–ª—å—à–∏–µ —ç–∫—Ä–∞–Ω—ã */
    @media (min-width: 1440px) {
        .swiper-container-wrapper { padding: 0 60px; }
        .custom-nav { width: 44px; height: 44px; }
        .custom-nav svg { width: 24px; height: 24px; }
    }
</style>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const cartTotal = {{ cart_total_js|stringformat:".0f" }};
    const deliveryCostBase = {{ delivery_cost_js|stringformat:".0f" }};
    let currentDeliveryCost = deliveryCostBase;
    let currentPostcardPrice = 0;
    let lastSelectedPostcardId = '';
    let lastSelectedPostcardPrice = 0;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const deliveryFields = document.getElementById('delivery-fields');
    const deliveryRow = document.getElementById('delivery-row');
    const deliveryPriceDisplay = document.getElementById('delivery-price-display');
    const postcardRow = document.getElementById('postcard-row');
    const postcardPriceDisplay = document.getElementById('postcard-price-display');
    const finalTotalDisplay = document.getElementById('final-total-display');
    const postcardExtras = document.getElementById('postcard-extras');
    const customUpload = document.getElementById('custom-upload-field');
    const textInput = document.querySelector('#id_postcard_text');
    const recipientFields = document.getElementById('recipient-fields');

    // –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏
    const exactPicker = document.getElementById('exact-time-picker');
    const timeSelect = document.getElementById('delivery-time-select');
    const dateInput = document.querySelector('.datepicker-input');
    const asapOption = document.getElementById('asap-option');
    const asapSubtitle = document.getElementById('asap-subtitle');
    const noSlotsMsg = document.getElementById('no-slots-message');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
    const todayBtn = document.querySelector('.today-btn');
    const tomorrowBtn = document.querySelector('.tomorrow-btn');

    // –°–æ–∑–¥–∞–µ–º –∑–≤—É–∫ —â–µ–ª—á–∫–∞
    function createClickSound() {
        try {
            // –ü—Ä–æ—Å—Ç–æ–π —â–µ–ª—á–æ–∫ —á–µ—Ä–µ–∑ Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∑–≤—É–∫–∞ —â–µ–ª—á–∫–∞
            oscillator.type = 'sine';
            oscillator.frequency.value = 1000; // –í—ã—Å–æ–∫–∞—è —á–∞—Å—Ç–æ—Ç–∞ –¥–ª—è —â–µ–ª—á–∫–∞

            // –ë—ã—Å—Ç—Ä–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ
            gainNode.gain.value = 0.15;
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);

            return audioContext;
        } catch (e) {
            console.log('Web Audio API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –∑–≤—É–∫ –æ—Ç–∫–ª—é—á–µ–Ω');
            return null;
        }
    }

    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ —â–µ–ª—á–∫–∞
    function playClickSound() {
        try {
            const ctx = createClickSound();
            if (ctx) {
                setTimeout(() => ctx.close(), 200);
            }
        } catch (e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å –∞—É–¥–∏–æ
        }
    }

    let fpInstance;
    let swiper;
    let isAnimating = false;

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ===
    document.addEventListener('DOMContentLoaded', function() {
        recalcTotal();
        checkAsapAvailability();
        initFileUpload();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–°–µ–≥–æ–¥–Ω—è/–ó–∞–≤—Ç—Ä–∞"
        initDateButtons();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏
        const activeDelivery = document.querySelector('input[name="delivery_option"]:checked');
        if(activeDelivery && activeDelivery.value === 'pickup') {
             deliveryFields.style.display = 'none';
             deliveryRow.style.display = 'none';
             currentDeliveryCost = 0;
             recalcTotal();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        fpInstance = flatpickr(".datepicker-input", {
            locale: "ru",
            minDate: "today",
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "j F Y",
            disableMobile: "true",
            allowInput: true,
            onChange: function(selectedDates, dateStr) {
                // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
                resetQuickDateLinks();

                // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
                loadSlots(dateStr);
            }
        });

        // –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–∂–µ –µ—Å—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–æ—à–∏–±–∫–∞ —Ñ–æ—Ä–º—ã)
        if(dateInput && dateInput.value) {
            const selectedDate = new Date(dateInput.value);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // –ê–≤—Ç–æ–≤—ã–±–æ—Ä —Å—Å—ã–ª–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
            if (isSameDate(selectedDate, today)) {
                setActiveQuickDateLink(todayBtn);
            } else if (isSameDate(selectedDate, tomorrow)) {
                setActiveQuickDateLink(tomorrowBtn);
            }

            loadSlots(dateInput.value);
            const tm = document.querySelector('input[name="time_mode"]:checked');
            if(tm && tm.value === 'exact') exactPicker.style.display = 'block';
        }

        initSwiper();
        window.addEventListener('resize', initSwiper);

        // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
        const form = document.querySelector('.checkout-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                console.log('=== –î–ê–ù–ù–´–ï –ü–ï–†–ï–î–ê–í–ê–ï–ú–´–ï –í –§–û–†–ú–ï ===');
                console.log('postcard:', document.querySelector('input[name="postcard"]:checked')?.value);
                console.log('postcard_id_for_custom:', document.getElementById('postcard_id_for_custom')?.value);
                console.log('selected_postcard_for_custom:', document.getElementById('selected_postcard_for_custom')?.value);
                console.log('currentPostcardPrice:', currentPostcardPrice);
            });
        }
    });

    // === –§–£–ù–ö–¶–ò–ò ===

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫
    function initDateButtons() {
        if (todayBtn) {
            todayBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                playClickSound();
                setDateToday(e);
            });
        }

        if (tomorrowBtn) {
            tomorrowBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                playClickSound();
                setDateTomorrow(e);
            });
        }
    }

    // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞—Ç (–±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏)
    function isSameDate(date1, date2) {
        return date1.getFullYear() === date2.getFullYear() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getDate() === date2.getDate();
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
    function setActiveQuickDateLink(buttonElement) {
        resetQuickDateLinks();
        if (buttonElement) {
            buttonElement.classList.add('active');
            const emoji = buttonElement.querySelector('.quick-date-emoji');
            if (emoji) {
                // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∞–Ω–∏–º–∞—Ü–∏—é –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞
                emoji.style.animation = 'none';
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                void emoji.offsetWidth;
                // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é –∞–Ω–∏–º–∞—Ü–∏—é
                emoji.style.animation = 'emojiJump 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
            }

            // –ê–Ω–∏–º–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
            const text = buttonElement.querySelector('.quick-date-text');
            if (text) {
                text.style.animation = 'none';
                void text.offsetWidth;
                text.style.animation = 'textBounce 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
            }
        }
    }

    // –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
    function resetQuickDateLinks() {
        document.querySelectorAll('.quick-date-link').forEach(link => {
            link.classList.remove('active');
            const emoji = link.querySelector('.quick-date-emoji');
            if (emoji) {
                emoji.style.animation = '';
            }
        });
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    function setDateToday(e) {
        if (e) e.preventDefault();
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];

        if (fpInstance) {
            fpInstance.setDate(dateStr, true);
            setActiveQuickDateLink(todayBtn);
            loadSlots(dateStr);
        }

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º —Ç–æ—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –µ—Å–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
        const exactRadio = document.querySelector('input[name="time_mode"][value="exact"]');
        if (exactRadio && !exactRadio.checked) {
            exactRadio.checked = true;
            toggleTimeMode();
        }
        return false;
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –Ω–∞ –∑–∞–≤—Ç—Ä–∞
    function setDateTomorrow(e) {
        if (e) e.preventDefault();
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const dateStr = tomorrow.toISOString().split('T')[0];

        if (fpInstance) {
            fpInstance.setDate(dateStr, true);
            setActiveQuickDateLink(tomorrowBtn);
            loadSlots(dateStr);
        }

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º —Ç–æ—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –µ—Å–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
        const exactRadio = document.querySelector('input[name="time_mode"][value="exact"]');
        if (exactRadio && !exactRadio.checked) {
            exactRadio.checked = true;
            toggleTimeMode();
        }
        return false;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—Ä–∞—Å–∏–≤–æ–π –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    function initFileUpload() {
        const fileInput = document.querySelector('input[name="custom_postcard_image"]');
        if (fileInput) {
            const wrapper = fileInput.parentNode;

            // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—É—é –∫–Ω–æ–ø–∫—É
            const uploadBtn = document.createElement('div');
            uploadBtn.className = 'file-upload-btn';
            uploadBtn.innerHTML = '<span class="file-upload-icon">üì∑</span> <span>–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</span>';

            // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            const fileNameDisplay = document.createElement('div');
            fileNameDisplay.className = 'file-name-display';
            fileNameDisplay.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';

            // –í—Å—Ç–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
            wrapper.appendChild(uploadBtn);
            wrapper.appendChild(fileNameDisplay);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
            fileInput.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    const fileName = this.files[0].name;
                    fileNameDisplay.textContent = fileName;
                    fileNameDisplay.classList.add('has-file');
                    uploadBtn.classList.add('has-file');
                    uploadBtn.innerHTML = '<span class="file-upload-icon">‚úÖ</span> <span>–§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ</span>';

                    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–°–≤–æ—ë —Ñ–æ—Ç–æ" –∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –ø–ª–∞—Ç–Ω–∞—è –æ—Ç–∫—Ä—ã—Ç–∫–∞
                    const customPostcardInput = document.querySelector('input[name="postcard"][value="custom"]:checked');
                    if (customPostcardInput && lastSelectedPostcardId && lastSelectedPostcardPrice > 0) {
                        document.getElementById('postcard_id_for_custom').value = lastSelectedPostcardId;
                        document.getElementById('selected_postcard_for_custom').value = lastSelectedPostcardId;
                        console.log('DEBUG: –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∫–∞:', lastSelectedPostcardId);
                    }
                } else {
                    fileNameDisplay.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                    fileNameDisplay.classList.remove('has-file');
                    uploadBtn.classList.remove('has-file');
                    uploadBtn.innerHTML = '<span class="file-upload-icon">üì∑</span> <span>–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</span>';
                }
            });
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
    document.querySelectorAll('input[name="delivery_option"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'pickup') {
                deliveryFields.style.display = 'none';
                deliveryRow.style.display = 'none';
                currentDeliveryCost = 0;
            } else {
                deliveryFields.style.display = 'block';
                deliveryRow.style.display = 'flex';
                currentDeliveryCost = deliveryCostBase;
            }
            checkAsapAvailability();
            if(dateInput.value && exactPicker.style.display !== 'none') {
                loadSlots(dateInput.value);
            }
            recalcTotal();
        });
    });

    // –õ–æ–≥–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
    function toggleTimeMode() {
        const mode = document.querySelector('input[name="time_mode"]:checked').value;
        if (mode === 'exact') {
            exactPicker.style.display = 'block';

            // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
            if (dateInput && dateInput.value) {
                loadSlots(dateInput.value);
            }
        } else {
            exactPicker.style.display = 'none';
        }
    }

    function checkAsapAvailability() {
        const typeInput = document.querySelector('input[name="delivery_option"]:checked');
        const type = typeInput ? typeInput.value : 'delivery';

        fetch(`{% url 'orders:api_check_asap' %}?type=${type}`)
            .then(r => r.json())
            .then(data => {
                const asapInput = asapOption.querySelector('input');

                if (data.is_open) {
                    asapOption.classList.remove('disabled');
                    asapInput.disabled = false;
                    asapSubtitle.innerText = "–ù–µ –±—ã—Å—Ç—Ä–µ–µ ~{{ site_settings.processing_time|default:60 }} –º–∏–Ω";
                } else {
                    asapOption.classList.add('disabled');
                    asapInput.disabled = true;
                    asapSubtitle.innerText = data.reason;

                    const exactRadio = document.querySelector('input[name="time_mode"][value="exact"]');
                    if (exactRadio) {
                        exactRadio.checked = true;
                        toggleTimeMode();
                    }
                }
            })
            .catch(err => console.error("Error checking ASAP:", err));
    }

    function loadSlots(dateStr) {
        const typeInput = document.querySelector('input[name="delivery_option"]:checked');
        const type = typeInput ? typeInput.value : 'delivery';

        timeSelect.innerHTML = '<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
        timeSelect.disabled = true;
        noSlotsMsg.style.display = 'none';

        fetch(`{% url 'orders:api_get_slots' %}?date=${dateStr}&type=${type}`)
            .then(r => r.json())
            .then(data => {
                timeSelect.innerHTML = '';

                if (data.slots && data.slots.length > 0) {
                    data.slots.forEach(slot => {
                        const opt = document.createElement('option');
                        opt.value = slot.value;
                        opt.innerText = slot.label;
                        timeSelect.appendChild(opt);
                    });
                    timeSelect.disabled = false;
                } else {
                    noSlotsMsg.style.display = 'block';
                    timeSelect.innerHTML = '<option value="">–ù–µ—Ç –≤—Ä–µ–º–µ–Ω–∏</option>';
                    timeSelect.disabled = true;
                }
            })
            .catch(err => {
                console.error("Error loading slots:", err);
                timeSelect.innerHTML = '<option>–û—à–∏–±–∫–∞</option>';
            });
    }

    // –ü–æ–ª—É—á–∞—Ç–µ–ª—å
    function toggleRecipient(radio) {
        recipientFields.style.display = (radio.value === 'other') ? 'block' : 'none';
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –æ—Ç–∫—Ä—ã—Ç–∫–∏ (–û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê)
    function handlePostcardChange(input) {
        const price = parseInt(input.getAttribute('data-price')) || 0;
        const value = input.value;

        console.log('DEBUG handlePostcardChange: value=', value, 'price=', price);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –æ—Ç–∫—Ä—ã—Ç–∫—É –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
        if (value && value !== 'custom' && value !== '') {
            lastSelectedPostcardId = value;
            lastSelectedPostcardPrice = price;
            console.log('DEBUG: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∫–∞ ID:', lastSelectedPostcardId, '—Ü–µ–Ω–∞:', lastSelectedPostcardPrice);
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        if (value === "") {
            postcardExtras.style.display = 'none';
            textInput.value = '';
            document.getElementById('postcard_id_for_custom').value = '';
            document.getElementById('selected_postcard_for_custom').value = '';
            currentPostcardPrice = 0;
        } else {
            postcardExtras.style.display = 'block';

            if (value === "custom") {
                customUpload.style.display = 'block';

                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–ª—è "–°–≤–æ–µ —Ñ–æ—Ç–æ" –≤—Å–µ–≥–¥–∞ –±–µ—Ä–µ–º —Ü–µ–Ω—É –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–∞–π—Ç–∞
                let customPrice = {{ site_settings.custom_postcard_price|default:100|stringformat:".0f" }};
                currentPostcardPrice = customPrice;

                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø–ª–∞—Ç–Ω–∞—è –æ—Å–Ω–æ–≤–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë —Ü–µ–Ω—É
                if (lastSelectedPostcardId && lastSelectedPostcardPrice > 0) {
                    currentPostcardPrice += lastSelectedPostcardPrice;
                    document.getElementById('postcard_id_for_custom').value = lastSelectedPostcardId;
                    document.getElementById('selected_postcard_for_custom').value = lastSelectedPostcardId;
                    console.log('DEBUG: –ö–∞—Å—Ç–æ–º–Ω–∞—è + –æ—Å–Ω–æ–≤–∞:', currentPostcardPrice);
                } else {
                    document.getElementById('postcard_id_for_custom').value = '';
                    document.getElementById('selected_postcard_for_custom').value = '';
                    console.log('DEBUG: –ö–∞—Å—Ç–æ–º–Ω–∞—è –±–µ–∑ –æ—Å–Ω–æ–≤—ã:', currentPostcardPrice);
                }
            } else {
                customUpload.style.display = 'none';
                currentPostcardPrice = price;
                document.getElementById('postcard_id_for_custom').value = '';
                document.getElementById('selected_postcard_for_custom').value = '';
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã –æ—Ç–∫—Ä—ã—Ç–∫–∏
        updatePostcardDisplay();
        recalcTotal();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–µ–Ω—ã –æ—Ç–∫—Ä—ã—Ç–∫–∏
    function updatePostcardDisplay() {
        if (currentPostcardPrice > 0) {
            postcardRow.style.display = 'flex';
            postcardPriceDisplay.innerText = '+' + currentPostcardPrice + ' ‚ÇΩ';
        } else {
            postcardRow.style.display = 'none';
        }
    }

    // –ü–µ—Ä–µ—Å—á–µ—Ç –∏—Ç–æ–≥–∞
    function recalcTotal() {
        const total = cartTotal + currentDeliveryCost + currentPostcardPrice;
        if(finalTotalDisplay) finalTotalDisplay.innerText = total + ' ‚ÇΩ';
        if(deliveryPriceDisplay) deliveryPriceDisplay.innerText = currentDeliveryCost + ' ‚ÇΩ';
    }

    // Swiper –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –í–û–ó–í–†–ê–©–ï–ù–ê
    function initSwiper() {
        const container = document.querySelector('.postcard-swiper');
        if (!container) return;

        const isMobile = window.innerWidth <= 540;
        const isTablet = window.innerWidth > 540 && window.innerWidth <= 1024;
        const isDesktop = window.innerWidth > 1024;

        let slideWidth, spaceBetween, slidesOffsetBefore, slidesOffsetAfter;

        if (isMobile) {
            // –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø - –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
            slideWidth = 85;
            spaceBetween = -25;
            slidesOffsetBefore = 30;
            slidesOffsetAfter = 200;
        } else if (isTablet) {
            // –ü–õ–ê–ù–®–ï–¢–ù–ê–Ø –í–ï–†–°–ò–Ø - –ò–°–ü–†–ê–í–õ–ï–ù–ê: –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–∏–¥–Ω—ã
            slideWidth = 110;
            spaceBetween = -40;
            slidesOffsetBefore = 45;
            slidesOffsetAfter = 200;
        } else {
            // –î–ï–°–ö–¢–û–ü–ù–ê–Ø –í–ï–†–°–ò–Ø - –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –° –®–õ–ï–ô–§–û–ú
            slideWidth = 140;
            spaceBetween = -50;
            slidesOffsetBefore = 50;
            slidesOffsetAfter = container.parentElement.clientWidth - slideWidth - slidesOffsetBefore;
        }

        if (swiper) swiper.destroy(true, true);

        swiper = new Swiper('.postcard-swiper', {
            slidesPerView: 'auto',
            watchOverflow: false,
            centeredSlides: false,
            spaceBetween: spaceBetween,
            speed: 600,
            resistanceRatio: 0.7,
            freeMode: false,
            watchSlidesProgress: true,

            slidesOffsetBefore: slidesOffsetBefore,
            slidesOffsetAfter: slidesOffsetAfter,

            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev'
            },
            on: {
                init: function () {
                    const allInputs = document.querySelectorAll('.postcard-slide-content input');
                    const firstInput = allInputs[0];
                    if (firstInput && !document.querySelector('input[name="postcard"]:checked')) {
                        firstInput.checked = true;
                        handlePostcardChange(firstInput);
                        this.slideTo(0, 0);
                    }
                    updateCardStyles(this, true);
                    updateNavigationButtons();
                },
                slideChangeTransitionStart: function () {
                    isAnimating = true;
                    updateCardStyles(this, false);
                },
                slideChangeTransitionEnd: function () {
                    isAnimating = false;
                    updateCardStyles(this, true);
                    const activeSlide = this.slides[this.activeIndex];
                    const input = activeSlide.querySelector('input[type="radio"]');
                    if(input && !input.checked) {
                        input.checked = true;
                        handlePostcardChange(input);
                    }
                    updateNavigationButtons();
                },
                transitionStart: function () {
                    isAnimating = true;
                    updateCardStyles(this, false);
                },
                transitionEnd: function () {
                    isAnimating = false;
                    updateCardStyles(this, true);
                    updateNavigationButtons();
                },
                touchMove: function () {
                    if (!isAnimating) updateCardStyles(this, false);
                },
                progress: function () {
                    if (!isAnimating) updateCardStyles(this, false);
                },
                reachEnd: function() {
                    updateNavigationButtons();
                },
                reachBeginning: function() {
                    updateNavigationButtons();
                },
                slideChange: function() {
                    updateNavigationButtons();
                }
            }
        });

        document.querySelectorAll('.swiper-slide').forEach((slide, index) => {
            slide.addEventListener('click', function() {
                swiper.slideTo(index, 600);
                const input = slide.querySelector('input');
                if (input) {
                    input.checked = true;
                    handlePostcardChange(input);
                }
            });
        });

        updateNavigationButtons();
    }

    function updateNavigationButtons() {
        if (!swiper) return;
        const prev = document.querySelector('.swiper-button-prev');
        const next = document.querySelector('.swiper-button-next');
        if (prev) {
            prev.style.opacity = swiper.isBeginning ? '0.3' : '1';
            prev.style.pointerEvents = swiper.isBeginning ? 'none' : 'auto';
        }
        if (next) {
            next.style.opacity = swiper.isEnd ? '0.3' : '1';
            next.style.pointerEvents = swiper.isEnd ? 'none' : 'auto';
        }
    }

    // –û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–¢–ò–õ–ï–ô –ö–ê–†–¢–û–ß–ï–ö –í–û–ó–í–†–ê–©–ï–ù–ê
    function updateCardStyles(swiperInstance, isFinalState = false) {
        const slides = swiperInstance.slides;
        const activeIndex = swiperInstance.activeIndex;
        const isMobile = window.innerWidth <= 540;
        const isTablet = window.innerWidth > 540 && window.innerWidth <= 1024;
        const isDesktop = window.innerWidth > 1024;

        let overlapAmount, scaleStep, opacityStep;

        if (isMobile) {
            overlapAmount = 35;
            scaleStep = 0.06;
            opacityStep = 0.15;
        } else if (isTablet) {
            // –ü–õ–ê–ù–®–ï–¢–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò - –í–°–ï –ö–ê–†–¢–û–ß–ö–ò –í–ò–î–ù–´
            overlapAmount = 40;
            scaleStep = 0.07;
            opacityStep = 0.13;
        } else {
            // –î–ï–°–ö–¢–û–ü–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò - –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –° –®–õ–ï–ô–§–û–ú –°–ü–†–ê–í–ê
            overlapAmount = 55;
            scaleStep = 0.08;
            opacityStep = 0.12;
        }

        slides.forEach((slide, index) => {
            const diff = index - activeIndex;

            if (diff < 0) {
                if (diff === -1) {
                    const translateX = overlapAmount;
                    slide.style.transform = `translateX(${translateX}px) scale(${1 - scaleStep})`;
                    slide.style.zIndex = '40';
                    slide.style.opacity = (1 - opacityStep).toString();
                    slide.style.filter = 'brightness(0.95)';
                } else {
                    slide.style.transform = `translateX(${overlapAmount}px) scale(0.8)`;
                    slide.style.opacity = '0';
                    slide.style.zIndex = '10';
                }
            } else if (diff === 0) {
                slide.style.transform = `translateX(0) scale(1)`;
                slide.style.zIndex = '100';
                slide.style.opacity = '1';
                slide.style.filter = 'none';
            } else if (diff === 1) {
                // –ü–ï–†–í–ê–Ø –ö–ê–†–¢–û–ß–ö–ê –°–ü–†–ê–í–ê
                const translateX = -overlapAmount;
                const scale = 1 - scaleStep;
                slide.style.transform = `translateX(${translateX}px) scale(${scale})`;
                slide.style.zIndex = '89';
                slide.style.filter = 'brightness(0.95)';
                slide.style.opacity = (1 - opacityStep).toString();
            } else if (diff === 2) {
                // –í–¢–û–†–ê–Ø –ö–ê–†–¢–û–ß–ö–ê –°–ü–†–ê–í–ê
                const translateX = -overlapAmount * 1.8;
                const scale = 1 - (scaleStep * 2);
                slide.style.transform = `translateX(${translateX}px) scale(${scale})`;
                slide.style.zIndex = '88';
                slide.style.filter = 'brightness(0.9)';
                slide.style.opacity = (1 - (opacityStep * 2)).toString();
            } else {
                // –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –ö–ê–†–¢–û–ß–ö–ò –°–ü–†–ê–í–ê - –í–ò–î–ò–ú–´–ô –®–õ–ï–ô–§
                const translateX = -overlapAmount * (1.8 + (diff - 2) * 0.8);
                const scale = Math.max(0.6, 1 - (scaleStep * diff));
                slide.style.transform = `translateX(${translateX}px) scale(${scale})`;
                slide.style.zIndex = Math.max(10, 87 - diff);
                slide.style.filter = `brightness(${Math.max(0.6, 1 - (opacityStep * diff))})`;
                slide.style.opacity = Math.max(0.1, 1 - (opacityStep * diff)).toString();
            }
        });
        updateNavigationButtons();
    }
</script>

{% endblock %}